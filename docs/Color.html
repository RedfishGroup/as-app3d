<!DOCTYPE html>

<html>
<head>
  <title>Color.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="AgentSet.html">
                  AgentSet.js
                </a>
              
                
                <a class="source" href="Color.html">
                  Color.js
                </a>
              
                
                <a class="source" href="ColorMap.html">
                  ColorMap.js
                </a>
              
                
                <a class="source" href="DataSet.html">
                  DataSet.js
                </a>
              
                
                <a class="source" href="OofA.html">
                  OofA.js
                </a>
              
                
                <a class="source" href="util.html">
                  util.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>Color.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> util <span class="hljs-keyword">from</span> <span class="hljs-string">'./util.js'</span>

<span class="hljs-keyword">const</span> Color = {</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h3 id="css-color-strings-">CSS Color Strings.</h3>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>CSS colors in HTML are strings, see <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/color_value">Mozillas Color Reference</a>,
taking one of 7 forms:</p>
<ul>
<li>Names: <a href="http://en.wikipedia.org/wiki/Web_colors#HTML_color_names">140 color case-insensitive names</a> like
Red, Green, CadetBlue, etc.</li>
<li>Hex, short and long form: #0f0, #ff10a0</li>
<li>RGB: rgb(255, 0, 0), rgba(255, 0, 0, 0.5)</li>
<li>HSL: hsl(120, 100%, 50%), hsla(120, 100%, 50%, 0.8)</li>
</ul>
<p>See [this wikipedia article]
(<a href="http://en.wikipedia.org/wiki/HSL_and_HSV#Swatches">http://en.wikipedia.org/wiki/HSL_and_HSV#Swatches</a>)
on differences between HSL and HSB/HSV.</p>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Convert 4 r,g,b,a ints in [0-255] to a css color string.
Alpha “a” is int in [0-255], not float in 0-1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  rgbaString (r, g, b, a = <span class="hljs-number">255</span>) {
    a = a / <span class="hljs-number">255</span>; <span class="hljs-keyword">let</span> a4 = a.toPrecision(<span class="hljs-number">4</span>)
    <span class="hljs-keyword">return</span> (a === <span class="hljs-number">1</span>) ? <span class="hljs-string">`rgb(<span class="hljs-subst">${r}</span>,<span class="hljs-subst">${g}</span>,<span class="hljs-subst">${b}</span>)`</span> : <span class="hljs-string">`rgba(<span class="hljs-subst">${r}</span>,<span class="hljs-subst">${g}</span>,<span class="hljs-subst">${b}</span>,<span class="hljs-subst">${a4}</span>)`</span>
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Convert 3 ints, h in [0-360], s,l in [0-100]% to a css color string.
Alpha “a” is int in [0-255].</p>
<p>Note h=0 and h=360 are the same, use h in 0-359 for unique colors.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  hslString (h, s, l, a = <span class="hljs-number">255</span>) {
    a = a / <span class="hljs-number">255</span>; <span class="hljs-keyword">let</span> a4 = a.toPrecision(<span class="hljs-number">4</span>)
    <span class="hljs-keyword">return</span> (a === <span class="hljs-number">1</span>) ? <span class="hljs-string">`hsl(<span class="hljs-subst">${h}</span>,<span class="hljs-subst">${s}</span>%,<span class="hljs-subst">${l}</span>%)`</span> : <span class="hljs-string">`hsla(<span class="hljs-subst">${h}</span>,<span class="hljs-subst">${s}</span>%,<span class="hljs-subst">${l}</span>%,<span class="hljs-subst">${a4}</span>)`</span>
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Return a web/html/css hex color string for an r,g,b opaque color (a=255)</p>
<p>Both #nnn and #nnnnnn forms supported.
Default is to check for the short hex form: #nnn.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  hexString (r, g, b, shortOK = <span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">if</span> (shortOK) {
      <span class="hljs-keyword">const</span> [r0, g0, b0] = [r / <span class="hljs-number">17</span>, g / <span class="hljs-number">17</span>, b / <span class="hljs-number">17</span>]
      <span class="hljs-keyword">if</span> (util.isInteger(r0) &amp;&amp; util.isInteger(g0) &amp;&amp; util.isInteger(b0))
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.hexShortString(r0, g0, b0)
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">`#<span class="hljs-subst">${(0x1000000 | (b | g &lt;&lt; 8 | r &lt;&lt; 16)).toString(16).slice(-6)}</span>`</span>
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Return the 4 char short version of a hex color.  Each of the r,g,b values
must be in [0-15].  The resulting color will be equivalent
to <code>r*17</code>, <code>g*17</code>, <code>b*17</code>, resulting in the values:</p>
<pre><code><span class="hljs-number">0</span>, <span class="hljs-number">17</span>, <span class="hljs-number">34</span>, <span class="hljs-number">51</span>, <span class="hljs-number">68</span>, <span class="hljs-number">85</span>, <span class="hljs-number">102</span>, <span class="hljs-number">119</span>, <span class="hljs-number">136</span>, <span class="hljs-number">153</span>, <span class="hljs-number">170</span>, <span class="hljs-number">187</span>, <span class="hljs-number">204</span>, <span class="hljs-number">221</span>, <span class="hljs-number">238</span>, <span class="hljs-number">255</span>
</code></pre><p>This is equivalent util.aRamp(0,255,16), i.e. 16 values per rgb channel.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  hexShortString (r, g, b) {
    <span class="hljs-keyword">if</span> ((r &gt; <span class="hljs-number">15</span>) || (g &gt; <span class="hljs-number">15</span>) || (b &gt; <span class="hljs-number">15</span>)) {
      util.error(<span class="hljs-string">`hexShortString: one of <span class="hljs-subst">${[r, g, b]}</span> &gt; 15`</span>)
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">`#<span class="hljs-subst">${r.toString(16)}</span><span class="hljs-subst">${g.toString(16)}</span><span class="hljs-subst">${b.toString(16)}</span>`</span>
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>This is a hybrid string and generally our default.  It returns:</p>
<ul>
<li>rgbaString if a not 255 (i.e. not opaque)</li>
<li>hexString otherwise</li>
<li>with the hexShortString if appropriate</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  triString (r, g, b, a = <span class="hljs-number">255</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>if (a === 255) { return this.hexString(r, g, b, true) } else { return this.rgbaString(r, g, b, a) }</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> (a === <span class="hljs-number">255</span>) ? <span class="hljs-comment">// eslint-disable-line</span>
      <span class="hljs-keyword">this</span>.hexString(r, g, b, <span class="hljs-literal">true</span>) : <span class="hljs-keyword">this</span>.rgbaString(r, g, b, a)
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h3 id="css-string-conversions">CSS String Conversions</h3>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Return 4 element array given any legal CSS string color.</p>
<p>Legal strings vary widely: CadetBlue, #0f0, rgb(255,0,0), hsl(120,100%,50%)</p>
<p>Note: The browser speaks for itself: we simply set a 1x1 canvas fillStyle
to the string and create a pixel, returning the r,g,b,a TypedArray.</p>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>The shared 1x1 canvas 2D context.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  sharedCtx1x1: util.createCtx(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>), <span class="hljs-comment">// share across calls.</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Convert any css string to TypedArray.
If you need a JavaScript Array, use util.convertArray(array, Array)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  stringToUint8s (string) {
    <span class="hljs-keyword">this</span>.sharedCtx1x1.fillStyle = string
    <span class="hljs-keyword">this</span>.sharedCtx1x1.fillRect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.sharedCtx1x1.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>).data
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h3 id="pixel-colors-">Pixel Colors.</h3>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Primitive Rgba &lt;-&gt; Pixel manipulation.</p>
<p>These use two views onto a 4 byte TypedArray buffer.</p>
<p>These shared values are initialized at end of Color,
see why at <a href="http://goo.gl/qrHXwB">Stack Overflow</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  sharedPixel: <span class="hljs-literal">null</span>,
  sharedUint8s: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Convert r,g,b,a to a single Uint32 pixel, correct endian format.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  rgbaToPixel (r, g, b, a = <span class="hljs-number">255</span>) {
    <span class="hljs-keyword">this</span>.sharedUint8s.set([r, g, b, a])
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.sharedPixel[<span class="hljs-number">0</span>]
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Convert a pixel to Uint8s via the shared typed views.
sharedOK = true returns the sharedUint8s, useful
for one-time computations like finding the pixel r,g,b,a values.
Default is to clone the sharedUint8s.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  pixelToUint8s (pixel, sharedOK = <span class="hljs-literal">false</span>) {
    <span class="hljs-keyword">this</span>.sharedPixel[<span class="hljs-number">0</span>] = pixel
    <span class="hljs-keyword">return</span> sharedOK ? <span class="hljs-comment">// eslint-disable-line</span>
      <span class="hljs-keyword">this</span>.sharedUint8s : <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8ClampedArray</span>(<span class="hljs-keyword">this</span>.sharedUint8s)
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h3 id="typed-color">Typed Color</h3>
<p>A typedColor is a 4 element Uint8ClampedArray, with two properties:</p>
<ul>
<li>pixelArray: A single element Uint32Array view on the Uint8ClampedArray</li>
<li>string: an optional, lazy evaluated, css color string.</li>
</ul>
<p>To create the color from a css string, especially hsl data, use:
tc = Color.typedColor(Color.stringToUint8s(‘hsl(250, 50%, 50%)’))
or
tc = Color.typedColor(Color.stringToUint8s(‘PaleTurquoise’))</p>
<p>This provides a universal color, good for pixels, webgl &amp; image
TypedArrays, and html/css/canvas2d strings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  typedColor (r, g, b, a = <span class="hljs-number">255</span>) {
    <span class="hljs-keyword">const</span> ua = r.buffer ? r : <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8ClampedArray</span>([r, g, b, a])
    ua.pixelArray = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint32Array</span>(ua.buffer, ua.byteOffset, <span class="hljs-number">1</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Make this an instance of TypedColorProto</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    util.setPrototypeOf(ua, TypedColorProto)</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>ua.<strong>proto</strong> = TypedColorProto</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> ua
  }

}</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>initialize sharedPixel and sharedUint8s</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Color.sharedPixel = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint32Array</span>(<span class="hljs-number">1</span>)
Color.sharedUint8s = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8ClampedArray</span>(Color.sharedPixel.buffer)

<span class="hljs-keyword">const</span> TypedColorProto = {</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Set TypedColorProto prototype to Uint8ClampedArray’s prototype</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  __proto__: <span class="hljs-built_in">Uint8ClampedArray</span>.prototype,</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Set the TypedArray; no need for getColor, it <em>is</em> the typed Uint8 array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setColor (r, g, b, a = <span class="hljs-number">255</span>) {
    <span class="hljs-keyword">this</span>.checkColorChange()
    <span class="hljs-keyword">this</span>[<span class="hljs-number">0</span>] = r; <span class="hljs-keyword">this</span>[<span class="hljs-number">1</span>] = g; <span class="hljs-keyword">this</span>[<span class="hljs-number">2</span>] = b; <span class="hljs-keyword">this</span>[<span class="hljs-number">3</span>] = a
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Set the pixel view, changing the shared array (Uint8) view too</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setPixel (pixel) {
    <span class="hljs-keyword">this</span>.checkColorChange()
    <span class="hljs-keyword">this</span>.pixelArray[<span class="hljs-number">0</span>] = pixel
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Get the pixel value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getPixel () { <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.pixelArray[<span class="hljs-number">0</span>] },</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Set pixel/rgba values to equivalent of the css string.</p>
<p>Does <em>not</em> set the chached @string, which will be lazily evaluated
to its triString. This lets the typedColor remain small without the
color string until required by its getter.</p>
<p>Note if you set string to “red” or “rgb(255,0,0)”, the resulting
css string will return the triString #f00 value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setString (string) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.setColor(...Color.stringToUint8s(string))
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Return the triString for this typedColor, cached in the @string value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getString () {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.string == <span class="hljs-literal">null</span>) <span class="hljs-keyword">this</span>.string = Color.triString(...this)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.string
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Return true if color is same value as myself, comparing pixels</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  equals (color) { <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getPixel() === color.getPixel() },</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Housekeeping when a color is modified.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  checkColorChange () {</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Check for immutable colormap color.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.colormap) util.error(<span class="hljs-string">'typedColor: cannot modify ColorMap color.'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Reset string on color change.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.string = <span class="hljs-literal">null</span> <span class="hljs-comment">// will be lazy evaluated via getString.</span>
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> Color</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
