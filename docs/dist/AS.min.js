!function(a,b,c,d,e){"use strict";b='default' in b?b['default']:b;d='default' in d?d['default']:d;e='default' in e?e['default']:e;let f={typeOf:a=>({}).toString.call(a).match(/\s(\w+)/)[1].toLowerCase(),isOneOf:(a,b)=>b.includes(f.typeOf(a)),isUintArray:a=>/^uint.*array$/.test(f.typeOf(a)),isIntArray:a=>/^int.*array$/.test(f.typeOf(a)),isFloatArray:a=>/^float.*array$/.test(f.typeOf(a)),isImage:a=>f.typeOf(a)==='image',isImageable:a=>f.isOneOf(a,['image','htmlimageelement','htmlcanvaselement']),isTypedArray:a=>f.typeOf(a.buffer)==='arraybuffer',isInteger:Number.isInteger||(a=>Math.floor(a)===a),isString:a=>typeof a==='string',isLittleEndian(){let a=new Uint32Array([16909060]);return(new Uint8ClampedArray(a.buffer))[0]===4},identity:a=>a,noop:()=>{},propFcn:a=>b=>b[a],convertArray(a,b){let c=a.constructor;if(c===b)return a;return b.from(a)},arrayToBuffer(a,b = Float64Array){a.constructor===Array&&(a=new b(a));return new Uint8Array(a.buffer)},bufferToArray(a,b,c = Float64Array){b===Array&&(b=c);return b===Array?Array.from(new c(a.buffer)):new b(a.buffer)},bufferToBase64(a){let b=Array.prototype.map.call(a,a=>String.fromCharCode(a)).join('');return btoa(b)},base64ToBuffer(a){let b=atob(a),c=new Uint8Array(b.length);Array.prototype.forEach.call(b,(a,b)=>{c[b]=a.charCodeAt(0)});return c},timeit(a,b = 1e5,c = 'test'){console.time(c);for(let c=0;c<b;c++)a(c);console.timeEnd(c)},pps(a,b = ''){b&&console.log(b);let c=1,d='';while(a){if(typeof a==='function')d=a.constructor.toString();else{let b=Object.keys(a);d=b.length>0?`[${b.join(', ')}]`:`[${a.constructor.name}]`}console.log(`[${c++}]: ${d}`);a=Object.getPrototypeOf(a)}},addToDom(a,b){b&&(b=document.createElement(b),a=b.textContent=a);document.body.appendChild(a)},arraysToString:a=>a.map(a=>`[${a}]`).join(','),fixedStrings(a,b = 4){a=this.convertArray(a,Array);return a.map(a=>a.toFixed(b))},toWindow(a){Object.assign(window,a);console.log('toWindow:',Object.keys(a).join(', '))},parseQueryString(){let a={},b=document.location.search.substring(1);b.split('&').forEach(b=>{let c=b.split('=');a[c[0]]=c.length===1?!0:c[1]});return a},setScript(a,b = {}){let c=document.createElement('script');c.src=a;Object.assign(c,b);document.querySelector('head').appendChild(c)},getEventXY(a,b){let c=a.getBoundingClientRect();return[b.clientX-c.left,b.clientY-c.top]},setTextParams(a,b,c = 'center',d = 'middle'){a.font=b;a.textAlign=c;a.textBaseline=d},randomInt:a=>Math.floor(Math.random()*a),randomInt2:(a,b)=>a+Math.floor(Math.random()*(b-a)),randomFloat:a=>Math.random()*a,randomFloat2:(a,b)=>a+Math.random()*(b-a),randomCentered:a=>f.randomFloat2(-a/2,a/2),randomNormal(a = 0,b = 1){let[c,d]=[1-Math.random(),Math.random()],e=Math.sqrt(-2*Math.log(c))*Math.cos(2*Math.PI*d);return e*b+a},isPowerOf2:a=>(a&a-1)===0,nextPowerOf2:a=>Math.pow(2,Math.ceil(Math.log2(a))),fixed(a,b = 4){let c=Math.pow(10,b);return Math.round(a*c)/c},mod:(a,b)=>(a%b+b)%b,wrap:(a,b,c)=>b+f.mod(a-b,c-b),clamp(a,b,c){if(a<b)return b;if(a>c)return c;return a},between:(a,b,c)=>b<=a&&a<=c,lerp:(a,b,c)=>a<=b?a+(b-a)*c:a-(a-b)*c,lerpScale:(a,b,c)=>(a-b)/(c-b),radians:a=>a*Math.PI/180,degrees:a=>a*180/Math.PI,heading(a){let b=this.degrees(a);return this.mod((90-b),360)},angle(a){let b=this.mod(360-a,360);return this.radians(b)},subtractRadians(a,b){let c=this.mod(a-b,2*Math.PI);c>Math.PI&&(c-=2*Math.PI);return c},subtractHeadings(a,b){let c=this.mod(a-b,360);c>180&&(c-=360);return c},radiansToward:(a,b,c,d)=>Math.atan2(d-b,c-a),headingToward(a,b,c,d){return this.heading(this.radiansToward(a,b,c,d))},distance:(a,b,c,d)=>Math.sqrt(f.sqDistance(a,b,c,d)),sqDistance:(a,b,c,d)=>(a-c)*(a-c)+(b-d)*(b-d),inCone(a,b,c,d,e,f,g){if(this.sqDistance(f,g,a,b)>c*c)return!1;let h=this.radiansToward(f,g,a,b);return d/2>=Math.abs(this.subtractRadians(e,h))},repeat(a,b,c = []){for(let d=0;d<a;d++)b(d,c);return c},step(a,b,c){for(let d=0;d<a;d+=b)c(d)},range(a){return this.repeat(a,(a,b)=>{b[a]=a})},keyForValue(a,b){for(let c in a)if(a[c]===b)return c;return null},forEach(a,b){if(a.slice)for(let c=0,d=a.length;c<d;c++)b(a[c],c,a);else Object.keys(a).forEach(c=>b(a[c],c,a));return a},copyArray(a){return a.slice(0)},concatArrays(a,b){let c=a.constructor;if(c===Array)return a.concat(this.convertArray(b,Array));let d=new c(a.length+b.length);d.set(a);d.set(b,a.length);return d},flatten(a){if(!Array.isArray(a[0]))return a;let b=[];a.forEach(a=>b.push(...a));return this.flatten(b)},arrayType(a){return a.constructor},fixedArray(a,b = 4){a=this.convertArray(a,Array);return a.map(a=>this.fixed(a,b))},clone(a){if(a.slice)return a.slice(0);let b={};Object.keys(a).forEach(c=>{b[c]=a[c]});return b},deepClone:a=>JSON.parse(JSON.stringify(a)),objectsEqual:(a,b)=>JSON.stringify(a)===JSON.stringify(b),objectToString:a=>JSON.stringify(a),randomArray(a,b = 0,c = 1,d = Array){let e=new d(a);for(let d=0;d<a;d++)e[d]=this.randomFloat2(b,c);return e},histogram(a,b = 1,c = Math.floor(this.arrayMin(a))){let d=[],[e,f]=[Number.MAX_VALUE,Number.MIN_VALUE],[g,h]=[Number.MAX_VALUE,Number.MIN_VALUE];for(let i of a){let a=Math.floor(i/b)-c;d[a]=d[a]===void 0?1:d[a]+1;e=Math.min(e,a);f=Math.max(f,a);g=Math.min(g,i);h=Math.max(h,i)}for(let a in d)d[a]===void 0&&(d[a]=0);let i=f-e+1;return{bins:i,minBin:e,maxBin:f,minVal:g,maxVal:h,hist:d}},arrayMax:a=>a.reduce((a,b)=>Math.max(a,b)),arrayMin:a=>a.reduce((a,b)=>Math.min(a,b)),arraySum:a=>a.reduce((a,b)=>a+b),arrayAvg:a=>f.arraySum(a)/a.length,oneOf:a=>a[f.randomInt(a.length)],otherOneOf(a,b){do{var c=this.oneOf(a)}while(b===c);return c},arrayProps:(a,b)=>a.map(a=>a[b]),oneKeyOf:a=>f.oneOf(Object.keys(a)),oneValOf:a=>a[f.oneKeyOf(a)],sortNums(a,b = !0){return a.sort((a,c)=>b?a-c:c-a)},sortObjs(a,b,c = !0){typeof b==='string'&&(b=this.propFcn(b));let d=(a,c)=>b(a)-b(c);return a.sort((a,b)=>c?d(a,b):-d(a,b))},shuffle(a){for(let b=a.length-1;b>0;b--){let c=Math.floor(Math.random()*(b+1)),d=a[b];a[b]=a[c];a[c]=d}return a},uniq(a,b = this.identity){this.isString(b)&&(b=this.propFcn(b));return a.filter((a,c,d)=>c===0||b(a)!==b(d[c-1]))},sortedIndex(a,b,c = this.identity){this.isString(c)&&(c=this.propFcn(c));let d=c(b),[e,f]=[0,a.length];while(e<f){let b=e+f>>>1;c(a[b])<d?(e=b+1):(f=b)}return e},indexOf(a,b,c){if(!c)return a.indexOf(b);let d=this.sortedIndex(a,b,c);return a[d]===b?d:-1},contains(a,b,c){return this.indexOf(a,b,c)>=0},removeItem(a,b,c){let d=this.indexOf(a,b,c);d!==-1&&a.splice(d,1)},insertItem(a,b,c){let d=this.sortedIndex(a,b,c);a[d]===b&&this.error('insertItem: item already in array');a.splice(d,0,b)},aPairwise:(a,b,c)=>a.map((a,d)=>c(a,b[d])),arraysAdd:(a,b)=>f.aPairwise(a,b,(a,b)=>a+b),arraysSub:(a,b)=>f.aPairwise(a,b,(a,b)=>a-b),arraysMul:(a,b)=>f.aPairwise(a,b,(a,b)=>a*b),arraysEqual:(a,b)=>f.arraysSub(a,b).every(a=>a===0),aRamp(a,b,c){c<=1&&this.error('aRamp: numItems must be > 1');let d=[];for(let e=0;e<c;e++)d.push(a+(b-a)*(e/(c-1)));return d},aIntRamp(a,b,c = Math.abs(b-a)+1){return this.aRamp(a,b,c).map(a=>Math.round(a))},normalize(a,b = 0,c = 1){let[d,e]=[this.arrayMin(a),this.arrayMax(a)],f=1/(e-d);return a.map(a=>this.lerp(b,c,f*(a-d)))},normalize8(a){return new Uint8ClampedArray(this.normalize(a,-.5,255.5))},normalizeInt(a,b,c){return this.normalize(a,b,c).map(a=>Math.round(a))},imagePromise(a){return new Promise((b,c)=>{let d=new Image;d.crossOrigin='Anonymous';d.onload=()=>b(d);d.onerror=()=>c(Error(`Could not load image ${a}`));d.src=a})},xhrPromise(a,b = 'text',c = 'GET'){return new Promise((d,e)=>{let f=new XMLHttpRequest;f.open(c,a);f.responseType=b;f.onload=()=>d(f.response);f.onerror=()=>e(Error(`Could not load ${a}: ${f.status}`));f.send()})},timeoutPromise(a = 1e3){return new Promise((b,c)=>{setTimeout(()=>b(),a)})},scriptPromise(a,b,c = ()=>window[b],d = {}){window[b]==null&&this.setScript(a,d);return this.waitPromise(()=>window[b]!=null,c)},waitPromise(a,b = this.noop,c = 10){return new Promise((d,e)=>{this.waitOn(a,()=>d(b()),c)})},waitOn(a,b,c = 10){a()?b():setTimeout(()=>{this.waitOn(a,b,c)},c)},runGenerator(a,b = a=>{}){a=this.typeOf(a)==='generator'?a:a();
    !function c(d){let e=a.next(d);e.done?b(e.value):(e.value.then?e.value.then(c):setTimeout(()=>c(e.value),0))}()},runGeneratorPromise(a){return new Promise((b,c)=>{this.runGenerator(a,b)})},runAsyncFcn(a,b){let c=a();this.typeOf(c)==='generator'?this.runGenerator(c,b):this.typeOf(c)==='promise'?c.then(b):b()},getCanvasByID:a=>document.getElementById(a),createCanvas(a,b){let c=document.createElement('canvas');Object.assign(c,{width:a,height:b});return c},createCtx(a,b,c = '2d',d = {}){let e=this.createCanvas(a,b);return this.getContext(e,c,d)},getContext(a,b = '2d',c = {}){typeof a==='string'&&(a=this.getCanvasByID(a));b[0]!=='2'&&(b='webgl');let d=a.getContext(b,c);d||this.error('getContext error');return d},cloneCtx(a){let b=this.createCtx(a.canvas.width,a.canvas.height);b.drawImage(a.canvas,0,0);return b},resizeCtx(a,b,c){let d=this.cloneCtx(a);a.canvas.width=b;a.canvas.height=c;a.drawImage(d.canvas,0,0)},ctxImageData(a){return a.getImageData(0,0,a.canvas.width,a.canvas.height)},fillCtxWithImage(a,b){this.setIdentity(a);a.drawImage(b,0,0,a.canvas.width,a.canvas.height);a.restore()},ctxToDataUrl:a=>a.canvas.toDataURL('image/png'),dataUrlToImage(a){let b=new Image;b.src=a;return b},dataUrlToCtx(a){let b=this.dataUrlToImage(a),c=this.createCtx(b.width,b.height);c.drawImage(b,0,0);return c},setCtxSmoothing(a,b){let c=['imageSmoothingEnabled','mozImageSmoothingEnabled','oImageSmoothingEnabled','webkitImageSmoothingEnabled','msImageSmoothingEnabled'];for(let d of c)if(a[d])return a[d]=b},setIdentity(a){a.save();a.setTransform(1,0,0,1,0,0)},setWorldTransform(a,b){a.canvas.width=b.width;a.canvas.height=b.height;a.save();a.scale(b.patchSize,-b.patchSize);a.translate(-b.minXcor,-b.maxYcor)},ctxDrawText(a,b,c,d,e){this.setIdentity(a);a.fillStyle=e;a.fillText(b,c,d);a.restore()},imageToCtx(a,b = 0,c = 0,d = a.width,e = a.height){(b+d>a.width||c+e>a.height)&&this.error('imageToCtx: parameters outside of image');let f=this.createCtx(d,e);f.drawImage(a,b,c,d,e,0,0,d,e);return f},imageToBytesCtx:null,imageToBytes(a,b = !1,c = 'RGBA'){this.imageToBytesCtx||(this.imageToBytesCtx=this.createCtx(0,0,'webgl',{premultipliedAlpha:!1}));let{width:d,height:e}=a,f=this.imageToBytesCtx;Object.assign(f.canvas,{width:d,height:e});let g=f[c],h=f.createTexture();f.bindTexture(f.TEXTURE_2D,h);b&&f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,!0);f.pixelStorei(f.UNPACK_COLORSPACE_CONVERSION_WEBGL,f.NONE);f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);f.texImage2D(f.TEXTURE_2D,0,g,g,f.UNSIGNED_BYTE,a);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.NEAREST);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST);let i=f.createFramebuffer();f.bindFramebuffer(f.FRAMEBUFFER,i);f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,h,0);let j=f.checkFramebufferStatus(f.FRAMEBUFFER);j!==f.FRAMEBUFFER_COMPLETE&&this.error(`imageToBytes: status not FRAMEBUFFER_COMPLETE: ${j}`);let k=c==='RGB'?3:4,l=new Uint8Array(k*d*e);f.readPixels(0,0,d,e,g,f.UNSIGNED_BYTE,l);f.bindFramebuffer(f.FRAMEBUFFER,null);return l}};class g extends Array{constructor(a,b,c,d = null){a==null&&(a=0);typeof a==='number'?super(a):(super(0),d=d||this,Object.assign(this,{model:a,name:c,baseSet:d,world:a.world}),this.isBaseSet()?(this.breeds={},this.ID=0):(this.baseSet.breeds[c]=this),this.ownVariables=[],this.agentProto=new b(this),this.protoMixin())}protoMixin(){let a=this.agentProto;Object.assign(a,{agentSet:this,model:this.model,world:this.world});a[this.baseSet.name]=this.baseSet;let b=Object.getPrototypeOf(a);b.setBreed||(Object.assign(b,{setBreed(a){a.setBreed(this)},getBreed(){return this.agentSet},isBreed(a){return this.agentSet===a}}),Object.defineProperty(b,'breed',{get:function(){return this.agentSet}}))}isBreedSet(){return this.baseSet!==this}isBaseSet(){return this.baseSet===this}add(a){a=a||Object.create(this.agentProto);this.isBreedSet()?this.baseSet.add(a):(a.id=this.ID++);this.push(a);return a}clear(){while(this.any())this.last().die()}remove(a){this.isBreedSet()&&f.removeItem(this.baseSet,a,'id');f.removeItem(this,a,'id');return this}setDefault(a,b){this.agentProto[a]=b}getDefault(a){this.agentProto[a]}own(a){for(let b of a.split(' '))this.setDefault(b,null),this.ownVariables.push(b)}setBreed(a){if(a.agentSet===this)return;a.agentSet.isBreedSet()&&f.removeItem(a.agentSet,a,'id');this.isBreedSet()&&f.insertItem(this,a,'id');let b=a.agentSet.ownVariables;for(let c of b)this.ownVariables.includes(c)||delete a[c];for(let c of this.ownVariables)b.includes(c)||(a[c]=0);return Object.setPrototypeOf(a,this.agentProto)}empty(){return this.length===0}any(){return this.length!==0}last(){return this[this.length-1]}all(a){return this.every(a)}toArray(){Object.setPrototypeOf(this,Array.prototype);return this}props(a){return this.map(b=>b[a]).toArray()}with(a){return this.filter(a)}ask(a){for(let b=0;b<this.length;b++)a(this[b],b);return this}count(a){return this.reduce((b,c)=>b+a(c)?1:0,0)}clone(a = 0,b = this.length){return this.slice(a,b)}shuffle(){return f.shuffle(this)}sortBy(a,b = !0){f.sortObjs(this,a,b);return this}oneOf(){return f.oneOf(this)}otherOneOf(a){return f.otherOneOf(this,a)}minOrMaxOf(a,b){if(this.empty())throw Error('min/max OneOf: empty array');typeof b==='string'&&(b=f.propFcn(b));let c=null,d=a?1/0:-1/0;for(let e=0;e<this.length;e++){let f=this[e],g=b(f);(a&&g<d||!a&&g>d)&&([c,d]=[f,g])}return c}minOneOf(a){return this.minOrMaxOf(!0,a)}maxOneOf(a){return this.minOrMaxOf(!1,a)}nOf(a){if(a>this.length)throw Error('nOf: n larger than agentset');if(a===this.length)return this;let b=new g;while(b.length<a){let a=this.oneOf();(a in b)||b.push(a)}return b}minOrMaxNOf(a,b,c){if(b>this.length)throw Error('min/max nOf: n larger than agentset');let d=this.clone().sortBy(c);return a?d.clone(0,b):d.clone(d.length-b)}minNOf(a,b){return this.minOrMaxNOf(!0,a,b)}maxNOf(a,b){return this.minOrMaxNOf(!1,a,b)}inRect(a,b,c = b,d = !1){let e=new g,f=a.x-b,h=a.x+b,i=a.y-c,j=a.y+c;this.ask(b=>{f<=b.x&&b.x<=h&&i<=b.y&&b.y<=j&&((d||a!==b)&&e.push(b))});return e}inRadius(a,b,c = !1){let d=new g,e=b*b,h=f.sqDistance;this.ask(b=>{h(a.x,a.y,b.x,b.y)<=e&&((c||a!==b)&&d.push(b))});return d}inCone(a,b,c,d,e,h,i = !1){let j=new g;this.ask(e=>{f.inCone(e.x,e.y,b,c,d,a.x,a.y)&&((i||a!==e)&&j.push(e))});return j}}class h{constructor(a,b = 60,c = !1){Object.assign(this,{model:a,rate:b,multiStep:c});this.reset()}setRate(a,b = !1){Object.assign(this,{rate:a,multiStep:b});this.resetTimes()}start(){if(!this.stopped)return;this.resetTimes();this.stopped=!1;this.animate()}stop(){this.stopped=!0;this.animHandle&&cancelAnimationFrame(this.animHandle);this.timeoutHandle&&clearTimeout(this.timeoutHandle);this.animHandle=this.timeoutHandle=null}resetTimes(){this.startMS=this.now();this.startTick=this.ticks;this.startDraw=this.draws}reset(){this.stop();this.ticks=this.draws=0}step(){this.ticks++;this.model.step()}draw(){this.draws++;this.model.draw()}once(){this.step();this.draw()}now(){return performance.now()}ms(){return this.now()-this.startMS}ticksPerSec(){let a=this.ticks-this.startTick;return a===0?0:Math.round(a*1e3/this.ms())}drawsPerSec(){let a=this.draws-this.startDraw;return a===0?0:Math.round(a*1e3/this.ms())}toString(){return`ticks: ${this.ticks}, draws: ${this.draws}, rate: ${this.rate} tps/dps: ${this.ticksPerSec()}/${this.drawsPerSec()}`}animateSteps(){this.step();this.stopped||(this.timeoutHandle=setTimeout(()=>this.animateSteps(),10))}animateDraws(){this.drawsPerSec()<this.rate&&(this.multiStep||this.step(),this.draw());this.stopped||(this.animHandle=requestAnimationFrame(()=>this.animateDraws()))}animate(){this.multiStep&&this.animateSteps();this.animateDraws()}}class i{static emptyDataSet(a,b,c){return new i(a,b,new c(a*b))}constructor(a,b,c){if(c.length!==a*b)throw Error(`new DataSet length: ${c.length} !== ${a} * ${b}`);else Object.assign(this,{width:a,height:b,data:c})}setName(a){this.name=a;return this}getName(){return this.name?this.name:this.makeName()}makeName(){let{width:a,height:b}=this,c=f.arraySum(this.data).toFixed(2);return`${this.dataType().name}-${a}-${b}-${c}`}checkXY(a,b){if(!this.inBounds(a,b))throw Error(`DataSet.checkXY: x,y out of range: ${a}, ${b}`)}inBounds(a,b){return f.between(a,0,this.width-1)&&f.between(b,0,this.height-1)}dataType(){return this.data.constructor}type(){return this.constructor}toIndex(a,b){return a+b*this.width}toXY(a){return[a%this.width,Math.floor(a/this.width)]}getXY(a,b){return this.data[this.toIndex(a,b)]}setxy(a,b,c){this.data[this.toIndex(a,b)]=c}sample(a,b,c = !0){this.checkXY(a,b);return c?this.nearest(a,b):this.bilinear(a,b)}nearest(a,b){return this.getXY(Math.round(a),Math.round(b))}bilinear(a,b){let c=Math.floor(a),d=Math.floor(b),e=this.toIndex(c,d),f=this.width,g=a-c,h=b-d,i=1-g,j=1-h,k=this.data[e],l=this.data[e+1]||0,m=this.data[e+f]||0,n=this.data[e+1+f]||0;return k*i*j+l*g*j+m*i*h+n*g*h}copy(){return new i(this.width,this.height,f.copyArray(this.data))}emptyDataSet(a,b,c = this.dataType()){return i.emptyDataSet(a,b,c)}emptyArray(a){let b=this.type();return new b(a)}resample(a,b,c = !0,d = Array){if(a===this.width&&b===this.height)return this.copy();let e=i.emptyDataSet(a,b,d),f=(this.width-1)/(a-1),g=(this.height-1)/(b-1);for(let d=0;d<b;d++)for(let b=0;b<a;b++)e.setxy(b,d,this.sample(b*f,d*g,c));return e}subset(a,b,c,d){if(a+c>this.width||b+d>this.height)throw Error('DataSet.subSet: params out of range');let e=this.emptyDataSet(c,d);for(let f=0;f<c;f++)for(let c=0;c<d;c++)e.setxy(f,c,this.getXY(f+a,c+b));return e}map(a){return new i(this.width,this.height,this.data.map(a))}col(a){let[b,c,d]=[this.width,this.height,this.data];if(a>=b)throw Error(`col: x out of range width: ${b} x: ${a}`);let e=this.emptyArray(c);for(let f=0;f<c;f++)e[f]=d[a+f*b];return e}row(a){let[b,c]=[this.width,this.height];if(a>=c)throw Error(`row: y out of range height: ${c} x: ${a}`);return this.data.slice(a*b,(a+1)*b)}convertType(a){this.data=f.convertArray(this.data,a)}concatEast(a){let[b,c]=[this.width,this.height],[d,e]=[a.width,a.height];if(c!==e)throw Error(`concatEast: heights not equal ${c}, ${e}`);let f=this.emptyDataSet((b+d),c);for(let a=0;a<c;a++)for(let c=0;c<b;c++)f.setxy(a,c,this.getXY(a,c));for(let c=0;c<e;c++)for(let e=0;e<d;e++)f.setxy(c+b,e,a.getXY(c,e));return f}concatSouth(a){let[b,c,d]=[this.width,this.height,this.data];if(b!==a.width)throw Error(`concatSouth: widths not equal ${b}, ${a.width}`);let e=f.concatArrays(d,a.data);return new i(b,c+a.height,e)}transformCoords(a,b,c,d,e,f){let g=(a-c)*(this.width-1)/e,h=(d-b)*(this.height-1)/f;return[g,h]}coordSample(a,b,c,d,e,f,g = !0){let[h,i]=this.transformCoords(a,b,c,d,e,f);return this.sample(h,i,g)}neighborhood(a,b,c = []){c.length=0;let d=a===0||a===this.width-1||b===0||b===this.height-1;for(let e=-1;e<=1;e++){for(let g=-1;g<=1;g++){let h=a+g,i=b+e;d&&(h=f.clamp(h,0,this.width-1),i=f.clamp(i,0,this.height-1));c.push(this.data[this.toIndex(h,i)])}}return c}convolve(a,b = 1,c = !1){let[d,e,f,g]=c?[1,1,this.height-1,this.width-1]:[0,0,this.height,this.width],h=this.emptyDataSet(g,f),i=h.data,j=0;for(let c=e;c<f;c++){for(let e=d;e<g;e++){let d=this.neighborhood(e,c),f=0;for(let b=0;b<a.length;b++)f+=a[b]*d[b];i[j++]=f*b}}return h}dzdx(a = 2,b = .125){return this.convolve([-1,0,1,-a,0,a,-1,0,1],b)}dzdy(a = 2,b = .125){return this.convolve([1,a,1,0,0,0,-1,-a,-1],b)}laplace8(){return this.convolve([-1,-1,-1,-1,8,-1,-1,-1,-1])}laplace4(){return this.convolve([0,-1,0,-1,4,-1,0,-1,0])}blur(a = .0625){return this.convolve([1,2,1,2,4,2,1,2,1],a)}edge(){return this.convolve([1,1,1,1,-7,1,1,1,1])}slopeAndAspect(a = 1,b = !0,c = !0){let d=this.dzdx(),e=this.dzdy(),[g,h]=[[],[]],[j,k]=[d.height,d.width];for(let i=0;i<j;i++){for(let j=0;j<k;j++){let[k,l]=[d.getXY(j,i),e.getXY(j,i)];h.push(Math.atan(f.distance(k,l))/a);if(b)while(k===l)k+=f.randomNormal(0,1e-4),l+=f.randomNormal(0,1e-4);let m=k===l&&l===0?NaN:Math.atan2(-l,-k);c&&m<0&&(m+=2*Math.PI);g.push(m)}}h=new i(k,j,h);g=new i(k,j,g);return{slope:h,aspect:g,dzdx:d,dzdy:e}}toContext(a = !1,b = !1,c = 255){let[d,e,g]=[this.width,this.height,this.data],h;a?(h=b?f.normalize8(g):f.normalizeInt(g,0,Math.pow(2,24)-1)):(h=g.map(a=>Math.round(a)));let i=f.createCtx(d,e),j=i.getImageData(0,0,d,e),k=j.data;for(let a=0;a<h.length;a++){let[d,e]=[h[a],4*a];b?(k[e]=k[e+1]=k[e+2]=Math.floor(d),k[e+3]=c):(k[e]=d>>16&255,k[e+1]=d>>8&255,k[e+2]=d&255,k[e+3]=c)}i.putImageData(j,0,0);return i}toCanvas(a = !1,b = !1,c = 255){return this.toContext(b,a,c).canvas}toDataUrl(a = !1,b = !1,c = 255){return f.ctxToDataUrl(this.toContext(b,a,c))}max(){return this.data.reduce(function(a,b){return Math.max(a,b)})}min(){return this.data.reduce(function(a,b){return Math.min(a,b)})}equals(a){return this.width===a.width&&this.height===a.height&&f.arraysEqual(this.data,a.data)}}class j extends i{constructor(a,b = Array,c = {}){let d=a.split('\n'),e={};f.repeat(6,a=>{let b=d[a].split(/\s+/);e[b[0].toLowerCase()]=parseFloat(b[1])});let g=[];f.repeat(e.nrows,a=>{let b=d[6+a].trim().split(' ');for(let a of b)g.push(parseFloat(a))});super(e.ncols,e.nrows,f.convertArray(g,b));this.header=e;Object.assign(this,c)}}let k={rgbaString(a,b,c,d = 255){d/=255;let e=d.toPrecision(4);return d===1?`rgb(${a},${b},${c})`:`rgba(${a},${b},${c},${e})`},hslString(a,b,c,d = 255){d/=255;let e=d.toPrecision(4);return d===1?`hsl(${a},${b}%,${c}%)`:`hsla(${a},${b}%,${c}%,${e})`},hexString(a,b,c,d = !0){if(d){let[d,e,g]=[a/17,b/17,c/17];if(f.isInteger(d)&&f.isInteger(e)&&f.isInteger(g))return this.hexShortString(d,e,g)}return`#${(16777216|(c|b<<8|a<<16)).toString(16).slice(-6)}`},hexShortString(a,b,c){if(a>15||b>15||c>15){throw Error(`hexShortString: one of ${[a,b,c]} > 15`)}return`#${a.toString(16)}${b.toString(16)}${c.toString(16)}`},triString(a,b,c,d = 255){return d===255?this.hexString(a,b,c,!0):this.rgbaString(a,b,c,d)},sharedCtx1x1:f.createCtx(1,1),stringToUint8s(a){this.sharedCtx1x1.clearRect(0,0,1,1);this.sharedCtx1x1.fillStyle=a;this.sharedCtx1x1.fillRect(0,0,1,1);return this.sharedCtx1x1.getImageData(0,0,1,1).data},newColor(a,b,c,d = 255){let e=new Uint8ClampedArray([a,b,c,d]);e.pixelArray=new Uint32Array(e.buffer);Object.setPrototypeOf(e,l);return e},isColor(a){return a.constructor===Uint8ClampedArray&&a.pixelArray},toColor(a){if(this.isColor(a))return a;let b=this.newColor(0,0,0,0);if(f.isInteger(a))b.setPixel(a);else if(typeof a==='string')b.setCss(a);else if(Array.isArray(a)||f.isUintArray(a))b.setColor(...a);else if(f.isFloatArray(a))b.setWebgl(a);else throw Error('toColor: invalid argument',a);return b},randomTypedColor(){let a=()=>f.randomInt(256);return this.newColor(a(),a(),a())},transparent:null},l={__proto__:Uint8ClampedArray.prototype,setColor(a,b,c,d = 255){this.checkColorChange();this[0]=a;this[1]=b;this[2]=c;this[3]=d},set rgb(a){this.setColor(...a)},get rgb(){return this},setPixel(a){this.checkColorChange();this.pixelArray[0]=a},getPixel(){return this.pixelArray[0]},get pixel(){return this.getPixel()},set pixel(a){this.setPixel(a)},setCss(a){return this.setColor(...k.stringToUint8s(a))},getCss(){this.string==null&&(this.string=k.triString(...this));return this.string},get css(){return this.getCss()},set css(a){this.setCss(a)},setWebgl(a){this.setColor(a[0]*255,a[1]*255,a[2]*255,a.length===4?a[3]*255:void 0)},getWebgl(){if(this.floatArray==null){let a=[this[0]/255,this[1]/255,this[2]/255];this[3]!==255&&a.push(this[3]/255);this.floatArray=new Float32Array(a)}return this.floatArray},get webgl(){return this.getWebgl()},set webgl(a){this.setWebgl(a)},checkColorChange(){this.string=null;this.floatArray=null},equals(a){return this.getPixel()===a.getPixel()},rgbDistance(a,b,c){let[d,e,f]=this,g=Math.round((d+a)/2),[h,i,j]=[d-a,e-b,f-c],[k,l,m]=[h*h,i*i,j*j],n=((512+g)*k>>8)+4*l+((767-g)*m>>8);return n}};k.transparent=k.newColor(0,0,0,0);let m={gradientImageData(a,b,c){b=b.map(a=>Array.isArray(a)?k.rgbaString(...a):a);let d=f.createCtx(a,1);c||(c=f.aRamp(0,1,b.length));let e=d.createLinearGradient(0,0,a,0);f.repeat(b.length,a=>e.addColorStop(c[a],b[a]));d.fillStyle=e;d.fillRect(0,0,a,1);return f.ctxImageData(d).data},typedArraytoColors(a){let b=[];f.step(a.length,4,c=>b.push(k.newColor(...a.subarray(c,c+4))));b.typedArray=a;return b},arraysToColors(a){let b=new Uint8ClampedArray(a.length*4);f.repeat(a.length,c=>{let d=a[c];d.length===3&&d.push(255);b.set(d,c*4)});return this.typedArraytoColors(b)},permuteArrays(a,b = a,c = a){let d=[];for(let e of c)for(let c of b)for(let b of a)d.push([b,c,e]);return d},permuteRGBColors(a,b = a,c = a){let d=a=>f.aIntRamp(0,255,a),e=[a,b,c].map(d);return this.permuteArrays(...e)},ColorMapProto:{__proto__:Array.prototype,createIndex(){this.index=[];f.repeat(this.length,a=>{let b=this[a].getPixel();this.index[b]=a;this.cssNames&&(this.index[this.cssNames[a]]=a)})},randomIndex(){return f.randomInt(this.length)},randomColor(){return this[this.randomIndex()]},indexOf(a){if(this.index)return this.index[a.getPixel()];for(let b=0;b<this.length;b++)if(a.equals(this[b]))return b;return void 0},scaleColor(a,b,c){a=f.clamp(a,b,c);let d=f.lerpScale(a,b,c),e=Math.round(f.lerp(0,this.length-1,d));return this[e]},webglArray(){return this.typedArray},toString(){return`${this.length} ${f.arraysToString(this)}`},rgbClosestIndex(a,b,c){let d=1/0,e=0;for(var f=0;f<this.length;f++){let g=this[f].rgbDistance(a,b,c);if(g<d){d=g;e=f;if(g===0)return e}}return e},rgbClosestColor(a,b,c){return this[this.rgbClosestIndex(a,b,c)]},cubeClosestIndex(a,b,c){let d=this.cube,e=d.map(a=>255/(a-1)),f=[a,b,c].map((a,b)=>Math.round(a/e[b])),[g,h,i]=f;return g+h*d[0]+i*d[0]*d[1]},cubeClosestColor(a,b,c){return this[this.cubeClosestIndex(a,b,c)]},closestIndex(a,b,c){return this.cube?this.cubeClosestIndex(a,b,c):this.rgbClosestIndex(a,b,c)},closestColor(a,b,c){return this[this.closestIndex(a,b,c)]}},basicColorMap(a){a=this.arraysToColors(a);Object.setPrototypeOf(a,this.ColorMapProto);return a},grayColorMap(a = 0,b = 255,c = b-a+1){let d=f.aIntRamp(a,b,c);return this.basicColorMap(d.map(a=>[a,a,a]))},rgbColorCube(a,b = a,c = a){let d=this.permuteRGBColors(a,b,c),e=this.basicColorMap(d);e.cube=[a,b,c];return e},rgbColorMap(a,b,c){let d=this.permuteArrays(a,b,c);return this.basicColorMap(d)},hslColorMap(a,b = [100],c = [50]){let d=this.permuteArrays(a,b,c),e=d.map(a=>k.toColor(k.hslString(...a)));return this.basicColorMap(e)},gradientColorMap(a,b,c){let d=this.gradientImageData(a,b,c),e=this.typedArraytoColors(d);Object.setPrototypeOf(e,this.ColorMapProto);return e},jetColors:[[0,0,127],[0,0,255],[0,127,255],[0,255,255],[127,255,127],[255,255,0],[255,127,0],[255,0,0],[127,0,0]],basicColorNames:'white silver gray black red maroon yellow olive lime green cyan teal blue navy magenta purple'.split(' '),cssColorMap(a){let b=a.map(a=>k.stringToUint8s(a)),c=this.basicColorMap(b);c.cssNames=a;return c},LazyMap(a,b){Object.defineProperty(this,a,{value:b,enumerable:!0});return b},get Gray(){return this.LazyMap('Gray',this.grayColorMap())},get LightGray(){return this.LazyMap('LightGray',this.grayColorMap(200))},get DarkGray(){return this.LazyMap('DarkGray',this.grayColorMap(0,100))},get Jet(){return this.LazyMap('Jet',this.gradientColorMap(256,this.jetColors))},get Rgb256(){return this.LazyMap('Rgb256',this.rgbColorCube(8,8,4))},get Rgb(){return this.LazyMap('Rgb',this.rgbColorCube(16))},get Basic16(){return this.LazyMap('Basic16',this.cssColorMap(this.basicColorNames))}};function n(a,b,c){return{width:a.width,height:a.height,data:o(a.data,b),dataType:a.dataType().name,meta:c}}function o(a,b){if(b){let b=f.arrayToBuffer(a);return f.bufferToBase64(b)}return JSON.stringify(f.convertArray(a,Array))}function p(a,b){let c=window[b];if(q(a)){let b=f.base64ToBuffer(a);return f.bufferToArray(b,c)}return f.convertArray(JSON.parse(a),c)}function q(a){return a[0]!=='['}let r={dataSetToJson(a,b = !0,c = {}){let d=n(a,b,c);return JSON.stringify(d)},jsonToDataSet(a){let b=JSON.parse(a),c=p(b.data,b.dataType);return new i(b.width,b.height,c)},toIndexedDB(a){return a}},s=new Uint8Array(4),t=new Uint32Array(s.buffer),u=new Int32Array(s.buffer),v={maxUint24:16777215,minUint24:0,maxInt24:8388607,minInt24:-8388608,checkInt24(a){if(a<this.minInt24||a>this.maxInt24)throw Error(`Int24: Range error ${a}`)},checkUint24(a){if(a<this.minUint24||a>this.maxUint24)throw Error(`Uint24: Range error ${a}`)},rgbToInt24(a,b,c){s[0]=a;s[1]=b;s[2]=c;s[3]=c>127?255:0;return u[0]},rgbToUint24(a,b,c){s[0]=a;s[1]=b;s[2]=c;s[3]=0;return t[0]},int24ToRGB(a){this.checkInt24(a);u[0]=a;return[s[0],s[1],s[2]]},uint24ToRGB(a){this.checkUint24(a);t[0]=a;return[s[0],s[1],s[2]]}},w={end0:0,end1:0,color:k.toColor('yellow'),width:1};class x{constructor(a){Object.assign(this,w)}init(a,b){this.end0=a;this.end1=b;a.links.push(this);b.links.push(this)}die(){this.agentSet.remove(this);f.removeItem(this.end0.links,this);f.removeItem(this.end1.links,this)}bothEnds(){return[this.end0,this.end1]}length(){return this.end0.distance(this.end1)}otherEnd(a){return a===this.end0?this.end1:this.end0}}class y extends g{constructor(a,b,c,d = null){super(a,b,c,d);if(typeof a==='number'||this.isBreedSet())return}create(a,b,c = a=>{}){Array.isArray(b)||(b=[b]);return b.map(b=>{let d=this.add();d.init(a,b);c(d);return d})}}class z extends g{constructor(a,b,c,d = null){super(a,b,c,d);if(typeof a==='number'||this.isBreedSet())return;this.populate();this.setPixels();this.labels=[]}populate(){f.repeat(this.world.numX*this.world.numY,a=>{this.add(Object.create(this.agentProto))})}setPixels(){let{numX:a,numY:b}=this.world;this.pixels={ctx:f.createCtx(a,b)};this.setImageData()}setImageData(){let a=this.pixels;a.imageData=f.ctxImageData(a.ctx);a.data8=a.imageData.data;a.data=new Uint32Array(a.data8.buffer)}setLabel(a,b){b==null?delete this.labels[a.id]:(this.labels[a.id]=b)}getLabel(a){return this.labels[a.id]}neighborsOffsets(a,b){let{minX:c,maxX:d,minY:e,maxY:f,numX:g}=this.world;if(a===c){if(b===e)return[-g,-g+1,1];if(b===f)return[1,g+1,g];return[-g,-g+1,1,g+1,g]}if(a===d){if(b===e)return[-g-1,-g,-1];if(b===f)return[g,g-1,-1];return[-g-1,-g,g,g-1,-1]}if(b===e)return[-g-1,-g,-g+1,1,-1];if(b===f)return[1,g+1,g,g-1,-1];return[-g-1,-g,-g+1,1,g+1,g,g-1,-1]}neighbors4Offsets(a,b){let c=this.world.numX;return this.neighborsOffsets(a,b).filter(a=>Math.abs(a)===1||Math.abs(a)===c)}neighbors(a){let{id:b,x:c,y:d}=a,e=this.neighborsOffsets(c,d),f=new g(e.length);e.forEach((a,c)=>{f[c]=this[a+b]});return f}neighbors4(a){let{id:b,x:c,y:d}=a,e=this.neighbors4Offsets(c,d),f=new g(e.length);e.forEach((a,c)=>{f[c]=this[a+b]});return f}randomPt(){let{minXcor:a,maxXcor:b,minYcor:c,maxYcor:d}=this.world;return[f.randomFloat2(a,b),f.randomFloat2(c,d)]}randomPatch(){return this.oneOf()}patchRect(a,b,c = b,d = !0){if(a.pRect&&a.pRect.length===b*c)return a.pRect;let e=new g(0),{minX:f,maxX:h,minY:i,maxY:j}=this.world;f=Math.max(f,a.x-b);h=Math.min(h,a.x+b);i=Math.max(i,a.y-c);j=Math.min(j,a.y+c);for(let b=i;b<=j;b++){for(let c=f;c<=h;c++){let f=this.patchXY(c,b);(a!==f||d)&&e.push(f)}}return e}installPixels(){let a=this.pixels;a.ctx.putImageData(a.imageData,0,0);return a}importColors(a){f.imagePromise(a).then(a=>this.installColors(a))}installColors(a){f.fillCtxWithImage(this.pixels.ctx,a);this.setImageData()}importDataSet(a,b,c = !1){this.isBreedSet()&&this.baseSet.importDataSet(a,b,c);let{numX:d,numY:e}=this.world,f=a.resample(d,e,c);this.ask(a=>{a[b]=f.data[a.id]})}exportDataSet(a,b = Array){let{numX:c,numY:d}=this.world,e=f.arrayProps(this,a);e=f.convertArray(e,b);return new i(c,d,e)}patchXYToIndex(a,b){let{minX:c,maxY:d,numX:e}=this.world;return a-c+e*(d-b)}patchIndexToXY(a){let{minX:b,maxY:c,numX:d}=this.world;return[a%d+b,c-Math.floor(a/d)]}pixelXYToPatchXY(a,b){let{patchSize:c,minXcor:d,maxYcor:e}=this.world;return[d+a/c,e-b/c]}patchXYToPixelXY(a,b){let{patchSize:c,minXcor:d,maxYcor:e}=this.world;return[(a-d)*c,(e-b)*c]}patch(a,b){if(!this.world.isOnWorld(a,b))return void 0;let c=a===this.world.maxXcor?this.world.maxX:Math.round(a),d=b===this.world.maxYcor?this.world.maxY:Math.round(b);return this.patchXY(c,d)}patchXY(a,b){return this[this.patchXYToIndex(a,b)]}inRadius(a,b,c = !0){let d=b*b,e=new g(0),h=f.sqDistance,i=this.patchRect(a,b,b,c);for(let b=0;b<i.length;b++){let c=i[b];h(a.x,a.y,c.x,c.y)<=d&&e.push(c)}return e}inCone(a,b,c,d,e = !0){let h=this.patchRect(a,b,b,e),i=new g(0);for(let g=0;g<h.length;g++){let j=h[g],k=f.inCone(j.x,j.y,b,c,d,a.x,a.y);k&&(a!==j||e)&&i.push(j)}return i}patchAtAngleAndDistance(a,b,c){let{x:d,y:e}=a;d+=c*Math.cos(b);e+=c*Math.sin(b);return this.patch(d,e)}patchLeftAndAhead(a,b){return this.patchAtAngleAndDistance(a,b)}patchRightAndAhead(a,b){return this.patchAtAngleAndDistance(-a,b)}diffuse(a,b,c = null,d = 0,e = 1){this.diffuseN(8,a,b,c,d,e)}diffuse4(a,b,c = null,d = 0,e = 1){this.diffuseN(4,a,b,c,d,e)}diffuseN(a,b,c,d = null,e = 0,f = 1){if(this[0]._diffuseNext===void 0)for(let a=0;a<this.length;a++)this[a]._diffuseNext=0;for(let d=0;d<this.length;d++){let e=this[d],f=e[b]*c,g=f/a,h=a===8?e.neighbors:e.neighbors4,i=h.length;e._diffuseNext+=e[b]-f+(a-i)*g;for(let a=0;a<h.length;a++)h[a]._diffuseNext+=g}for(let a=0;a<this.length;a++){let c=this[a];c[b]=c._diffuseNext;c._diffuseNext=0;d&&c.setColor(d.scaleColor(c[b],e,f))}}}let A={turtles:null,labelOffset:[0,0],labelColor:k.newColor(0,0,0)};class B{constructor(a){Object.assign(this,A)}get x(){return this.id%this.world.numX+this.world.minX}get y(){return this.world.maxY-Math.floor(this.id/this.world.numX)}isOnEdge(){let{x:a,y:b,world:c}=this;return a===c.minX||a===c.maxX||b===c.minY||b===c.maxY}get neighbors(){let a=this.patches.neighbors(this);Object.defineProperty(this,'neighbors',{value:a,enumerable:!0});return a}get neighbors4(){let a=this.patches.neighbors4(this);Object.defineProperty(this,'neighbors4',{value:a,enumerable:!0});return a}setColor(a){this.patches.pixels.data[this.id]=a.getPixel()}getColor(a = null){let b=this.patches.pixels.data[this.id];if(a){a.pixel=b;return a}return k.toColor(b)}get color(){return this.getColor()}set color(a){return this.setColor(a)}setLabel(a){this.patches.setLabel(this,a)}getLabel(){this.patches.getLabel(this)}get label(){return this.getLabel()}set label(a){return this.setColor(a)}turtlesHere(){this.turtles==null&&(this.patches.ask(a=>{a.turtles=[]}),this.model.turtles.ask(a=>{a.patch.turtles.push(a)}));return this.turtles}breedsHere(a){let b=this.turtlesHere();return b.filter(b=>b.agentSet===a)}distanceXY(a,b){return f.distance(this.x,this.y,a,b)}distance(a){return this.distanceXY(a.x,a.y)}towards(a){return this.towardsXY(a.x,a.y)}towardsXY(a,b){return f.radiansToward(this.x,this.y,a,b)}patchAt(a,b){return this.patches.patch(this.x+a,this.y+b)}patchAtAngleAndDistance(a,b){return this.patches.patchAtAngleAndDistance(this,a,b)}inRadius(a,b = !0){return this.patches.inRadius(this,a,b)}inCone(a,b,c,d = !0){return this.patches.inRadius(this,a,b,c,d)}sprout(a = 1,b = this.model.turtles,c = f.noop){b.create(a,a=>{a.setxy(this.x,this.y),c(a)})}}class C extends g{constructor(a,b,c,d = null){super(a,b,c,d);if(typeof a==='number'||this.isBreedSet())return}create(a = 1,b = a=>{}){return f.repeat(a,(a,c)=>{let d=this.add();d.theta=f.randomFloat(Math.PI*2);b(d);d.sprite||d.setSprite('default',m.Basic16.randomColor().css);c.push(d)})}inPatches(a){let b=new g(0);for(let c of a)b.push(...c.turtlesHere());this.isBreedSet()&&(b=b.filter(a=>a.agentSet===this));return b}inPatchRect(a,b,c = b,d = !1){let e=this.model.patches.patchRect(a.patch,b,c,!0),g=this.inPatches(e);d||f.removeItem(g,a);return g}inRadius(a,b,c = !1){let d=this.inPatchRect(a,b,b,!0);return d.inRadius(a,b,c)}inCone(a,b,c,d,e,f = !1){let g=this.inPatchRect(a,b,b,!0);return g.inCone(a,b,c,a.theta,d,e,f)}layoutCircle(a,b = [0,0],c = Math.PI/2,d = -1){let e=2*Math.PI/this.length,[f,g]=b;this.ask((b,h)=>{b.setxy(f,g),b.theta=c+d*e*h,b.forward(a)})}}let D={x:0,y:0,z:1,theta:0,size:1,atEdge:'clamp',sprite:null};class E{constructor(a){Object.assign(this,D)}die(){this.agentSet.remove(this);if(this.hasOwnProperty('links'))while(this.links.length>0)this.links[0].die();this.patch.turtles!=null&&f.removeItem(this.patch.turtles,this)}hatch(a = 1,b = this.agentSet,c = ()=>{}){return b.create(a,a=>{a.setxy(this.x,this.y);for(let c of b.ownVariables)a[c]==null&&(a[c]=this[c]);c(a)})}get links(){Object.defineProperty(this,'links',{value:[],enumerable:!0});return this.links}get patch(){return this.model.patches.patch(this.x,this.y)}get patches(){return this.model.patches}get heading(){return f.heading(this.theta)}set heading(a){this.theta=f.angle(a)}setSprite(a,b = 'red',c = 'black'){if(a.sheet){this.sprite=a;return}let d=this.model.renderer.spriteSheet;this.sprite=d.newSprite(a,b,c)}setSize(a){this.size=a*this.world.patchSize}setxy(a,b,c = null){let d=this.patch;c&&(this.z=c);this.world.isOnWorld(a,b)?(this.x=a,this.y=b):this.handleEdge(a,b);let e=this.patch;e.turtles!=null&&e!==d&&(f.removeItem(d.turtles,this),e.turtles.push(this))}handleEdge(a,b){if(f.isString(this.atEdge)){let{minXcor:c,maxXcor:d,minYcor:e,maxYcor:g}=this.world;if(this.atEdge==='wrap')this.x=f.wrap(a,c,d),this.y=f.wrap(b,e,g);else if(this.atEdge==='clamp'||this.atEdge==='bounce')this.x=f.clamp(a,c,d),this.y=f.clamp(b,e,g),this.atEdge==='bounce'&&(this.x===c||this.x===d?(this.theta=Math.PI-this.theta):(this.theta=-this.theta));else{throw Error(`turtle.handleEdge: bad atEdge: ${this.atEdge}`)}}else this.atEdge(this)}moveTo(a){this.setxy(a.x,a.y)}forward(a){this.setxy(this.x+a*Math.cos(this.theta),this.y+a*Math.sin(this.theta))}rotate(a){this.theta=f.mod(this.theta+a,Math.PI*2)}right(a){this.rotate(-a)}left(a){this.rotate(a)}face(a){this.theta=this.towards(a)}faceXY(a,b){this.theta=this.towardsXY(a,b)}patchAhead(a){return this.patchAtAngleAndDistance(this.theta,a)}canMove(a){return this.patchAhead(a)!=null}distanceXY(a,b){return f.distance(this.x,this.y,a,b)}distance(a){return f.distance(this.x,this.y,a.x,a.y)}towards(a){return this.towardsXY(a.x,a.y)}towardsXY(a,b){return f.radiansToward(this.x,this.y,a,b)}patchAt(a,b){return this.patches.patch(this.x+a,this.y+b)}patchAtAngleAndDistance(a,b){return this.patches.patchAtAngleAndDistance(this,a,b)}patchLeftAndAhead(a,b){return this.patchAtAngleAndDistance(a+this.theta,b)}patchRightAndAhead(a,b){return this.patchAtAngleAndDistance(a-this.theta,b)}inRadius(a,b = !1){return this.agentSet.inRadius(this,a,b)}inCone(a,b = !1){return this.agentSet.inCone(this,a,b)}otherEnd(a){return a.end0===this?a.end1:a.end0}linkNeighbors(){return this.links.map(a=>this.otherEnd(a))}}class F{constructor(a = 64,b = 16,c = !0){Object.assign(this,{spriteSize:a,cols:b,usePowerOf2:c});this.rows=1;this.nextCol=0;this.nextRow=0;this.sprites={};this.paths=Object.assign({},G);c&&this.checkPowerOf2();this.ctx=f.createCtx(this.width,this.height);this.texture=null}newSprite(a,b,c){b&&(b=k.toColor(b).css);c&&(c=k.toColor(c).css);let d=this.spriteName(a,b,c);if(this.sprites[d])return this.sprites[d];return f.isImageable(a)?this.addImage(a):this.addDrawing(a,b,c)}installDrawing(a,b = a.name){this.paths[b]=a}spriteShape(a){let b=a.name.match(/(.*)#(.*)/);return b.length===3?{shape:b[1],color:k.toColor(b[2])}:null}get width(){return this.spriteSize*this.cols}get height(){return this.spriteSize*this.rows}get nextX(){return this.spriteSize*this.nextCol}get nextY(){return this.spriteSize*this.nextRow}get id(){return Object.keys(this.sprites).length}spriteName(a,b,c){if(f.isImageable(a)){let b=a.src;b=b.replace(/^.*\//,'');b=b.replace(/\..*/,'img');return b}let d=a.name||a;return`${d}${b}`}addImage(a){let b=this.spriteName(a);this.checkSheetSize();let[c,d,e]=[this.nextX,this.nextY,this.spriteSize];this.ctx.drawImage(a,c,d,e,e);let f=this.id,{nextRow: g,nextCol: h}=this,i={id:f,name:b,x:c,y:d,row:g,col:h,size:e,sheet:this};i.uvs=this.getUVs(i);this.sprites[b]=i;this.incrementRowCol();this.texture&&(this.texture.needsUpdate=!0);return i}addDrawing(a,b,c,d = !0){let e=this.createFcnCanvas(a,b,c,d);return this.addImage(e)}incrementRowCol(){this.nextCol+=1;if(this.nextCol<this.cols)return;this.nextCol=0;this.nextRow+=1}checkSheetSize(){this.nextRow===this.rows&&(this.rows=this.usePowerOf2?this.rows*2:this.rows+1,f.resizeCtx(this.ctx,this.width,this.height),f.forEach(this.sprites,a=>{a.uvs=this.getUVs(a)}))}createFcnCanvas(a,b,c = 'black',d = !0){let e=f.createCtx(this.spriteSize,this.spriteSize);e.fillStyle=b.css||b;e.strokeStyle=c.css||c;d&&(e.scale(this.spriteSize/2,this.spriteSize/2),e.translate(1,1),e.beginPath());f.isString(a)?this.paths[a](e):a(e);d&&(e.closePath(),e.fill());let g=a.name||a;e.canvas.src=`${g}${b}`;return e.canvas}getUVs(a){let{row:b,col:c}=a,{rows:d,cols:e}=this,f=c/e,g=b/d,h=(c+1)/e,i=(b+1)/d;return[f,i,h,i,h,g,f,g]}checkPowerOf2(){let{width:a,height:b}=this;if(!(f.isPowerOf2(a)&&f.isPowerOf2(b)))throw Error(`SpriteSheet non power of 2: ${a}x${b}`)}}let G={poly(a,b){b.forEach((b,c)=>{c===0?a.moveTo(b[0],b[1]):a.lineTo(b[0],b[1])})},default(a){this.dart(a)},arrow(a){this.poly(a,[[1,0],[0,1],[0,.4],[-1,.4],[-1,-.4],[0,-.4],[0,-1]])},bug(a){a.lineWidth=.1;this.poly(a,[[.8,.45],[.4,0],[.8,-.45]]);a.stroke();a.beginPath();a.arc(.24,0,.26,0,2*Math.PI);a.arc(-.1,0,.26,0,2*Math.PI);a.arc(-.54,0,.4,0,2*Math.PI)},circle(a){a.arc(0,0,1,0,2*Math.PI)},dart(a){this.poly(a,[[1,0],[-1,.8],[-.5,0],[-1,-.8]])},frame(a){let b=.4;a.fillRect(-1,-1,2,2);a.fill();a.clearRect(-1+b,-1+b,2-2*b,2-2*b)},frame2(a){let b=.4;a.fillRect(-1,-1,2,2);a.fill();a.fillStyle=a.strokeStyle;a.fillRect(-1+b,-1+b,2-2*b,2-2*b)},person(a){this.poly(a,[[.3,-.4],[.6,0],[.25,.2],[.25,-.1],[.2,.3],[.5,1],[.1,1],[0,.5],[-.1,1],[-.5,1],[-.2,.3],[-.25,-.1],[-.25,.2],[-.6,0],[-.3,-.4]]);a.closePath();a.arc(0,-.7,.3,0,2*Math.PI)},ring(a){let[b,c]=[1,.6];a.arc(0,0,b,0,2*Math.PI,!1);a.lineTo(c,0);a.arc(0,0,c,0,2*Math.PI,!0)},ring2(a){let[b,c]=[1,.6];a.arc(0,0,b,0,2*Math.PI);a.closePath();a.fill();a.beginPath();a.fillStyle=a.strokeStyle;a.arc(0,0,c,0,2*Math.PI)},square(a){a.fillRect(-1,-1,2,2)},triangle(a){this.poly(a,[[1,0],[-1,-.8],[-1,.8]])}};class H{static defaultOptions(a = !0,b = !0){return{Renderer:H,orthoView:!1,clearColor:0,useAxes:a,useGrid:a,useControls:a,useStats:b,useGUI:b}}constructor(a,b = {}){this.model=a;this.spriteSheet=new F;Object.assign(this,H.defaultOptions);Object.assign(this,b);if(this.Renderer!==H)throw Error('Three ctor: Renderer not Three',this.renderer);this.initThree();this.initThreeHelpers();this.unitQuad=this.createQuad(.5,0)}createQuad(a,b = 0){let c=[-a,-a,b,a,-a,b,a,a,b,-a,a,b],d=[0,1,2,0,2,3];return{vertices:c,indices:d}}initThree(){let{clientWidth:a,clientHeight:c}=this.model.div,{orthoView:d,clearColor:e}=this,{width:f,height:g}=this.model.world,[h,i]=[f/2,g/2],j=new b.Scene,k=d?new b.OrthographicCamera(-h,h,i,-i,1,1e3):new b.PerspectiveCamera(45,a/c,1,1e4);d?k.position.set(0,0,100*f):k.position.set(f,-f,f);k.up.set(0,0,1);let l=new b.WebGLRenderer;l.setPixelRatio(window.devicePixelRatio);l.setSize(a,c);l.setClearColor(e);this.model.div.appendChild(l.domElement);window.addEventListener('resize',()=>{let{clientWidth:a,clientHeight:b}=this.model.div;k.aspect=a/b;k.updateProjectionMatrix();l.setSize(a,b)});Object.assign(this,{scene:j,camera:k,renderer:l})}initThreeHelpers(){let{scene:a,renderer:c,camera:f}=this,{useAxes:g,useGrid:h,useControls:i,useStats:j,useGUI:k}=this,{width:l}=this.model.world,m={};g&&(m.axes=new b.AxisHelper(1.5*l/2),a.add(m.axes));h&&(m.grid=new b.GridHelper(1.25*l,10),m.grid.rotation.x=b.Math.degToRad(90),a.add(m.grid));i&&(m.controls=new b.OrbitControls(f,c.domElement));j&&(m.stats=new d,document.body.appendChild(m.stats.dom));k&&(m.gui=new e.GUI);Object.assign(this,m)}disposeThreeMesh(a){a.parent!==this.scene&&console.log('mesh parent not scene');a.parent.remove(a);a.geometry.dispose();a.material.dispose();a.material.map&&a.material.map.dispose()}initCanvasMesh(a,c,d,e = {}){this[c]&&this.disposeThreeMesh(this[c]);let{width:g,height:h,numX:i,numY:j}=this.model.world,k=new b.CanvasTexture(a);(!f.isPowerOf2(a.width)||!f.isPowerOf2(a.height))&&(k.minFilter=b.NearestFilter,k.magFilter=b.NearestFilter);Object.assign(k,e);let l=new b.PlaneGeometry(g,h,i,j),m=new b.MeshBasicMaterial({map:k,shading:b.FlatShading,side:b.DoubleSide,transparent:!0}),n=this[c]=new b.Mesh(l,m);n.position.z=d;this.scene.add(n)}updateCanvasMesh(a){this[a].material.map.needsUpdate=!0}initPatchesMesh(a){this.initCanvasMesh(a,'patchesMesh',0)}updatePatchesMesh(a){a.installPixels();this.patchesMesh.material.map.needsUpdate=!0}initPointsMesh(a,c = .3,d = 0,e = null){this[a]&&this.disposeThreeMesh(this[a]);c*=this.model.world.patchSize;let f=new b.BufferGeometry;f.addAttribute('position',new b.BufferAttribute(new Float32Array,3));e==null&&f.addAttribute('color',new b.BufferAttribute(new Float32Array,3));let g=new b.PointsMaterial({size:c,vertexColors:b.VertexColors});e!=null&&(g.color=e.webgl||e);let h=this[a]=new b.Points(f,g);h.position.z=d;this.scene.add(h)}updatePointsMesh(a,b){let c=this[a],d=c.geometry.getAttribute('position'),e=c.geometry.getAttribute('color'),f=[],g=e==null?null:[],h=this.model.world.patchSize,i=[1,0,0];for(let a=0;a<b.length;a++){let c=b[a];f.push(c.x*h,c.y*h,c.z*h);g!=null&&g.push(...i)}d.setArray(new Float32Array(f));d.needsUpdate=!0;g&&(e.setArray(new Float32Array(g)),e.needsUpdate=!0)}initQuadSpriteMesh(a){this[a]&&this.disposeThreeMesh(this[a]);let c=new b.CanvasTexture(this.spriteSheet.ctx.canvas);this.spriteSheet.texture=c;let d=new Float32Array,e=new Float32Array,f=new Uint32Array,g=new b.BufferGeometry;g.addAttribute('position',new b.BufferAttribute(d,3));g.addAttribute('uv',new b.BufferAttribute(e,2));g.setIndex(new b.BufferAttribute(f,1));let h=new b.MeshBasicMaterial({map:c,alphaTest:.5,side:b.DoubleSide}),i=this[a]=new b.Mesh(g,h);this.scene.add(i)}updateQuadSpriteMesh(a,b){let c=this[a],{vertices:d,indices:e}=this.unitQuad,f=this.model.world.patchSize,g=c.geometry.getAttribute('position'),h=c.geometry.getAttribute('uv'),i=c.geometry.getIndex(),j=new Float32Array(d.length*b.length),k=[],l=[];for(let a=0;a<b.length;a++){let c=b[a],g=c.size,h=c.theta,i=Math.cos(h),m=Math.sin(h),n=a*d.length;for(let a=0;a<d.length;a=a3){let b=d[a],e=d[a+1],h=c.x,k=c.y;j[a+n]=(g*(b*i-e*m)+h)*f;j[a+n+1]=(g*(b*m+e*i)+k)*f;j[a+n+2]=c.z*f}l.push(...e.map(b=>b+a*4));k.push(...c.sprite.uvs)}g.setArray(j);g.needsUpdate=!0;h.setArray(new Float32Array(k));h.needsUpdate=!0;i.setArray(new Uint32Array(l));i.needsUpdate=!0}initLinksMesh(){this.linksMesh&&this.disposeThreeMesh(this.linksMesh);let a=new Float32Array(0),c=new Float32Array(0),d=new b.BufferGeometry;d.addAttribute('position',new b.BufferAttribute(a,3));d.addAttribute('color',new b.BufferAttribute(c,3));let e=new b.LineBasicMaterial({vertexColors:b.VertexColors}),f=this.linksMesh=new b.LineSegments(d,e);this.scene.add(f)}updateLinksMesh(a){let b=[],c=[];for(let d=0;d<a.length;d++){let{end0:e,end1:f,color:g}=a[d],{x: h,y: i,z: j}=e,{x: k,y: l,z: m}=f,n=this.model.world.patchSize;b.push(h*n,i*n,j*n,k*n,l*n,m*n);c.push(...g.webgl,...g.webgl)}let d=this.linksMesh,e=d.geometry.getAttribute('position'),f=d.geometry.getAttribute('color');e.setArray(new Float32Array(b));e.needsUpdate=!0;f.setArray(new Float32Array(c));f.needsUpdate=!0}initTurtlesMesh(){this.turtlesMesh&&this.disposeThreeMesh(this.turtlesMesh);let a=new b.CanvasTexture(this.spriteSheet.ctx.canvas);this.spriteSheet.texture=a;let c=new Float32Array(0),d=new Float32Array(0),e=new Uint32Array(0),f=new b.BufferGeometry;f.addAttribute('position',new b.BufferAttribute(c,3));f.addAttribute('uv',new b.BufferAttribute(d,2));f.setIndex(new b.BufferAttribute(e,1));f.name='turtles';let g=new b.MeshBasicMaterial({map:a,alphaTest:.5,side:b.DoubleSide}),h=this.turtlesMesh=new b.Mesh(f,g);this.scene.add(h)}updateTurtlesMesh(a){let{vertices:b,indices:c}=this.unitQuad,d=this.model.world.patchSize,e=this.turtlesMesh,f=e.geometry.getAttribute('position'),g=e.geometry.getAttribute('uv'),h=e.geometry.getIndex(),i=new Float32Array(b.length*a.length),j=[],k=[];for(let e=0;e<a.length;e++){let f=a[e],g=f.size,h=f.theta,l=Math.cos(h),m=Math.sin(h),n=e*b.length;for(let a=0;a<b.length;a=a3){let c=b[a],e=b[a+1],h=f.x,j=f.y;i[a+n]=(g*(c*l-e*m)+h)*d;i[a+n+1]=(g*(c*m+e*l)+j)*d;i[a+n+2]=f.z*d}k.push(...c.map(a=>a+e*4));j.push(...f.sprite.uvs)}f.setArray(i);f.needsUpdate=!0;g.setArray(new Float32Array(j));g.needsUpdate=!0;h.setArray(new Uint32Array(k));h.needsUpdate=!0}}class I{static defaultOptions(a = 13,b = 16){return{patchSize:a,minX:-b,maxX:b,minY:-b,maxY:b}}constructor(a = document.body,b = {},c = H.defaultOptions()){this.div=f.isString(a)?document.getElementById(a):a;this.world=I.defaultOptions();Object.assign(this.world,b);this.setWorld();this.renderer=new c.Renderer(this,c);this.anim=new h(this);this.modelReady=!1;this.startup().then(()=>{this.reset(),this.modelReady=!0})}whenReady(a){f.waitOn(()=>this.modelReady,()=>a(this))}setWorld(){let a=this.world;a.numX=a.maxX-a.minX+1;a.numY=a.maxY-a.minY+1;a.width=a.numX*a.patchSize;a.height=a.numY*a.patchSize;a.minXcor=a.minX-.5;a.maxXcor=a.maxX+.5;a.minYcor=a.minY-.5;a.maxYcor=a.maxY+.5;a.isOnWorld=(b,c)=>a.minXcor<=b&&b<=a.maxXcor&&a.minYcor<=c&&c<=a.maxYcor}reset(a = !1){this.anim.reset();this.setWorld();this.refreshLinks=this.refreshTurtles=this.refreshPatches=!0;this.patches=new z(this,B,'patches');this.renderer.initPatchesMesh(this.patches.pixels.ctx.canvas);this.turtles=new C(this,E,'turtles');this.renderer.initQuadSpriteMesh('turtlesMesh');this.links=new y(this,x,'links');this.renderer.initLinksMesh();this.setup();a&&this.start()}async startup(){}setup(){}step(){}start(){f.waitOn(()=>this.modelReady,()=>{this.anim.start()});return this}stop(){this.anim.stop()}once(){this.stop();this.anim.once()}draw(a = this.anim.stopped||this.anim.draws===1){let{scene:b,camera:c}=this.renderer;this.div&&((a||this.refreshPatches)&&(this.patches.length>0&&this.renderer.updatePatchesMesh(this.patches)),(a||this.refreshTurtles)&&(this.turtles.length>0&&this.renderer.updateQuadSpriteMesh('turtlesMesh',this.turtles)),(a||this.refreshLinks)&&(this.links.length>0&&this.renderer.updateLinksMesh(this.links)),this.renderer.renderer.render(b,c));this.renderer.stats&&this.renderer.stats.update()}patchBreeds(a){for(let b of a.split(' '))this[b]=new z(this,B,b,this.patches)}turtleBreeds(a){for(let b of a.split(' '))this[b]=new C(this,E,b,this.turtles)}linkBreeds(a){for(let b of a.split(' '))this[b]=new y(this,x,b,this.links)}}class J extends i{constructor(a,b = Float32Array,c = {}){let d=f.imageToBytes(a),e=new b(d.buffer),g=4*e.length/d.length,h=g*a.width,i=a.height;super(h,i,e);Object.assign(this,c);this.src=a.src}}class K extends i{constructor(a,b = {}){super(a.width,a.height,new Float32Array(a.width*a.height));Object.assign(this,b);let c=f.createCtx(a.width,a.height);f.fillCtxWithImage(c,a);let d=f.ctxImageData(c),e=this.data;for(var g=0;g<e.length;g++){let a=d.data[4*g],b=d.data[4*g+1],c=d.data[4*g+2];e[g]=this.rgb2Number(a,b,c)}this.src=a.src;this.ctx=c}rgb2Number(a,b,c){var d=1;a>63&&(d=-1,a=0);var e=d*(a*256*256+b*256+c);e/=10;return e}}a.AgentSet=g;a.Animator=h;a.AscDataSet=j;a.Color=k;a.ColorMap=m;a.DataSet=i;a.DataSetIO=r;a.Int24=v;a.Link=x;a.Links=y;a.Model=I;a.Patch=B;a.Patches=z;a.RGBADataSet=J;a.RGBDataSet=K;a.SpriteSheet=F;a.Turtle=E;a.Turtles=C;a.util=f}(this.AS=this.AS||{},THREE,OrbitControls,Stats,dat)
