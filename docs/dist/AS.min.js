!function(t,e,n,r,o){"use strict";e='default' in e?e['default']:e;r='default' in r?r['default']:r;o='default' in o?o['default']:o;let i={typeOf:t=>({}).toString.call(t).match(/\s(\w+)/)[1].toLowerCase(),isOneOf:(t,e)=>e.includes(i.typeOf(t)),isUintArray:t=>/^uint.*array$/.test(i.typeOf(t)),isIntArray:t=>/^int.*array$/.test(i.typeOf(t)),isFloatArray:t=>/^float.*array$/.test(i.typeOf(t)),isImage:t=>i.typeOf(t)==='image',isImageable:t=>i.isOneOf(t,['image','htmlimageelement','htmlcanvaselement']),isTypedArray:t=>i.typeOf(t.buffer)==='arraybuffer',isInteger:Number.isInteger||(t=>Math.floor(t)===t),isString:t=>typeof t==='string',isLittleEndian(){let t=new Uint32Array([16909060]);return(new Uint8ClampedArray(t.buffer))[0]===4},identity:t=>t,noop:()=>{},propFcn:t=>e=>e[t],convertArray(t,e){let n=t.constructor;if(n===e)return t;return e.from(t)},arrayToBuffer(t,e = Float64Array){t.constructor===Array&&(t=new e(t));return new Uint8Array(t.buffer)},bufferToArray(t,e,n = Float64Array){e===Array&&(e=n);return e===Array?Array.from(new n(t.buffer)):new e(t.buffer)},bufferToBase64(t){let e=Array.prototype.map.call(t,t=>String.fromCharCode(t)).join('');return btoa(e)},base64ToBuffer(t){let e=atob(t),n=new Uint8Array(e.length);Array.prototype.forEach.call(e,(t,e)=>{n[e]=t.charCodeAt(0)});return n},timeit(t,e = 1e5,n = 'test'){console.time(n);for(let n=0;n<e;n++)t(n);console.timeEnd(n)},pps(t,e = ''){e&&console.log(e);let n=1,r='';while(t){if(typeof t==='function')r=t.constructor.toString();else{let e=Object.keys(t);r=e.length>0?`[${e.join(', ')}]`:`[${t.constructor.name}]`}console.log(`[${n++}]: ${r}`);t=Object.getPrototypeOf(t)}},addToDom(t,e,n = document.body){e&&(e=document.createElement(e),t=e.textContent=t);n.appendChild(t)},arraysToString:t=>t.map(t=>`[${t}]`).join(','),fixedStrings(t,e = 4){t=this.convertArray(t,Array);return t.map(t=>t.toFixed(e))},toWindow(t){Object.assign(window,t);console.log('toWindow:',Object.keys(t).join(', '))},parseQueryString(){let t={},e=document.location.search.substring(1);e.split('&').forEach(e=>{let n=e.split('=');t[n[0]]=n.length===1?!0:n[1]});return t},setScript(t,e = {}){let n=document.createElement('script');n.src=t;Object.assign(n,e);document.querySelector('head').appendChild(n)},getEventXY(t,e){let n=t.getBoundingClientRect();return[e.clientX-n.left,e.clientY-n.top]},setTextParams(t,e,n = 'center',r = 'middle'){t.font=e;t.textAlign=n;t.textBaseline=r},randomInt:t=>Math.floor(Math.random()*t),randomInt2:(t,e)=>t+Math.floor(Math.random()*(e-t)),randomFloat:t=>Math.random()*t,randomFloat2:(t,e)=>t+Math.random()*(e-t),randomCentered:t=>i.randomFloat2(-t/2,t/2),randomNormal(t = 0,e = 1){let[n,r]=[1-Math.random(),Math.random()],o=Math.sqrt(-2*Math.log(n))*Math.cos(2*Math.PI*r);return o*e+t},isPowerOf2:t=>(t&t-1)===0,nextPowerOf2:t=>Math.pow(2,Math.ceil(Math.log2(t))),fixed(t,e = 4){let n=Math.pow(10,e);return Math.round(t*n)/n},mod:(t,e)=>(t%e+e)%e,wrap:(t,e,n)=>e+i.mod(t-e,n-e),clamp(t,e,n){if(t<e)return e;if(t>n)return n;return t},between:(t,e,n)=>e<=t&&t<=n,lerp:(t,e,n)=>t<=e?t+(e-t)*n:t-(t-e)*n,lerpScale:(t,e,n)=>(t-e)/(n-e),radians:t=>t*Math.PI/180,degrees:t=>t*180/Math.PI,heading(t){let e=this.degrees(t);return this.mod((90-e),360)},angle(t){let e=this.mod(360-t,360);return this.radians(e)},subtractRadians(t,e){let n=this.mod(t-e,2*Math.PI);n>Math.PI&&(n-=2*Math.PI);return n},subtractHeadings(t,e){let n=this.mod(t-e,360);n>180&&(n-=360);return n},radiansToward:(t,e,n,r)=>Math.atan2(r-e,n-t),headingToward(t,e,n,r){return this.heading(this.radiansToward(t,e,n,r))},distance:(t,e,n,r)=>Math.sqrt(i.sqDistance(t,e,n,r)),hypot:(t,e,n,r)=>Math.hypot(t-n,e-r),sqDistance:(t,e,n,r)=>(t-n)*(t-n)+(e-r)*(e-r),inCone(t,e,n,r,o,i,a){if(this.sqDistance(i,a,t,e)>n*n)return!1;let u=this.radiansToward(i,a,t,e);return r/2>=Math.abs(this.subtractRadians(o,u))},repeat(t,e,n = []){for(let r=0;r<t;r++)e(r,n);return n},step(t,e,n){for(let r=0;r<t;r+=e)n(r)},range(t){return this.repeat(t,(t,e)=>{e[t]=t})},keyForValue(t,e){for(let n in t)if(t[n]===e)return n;return null},forEach(t,e){if(t.slice)for(let n=0,r=t.length;n<r;n++)e(t[n],n,t);else Object.keys(t).forEach(n=>e(t[n],n,t));return t},copyArray(t){return t.slice(0)},concatArrays(t,e){let n=t.constructor;if(n===Array)return t.concat(this.convertArray(e,Array));let r=new n(t.length+e.length);r.set(t);r.set(e,t.length);return r},flatten(t){if(!Array.isArray(t[0]))return t;let e=[];t.forEach(t=>e.push(...t));return this.flatten(e)},arrayType(t){return t.constructor},fixedArray(t,e = 4){t=this.convertArray(t,Array);return t.map(t=>this.fixed(t,e))},clone(t){if(t.slice)return t.slice(0);let e={};Object.keys(t).forEach(n=>{e[n]=t[n]});return e},deepClone:t=>JSON.parse(JSON.stringify(t)),objectsEqual:(t,e)=>JSON.stringify(t)===JSON.stringify(e),objectToString(t){return JSON.stringify(t,null,'  ').replace(/ {2}"/g,'  ').replace(/": /g,': ')},randomArray(t,e = 0,n = 1,r = Array){let o=new r(t);for(let r=0;r<t;r++)o[r]=this.randomFloat2(e,n);return o},histogram(t,e = 1,n = Math.floor(this.arrayMin(t))){let r=[],[o,i]=[Number.MAX_VALUE,Number.MIN_VALUE],[a,u]=[Number.MAX_VALUE,Number.MIN_VALUE];for(let s of t){let t=Math.floor(s/e)-n;r[t]=r[t]===void 0?1:r[t]+1;o=Math.min(o,t);i=Math.max(i,t);a=Math.min(a,s);u=Math.max(u,s)}for(let t in r)r[t]===void 0&&(r[t]=0);let s=i-o+1;return{bins:s,minBin:o,maxBin:i,minVal:a,maxVal:u,hist:r}},arrayMax:t=>t.reduce((t,e)=>Math.max(t,e)),arrayMin:t=>t.reduce((t,e)=>Math.min(t,e)),arraySum:t=>t.reduce((t,e)=>t+e),arrayAvg:t=>i.arraySum(t)/t.length,oneOf:t=>t[i.randomInt(t.length)],otherOneOf(t,e){do{var n=this.oneOf(t)}while(e===n);return n},arrayProps:(t,e)=>t.map(t=>t[e]),oneKeyOf:t=>i.oneOf(Object.keys(t)),oneValOf:t=>t[i.oneKeyOf(t)],sortNums(t,e = !0){return t.sort((t,n)=>e?t-n:n-t)},sortObjs(t,e,n = !0){typeof e==='string'&&(e=this.propFcn(e));let r=(t,n)=>e(t)-e(n);return t.sort((t,e)=>n?r(t,e):-r(t,e))},shuffle(t){for(let e=t.length-1;e>0;e--){let n=Math.floor(Math.random()*(e+1)),r=t[e];t[e]=t[n];t[n]=r}return t},uniq(t,e = this.identity){this.isString(e)&&(e=this.propFcn(e));return t.filter((t,n,r)=>n===0||e(t)!==e(r[n-1]))},sortedIndex(t,e,n = this.identity){this.isString(n)&&(n=this.propFcn(n));let r=n(e),o=0,i=t.length;while(o<i){let e=o+i>>>1;n(t[e])<r?(o=e+1):(i=e)}return o},indexOf(t,e,n){if(!n)return t.indexOf(e);let r=this.sortedIndex(t,e,n);return t[r]===e?r:-1},contains(t,e,n){return this.indexOf(t,e,n)>=0},removeItem(t,e,n){let r=this.indexOf(t,e,n);r!==-1?t.splice(r,1):console.log(`util.removeItem: item ${e} not in array ${t}`)},insertItem(t,e,n){let r=this.sortedIndex(t,e,n);t[r]===e&&this.error('insertItem: item already in array');t.splice(r,0,e)},aPairwise:(t,e,n)=>t.map((t,r)=>n(t,e[r])),arraysAdd:(t,e)=>i.aPairwise(t,e,(t,e)=>t+e),arraysSub:(t,e)=>i.aPairwise(t,e,(t,e)=>t-e),arraysMul:(t,e)=>i.aPairwise(t,e,(t,e)=>t*e),arraysEqual:(t,e)=>i.arraysSub(t,e).every(t=>t===0),aRamp(t,e,n){n<=1&&this.error('aRamp: numItems must be > 1');let r=[];for(let o=0;o<n;o++)r.push(t+(e-t)*(o/(n-1)));return r},aIntRamp(t,e,n = Math.abs(e-t)+1){return this.aRamp(t,e,n).map(t=>Math.round(t))},normalize(t,e = 0,n = 1){let[r,o]=[this.arrayMin(t),this.arrayMax(t)],i=1/(o-r);return t.map(t=>this.lerp(e,n,i*(t-r)))},normalize8(t){return new Uint8ClampedArray(this.normalize(t,-.5,255.5))},normalizeInt(t,e,n){return this.normalize(t,e,n).map(t=>Math.round(t))},imagePromise(t){return new Promise((e,n)=>{let r=new Image;r.crossOrigin='Anonymous';r.onload=()=>e(r);r.onerror=()=>n(Error(`Could not load image ${t}`));r.src=t})},xhrPromise(t,e = 'text',n = 'GET'){return new Promise((r,o)=>{let i=new XMLHttpRequest;i.open(n,t);i.responseType=e;i.onload=()=>r(i.response);i.onerror=()=>o(Error(`Could not load ${t}: ${i.status}`));i.send()})},timeoutPromise(t = 1e3){return new Promise((e,n)=>{setTimeout(()=>e(),t)})},scriptPromise(t,e,n = ()=>window[e],r = {}){window[e]==null&&this.setScript(t,r);return this.waitPromise(()=>window[e]!=null,n)},waitPromise(t,e = this.noop,n = 10){return new Promise((r,o)=>{this.waitOn(t,()=>r(e()),n)})},waitOn(t,e,n = 10){t()?e():setTimeout(()=>{this.waitOn(t,e,n)},n)},runGenerator(t,e = t=>{}){t=this.typeOf(t)==='generator'?t:t();
    !function n(r){let o=t.next(r);o.done?e(o.value):(o.value.then?o.value.then(n):setTimeout(()=>n(o.value),0))}()},runGeneratorPromise(t){return new Promise((e,n)=>{this.runGenerator(t,e)})},runAsyncFcn(t,e){let n=t();this.typeOf(n)==='generator'?this.runGenerator(n,e):this.typeOf(n)==='promise'?n.then(e):e()},getCanvasByID:t=>document.getElementById(t),createCanvas(t,e){let n=document.createElement('canvas');Object.assign(n,{width:t,height:e});return n},createCtx(t,e,n = '2d',r = {}){let o=this.createCanvas(t,e);return this.getContext(o,n,r)},getContext(t,e = '2d',n = {}){typeof t==='string'&&(t=this.getCanvasByID(t));e[0]!=='2'&&(e='webgl');let r=t.getContext(e,n);r||this.error('getContext error');return r},cloneCtx(t){let e=this.createCtx(t.canvas.width,t.canvas.height);e.drawImage(t.canvas,0,0);return e},resizeCtx(t,e,n){let r=this.cloneCtx(t);t.canvas.width=e;t.canvas.height=n;t.drawImage(r.canvas,0,0)},ctxImageData(t){return t.getImageData(0,0,t.canvas.width,t.canvas.height)},fillCtxWithImage(t,e){this.setIdentity(t);t.drawImage(e,0,0,t.canvas.width,t.canvas.height);t.restore()},ctxToDataUrl:t=>t.canvas.toDataURL('image/png'),dataUrlToImage(t){let e=new Image;e.src=t;return e},dataUrlToCtx(t){let e=this.dataUrlToImage(t),n=this.createCtx(e.width,e.height);n.drawImage(e,0,0);return n},setCtxSmoothing(t,e){let n=['imageSmoothingEnabled','mozImageSmoothingEnabled','oImageSmoothingEnabled','webkitImageSmoothingEnabled','msImageSmoothingEnabled'];for(let r of n)if(t[r])return t[r]=e},setIdentity(t){t.save();t.setTransform(1,0,0,1,0,0)},setWorldTransform(t,e){t.canvas.width=e.width;t.canvas.height=e.height;t.save();t.scale(e.patchSize,-e.patchSize);t.translate(-e.minXcor,-e.maxYcor)},ctxDrawText(t,e,n,r,o){this.setIdentity(t);t.fillStyle=o;t.fillText(e,n,r);t.restore()},imageToCtx(t,e = 0,n = 0,r = t.width,o = t.height){(e+r>t.width||n+o>t.height)&&this.error('imageToCtx: parameters outside of image');let i=this.createCtx(r,o);i.drawImage(t,e,n,r,o,0,0,r,o);return i},imageToBytesCtx:null,imageToBytes(t,e = !1,n = 'RGBA'){this.imageToBytesCtx||(this.imageToBytesCtx=this.createCtx(0,0,'webgl',{premultipliedAlpha:!1}));let{width:r,height:o}=t,i=this.imageToBytesCtx;Object.assign(i.canvas,{width:r,height:o});let a=i[n],u=i.createTexture();i.bindTexture(i.TEXTURE_2D,u);e&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0);i.pixelStorei(i.UNPACK_COLORSPACE_CONVERSION_WEBGL,i.NONE);i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);i.texImage2D(i.TEXTURE_2D,0,a,a,i.UNSIGNED_BYTE,t);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST);let s=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,s);i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,u,0);let c=i.checkFramebufferStatus(i.FRAMEBUFFER);c!==i.FRAMEBUFFER_COMPLETE&&this.error(`imageToBytes: status not FRAMEBUFFER_COMPLETE: ${c}`);let l=n==='RGB'?3:4,f=new Uint8Array(l*r*o);i.readPixels(0,0,r,o,a,i.UNSIGNED_BYTE,f);i.bindFramebuffer(i.FRAMEBUFFER,null);return f}};class a extends Array{static fromArray(t){Object.setPrototypeOf(t,a.prototype);return t}toArray(){Object.setPrototypeOf(this,Array.prototype);return this}remove(t,e){i.removeItem(this,t,e);return this}insert(t,e){i.insertItem(this,t,e);return this}empty(){return this.length===0}any(){return this.length!==0}first(){return this[0]}last(){return this[this.length-1]}all(t){return this.every(t)}props(t){return this.map(e=>e[t])}with(t){return this.filter(t)}ask(t){for(let e=0;e<this.length;e++)t(this[e],e);return this}count(t){return this.reduce((e,n)=>e+(t(n)?1:0),0)}clone(t = 0,e = this.length){return this.slice(t,e)}shuffle(){return i.shuffle(this)}sortBy(t,e = !0){i.sortObjs(this,t,e);return this}oneOf(){return i.oneOf(this)}otherOneOf(t){return i.otherOneOf(this,t)}minOrMaxOf(t,e){if(this.empty())throw Error('min/max OneOf: empty array');typeof e==='string'&&(e=i.propFcn(e));let n=null,r=t?1/0:-1/0;for(let o=0;o<this.length;o++){let i=this[o],a=e(i);(t&&a<r||!t&&a>r)&&([n,r]=[i,a])}return n}minOneOf(t){return this.minOrMaxOf(!0,t)}maxOneOf(t){return this.minOrMaxOf(!1,t)}nOf(t){if(t>this.length)throw Error('nOf: n larger than AgentArray');if(t===this.length)return this;let e=new a;while(e.length<t){let t=this.oneOf();(t in e)||e.push(t)}return e}minOrMaxNOf(t,e,n){if(e>this.length)throw Error('min/max nOf: n larger than AgentArray');let r=this.clone().sortBy(n);return t?r.clone(0,e):r.clone(r.length-e)}minNOf(t,e){return this.minOrMaxNOf(!0,t,e)}maxNOf(t,e){return this.minOrMaxNOf(!1,t,e)}inRect(t,e,n = e,r = !1){let o=new a,i=t.x-e,u=t.x+e,s=t.y-n,c=t.y+n;this.ask(e=>{i<=e.x&&e.x<=u&&s<=e.y&&e.y<=c&&((r||t!==e)&&o.push(e))});return o}inRadius(t,e,n = !1){let r=new a,o=e*e,u=i.sqDistance;this.ask(e=>{u(t.x,t.y,e.x,e.y)<=o&&((n||t!==e)&&r.push(e))});return r}inCone(t,e,n,r,o = !1){let u=new a;this.ask(a=>{i.inCone(a.x,a.y,e,n,r,t.x,t.y)&&((o||t!==a)&&u.push(a))});return u}}let u={rgbaString(t,e,n,r = 255){r/=255;let o=r.toPrecision(4);return r===1?`rgb(${t},${e},${n})`:`rgba(${t},${e},${n},${o})`},hslString(t,e,n,r = 255){r/=255;let o=r.toPrecision(4);return r===1?`hsl(${t},${e}%,${n}%)`:`hsla(${t},${e}%,${n}%,${o})`},hexString(t,e,n,r = !0){if(r){let[r,o,a]=[t/17,e/17,n/17];if(i.isInteger(r)&&i.isInteger(o)&&i.isInteger(a))return this.hexShortString(r,o,a)}return`#${(16777216|(n|e<<8|t<<16)).toString(16).slice(-6)}`},hexShortString(t,e,n){if(t>15||e>15||n>15){throw Error(`hexShortString: one of ${[t,e,n]} > 15`)}return`#${t.toString(16)}${e.toString(16)}${n.toString(16)}`},triString(t,e,n,r = 255){return r===255?this.hexString(t,e,n,!0):this.rgbaString(t,e,n,r)},sharedCtx1x1:i.createCtx(1,1),stringToUint8s(t){this.sharedCtx1x1.clearRect(0,0,1,1);this.sharedCtx1x1.fillStyle=t;this.sharedCtx1x1.fillRect(0,0,1,1);return this.sharedCtx1x1.getImageData(0,0,1,1).data},newColor(t,e,n,r = 255){let o=new Uint8ClampedArray([t,e,n,r]);o.pixelArray=new Uint32Array(o.buffer);Object.setPrototypeOf(o,s);return o},isColor(t){return t.constructor===Uint8ClampedArray&&t.pixelArray},toColor(t){if(this.isColor(t))return t;let e=this.newColor(0,0,0,0);if(i.isInteger(t))e.setPixel(t);else if(typeof t==='string')e.setCss(t);else if(Array.isArray(t)||i.isUintArray(t))e.setColor(...t);else if(i.isFloatArray(t))e.setWebgl(t);else throw Error('toColor: invalid argument',t);return e},randomTypedColor(){let t=()=>i.randomInt(256);return this.newColor(t(),t(),t())},transparent:null},s={__proto__:Uint8ClampedArray.prototype,setColor(t,e,n,r = 255){this.checkColorChange();this[0]=t;this[1]=e;this[2]=n;this[3]=r},set rgb(t){this.setColor(...t)},get rgb(){return this},setPixel(t){this.checkColorChange();this.pixelArray[0]=t},getPixel(){return this.pixelArray[0]},get pixel(){return this.getPixel()},set pixel(t){this.setPixel(t)},setCss(t){return this.setColor(...u.stringToUint8s(t))},getCss(){this.string==null&&(this.string=u.triString(...this));return this.string},get css(){return this.getCss()},set css(t){this.setCss(t)},setWebgl(t){this.setColor(t[0]*255,t[1]*255,t[2]*255,t.length===4?t[3]*255:void 0)},getWebgl(){if(this.floatArray==null){let t=[this[0]/255,this[1]/255,this[2]/255];this[3]!==255&&t.push(this[3]/255);this.floatArray=new Float32Array(t)}return this.floatArray},get webgl(){return this.getWebgl()},set webgl(t){this.setWebgl(t)},checkColorChange(){this.string=null;this.floatArray=null},equals(t){return this.getPixel()===t.getPixel()},rgbDistance(t,e,n){let[r,o,i]=this,a=Math.round((r+t)/2),[u,s,c]=[r-t,o-e,i-n],[l,f,d]=[u*u,s*s,c*c],h=((512+a)*l>>8)+4*f+((767-a)*d>>8);return h}};u.transparent=u.newColor(0,0,0,0);let c={gradientImageData(t,e,n){e=e.map(t=>Array.isArray(t)?u.rgbaString(...t):t);let r=i.createCtx(t,1);n||(n=i.aRamp(0,1,e.length));let o=r.createLinearGradient(0,0,t,0);i.repeat(e.length,t=>o.addColorStop(n[t],e[t]));r.fillStyle=o;r.fillRect(0,0,t,1);return i.ctxImageData(r).data},typedArraytoColors(t){let e=[];i.step(t.length,4,n=>e.push(u.newColor(...t.subarray(n,n+4))));e.typedArray=t;return e},arraysToColors(t){let e=new Uint8ClampedArray(t.length*4);i.repeat(t.length,n=>{let r=t[n];r.length===3&&r.push(255);e.set(r,n*4)});return this.typedArraytoColors(e)},permuteArrays(t,e = t,n = t){let r=[];for(let o of n)for(let n of e)for(let e of t)r.push([e,n,o]);return r},permuteRGBColors(t,e = t,n = t){let r=t=>i.aIntRamp(0,255,t),o=[t,e,n].map(r);return this.permuteArrays(...o)},ColorMapProto:{__proto__:Array.prototype,createIndex(){this.index=[];i.repeat(this.length,t=>{let e=this[t].getPixel();this.index[e]=t;this.cssNames&&(this.index[this.cssNames[t]]=t)})},randomIndex(){return i.randomInt(this.length)},randomColor(){return this[this.randomIndex()]},indexOf(t){if(this.index)return this.index[t.getPixel()];for(let e=0;e<this.length;e++)if(t.equals(this[e]))return e;return void 0},scaleColor(t,e,n){t=i.clamp(t,e,n);let r=i.lerpScale(t,e,n),o=Math.round(i.lerp(0,this.length-1,r));return this[o]},webglArray(){return this.typedArray},toString(){return`${this.length} ${i.arraysToString(this)}`},rgbClosestIndex(t,e,n){let r=1/0,o=0;for(var i=0;i<this.length;i++){let a=this[i].rgbDistance(t,e,n);if(a<r){r=a;o=i;if(a===0)return o}}return o},rgbClosestColor(t,e,n){return this[this.rgbClosestIndex(t,e,n)]},cubeClosestIndex(t,e,n){let r=this.cube,o=r.map(t=>255/(t-1)),i=[t,e,n].map((t,e)=>Math.round(t/o[e])),[a,u,s]=i;return a+u*r[0]+s*r[0]*r[1]},cubeClosestColor(t,e,n){return this[this.cubeClosestIndex(t,e,n)]},closestIndex(t,e,n){return this.cube?this.cubeClosestIndex(t,e,n):this.rgbClosestIndex(t,e,n)},closestColor(t,e,n){return this[this.closestIndex(t,e,n)]}},basicColorMap(t){t=this.arraysToColors(t);Object.setPrototypeOf(t,this.ColorMapProto);return t},grayColorMap(t = 0,e = 255,n = e-t+1){let r=i.aIntRamp(t,e,n);return this.basicColorMap(r.map(t=>[t,t,t]))},rgbColorCube(t,e = t,n = t){let r=this.permuteRGBColors(t,e,n),o=this.basicColorMap(r);o.cube=[t,e,n];return o},rgbColorMap(t,e,n){let r=this.permuteArrays(t,e,n);return this.basicColorMap(r)},hslColorMap(t,e = [100],n = [50]){let r=this.permuteArrays(t,e,n),o=r.map(t=>u.toColor(u.hslString(...t)));return this.basicColorMap(o)},gradientColorMap(t,e,n){let r=this.gradientImageData(t,e,n),o=this.typedArraytoColors(r);Object.setPrototypeOf(o,this.ColorMapProto);return o},jetColors:[[0,0,127],[0,0,255],[0,127,255],[0,255,255],[127,255,127],[255,255,0],[255,127,0],[255,0,0],[127,0,0]],basicColorNames:'white silver gray black red maroon yellow orange olive lime green cyan teal blue navy magenta purple'.split(' '),cssColorMap(t,e = !1){let n=t.map(t=>u.stringToUint8s(t)),r=this.basicColorMap(n);r.cssNames=t;e&&(t.forEach((t,e)=>{r[t]=r[e]}),r.cyan&&(r.aqua=r.cyan),r.magenta&&(r.fuchsia=r.magenta));return r},LazyMap(t,e){Object.defineProperty(this,t,{value:e,enumerable:!0});return e},get Gray(){return this.LazyMap('Gray',this.grayColorMap())},get LightGray(){return this.LazyMap('LightGray',this.grayColorMap(200))},get DarkGray(){return this.LazyMap('DarkGray',this.grayColorMap(0,100))},get Jet(){return this.LazyMap('Jet',this.gradientColorMap(256,this.jetColors))},get Rgb256(){return this.LazyMap('Rgb256',this.rgbColorCube(8,8,4))},get Rgb(){return this.LazyMap('Rgb',this.rgbColorCube(16))},get Basic16(){return this.LazyMap('Basic16',this.cssColorMap(this.basicColorNames,!0))}};class l extends a{static get[Symbol.species](){return a}constructor(t,e,n,r = null){t==null&&(t=0);typeof t==='number'?(console.log('AgentSet ctor called for AgentArray/Array.'),super(t)):(super(),r=r||this,Object.assign(this,{model:t,name:n,baseSet:r,world:t.world}),this.isBaseSet()?(this.breeds={},this.ID=0):(this.baseSet.breeds[n]=this),this.ownVariables=[],this.agentProto=new e(this),this.protoMixin())}protoMixin(){let t=this.agentProto;Object.assign(t,{agentSet:this,model:this.model,world:this.world});t[this.baseSet.name]=this.baseSet;let e=Object.getPrototypeOf(t);e.setBreed||(Object.assign(e,{setBreed(t){t.setBreed(this)},getBreed(){return this.agentSet},isBreed(t){return this.agentSet===t}}),Object.defineProperty(e,'breed',{get:function(){return this.agentSet}}))}isBreedSet(){return this.baseSet!==this}isBaseSet(){return this.baseSet===this}create(){console.log(`AgentSet: Abstract method called: ${this}`)}addAgent(t){t=t||Object.create(this.agentProto);this.isBreedSet()?this.baseSet.addAgent(t):(t.id=this.ID++);this.push(t);return t}clear(){while(this.any())this.last().die()}removeAgent(t){this.isBreedSet()&&this.baseSet.remove(t,'id');this.remove(t,'id');return this}randomColor(){return c.Basic16.randomColor()}setDefault(t,e){this.agentProto[t]=e}getDefault(t){return this.agentProto[t]}own(t){for(let e of t.split(' '))this.setDefault(e,null),this.ownVariables.push(e)}setBreed(t){if(t.agentSet===this)return;t.agentSet.isBreedSet()&&t.agentSet.remove(t,'id');this.isBreedSet()&&this.insert(t,'id');let e=t.agentSet.ownVariables;for(let n of e)this.ownVariables.includes(n)||delete t[n];for(let n of this.ownVariables)e.includes(n)||(t[n]=0);return Object.setPrototypeOf(t,this.agentProto)}}class f{constructor(t,e = 60,n = !1){Object.assign(this,{model:t,rate:e,multiStep:n});this.reset()}setRate(t,e = !1){Object.assign(this,{rate:t,multiStep:e});this.resetTimes()}start(){if(!this.stopped)return;this.resetTimes();this.stopped=!1;this.animate()}stop(){this.stopped=!0;this.animHandle&&cancelAnimationFrame(this.animHandle);this.timeoutHandle&&clearTimeout(this.timeoutHandle);this.animHandle=this.timeoutHandle=null}resetTimes(){this.startMS=this.now();this.startTick=this.ticks;this.startDraw=this.draws}reset(){this.stop();this.ticks=this.draws=0}step(){this.ticks++;this.model.step()}draw(){this.draws++;this.model.draw()}once(){this.step();this.draw()}now(){return performance.now()}ms(){return this.now()-this.startMS}ticksPerSec(){let t=this.ticks-this.startTick;return t===0?0:Math.round(t*1e3/this.ms())}drawsPerSec(){let t=this.draws-this.startDraw;return t===0?0:Math.round(t*1e3/this.ms())}toString(){return`ticks: ${this.ticks}, draws: ${this.draws}, rate: ${this.rate} tps/dps: ${this.ticksPerSec()}/${this.drawsPerSec()}`}animateSteps(){this.step();this.stopped||(this.timeoutHandle=setTimeout(()=>this.animateSteps(),10))}animateDraws(){this.drawsPerSec()<this.rate&&(this.multiStep||this.step(),this.draw());this.stopped||(this.animHandle=requestAnimationFrame(()=>this.animateDraws()))}animate(){this.multiStep&&this.animateSteps();this.animateDraws()}}class d{static emptyDataSet(t,e,n){return new d(t,e,new n(t*e))}constructor(t,e,n){if(n.length!==t*e)throw Error(`new DataSet length: ${n.length} !== ${t} * ${e}`);else Object.assign(this,{width:t,height:e,data:n})}setName(t){this.name=t;return this}getName(){return this.name?this.name:this.makeName()}makeName(){let{width:t,height:e}=this,n=i.arraySum(this.data).toFixed(2);return`${this.dataType().name}-${t}-${e}-${n}`}checkXY(t,e){if(!this.inBounds(t,e))throw Error(`DataSet.checkXY: x,y out of range: ${t}, ${e}`)}inBounds(t,e){return i.between(t,0,this.width-1)&&i.between(e,0,this.height-1)}dataType(){return this.data.constructor}type(){return this.constructor}toIndex(t,e){return t+e*this.width}toXY(t){return[t%this.width,Math.floor(t/this.width)]}getXY(t,e){return this.data[this.toIndex(t,e)]}setxy(t,e,n){this.data[this.toIndex(t,e)]=n}sample(t,e,n = !0){this.checkXY(t,e);return n?this.nearest(t,e):this.bilinear(t,e)}nearest(t,e){return this.getXY(Math.round(t),Math.round(e))}bilinear(t,e){let n=Math.floor(t),r=Math.floor(e),o=this.toIndex(n,r),i=this.width,a=t-n,u=e-r,s=1-a,c=1-u,l=this.data[o],f=this.data[o+1]||0,d=this.data[o+i]||0,h=this.data[o+1+i]||0;return l*s*c+f*a*c+d*s*u+h*a*u}copy(){return new d(this.width,this.height,i.copyArray(this.data))}emptyDataSet(t,e,n = this.dataType()){return d.emptyDataSet(t,e,n)}emptyArray(t){let e=this.type();return new e(t)}resample(t,e,n = !0,r = Array){if(t===this.width&&e===this.height)return this.copy();let o=d.emptyDataSet(t,e,r),i=(this.width-1)/(t-1),a=(this.height-1)/(e-1);for(let r=0;r<e;r++)for(let e=0;e<t;e++)o.setxy(e,r,this.sample(e*i,r*a,n));return o}subset(t,e,n,r){if(t+n>this.width||e+r>this.height)throw Error('DataSet.subSet: params out of range');let o=this.emptyDataSet(n,r);for(let i=0;i<n;i++)for(let n=0;n<r;n++)o.setxy(i,n,this.getXY(i+t,n+e));return o}map(t){return new d(this.width,this.height,this.data.map(t))}col(t){let[e,n,r]=[this.width,this.height,this.data];if(t>=e)throw Error(`col: x out of range width: ${e} x: ${t}`);let o=this.emptyArray(n);for(let i=0;i<n;i++)o[i]=r[t+i*e];return o}row(t){let[e,n]=[this.width,this.height];if(t>=n)throw Error(`row: y out of range height: ${n} x: ${t}`);return this.data.slice(t*e,(t+1)*e)}convertType(t){this.data=i.convertArray(this.data,t)}concatEast(t){let[e,n]=[this.width,this.height],[r,o]=[t.width,t.height];if(n!==o)throw Error(`concatEast: heights not equal ${n}, ${o}`);let i=this.emptyDataSet((e+r),n);for(let t=0;t<n;t++)for(let n=0;n<e;n++)i.setxy(t,n,this.getXY(t,n));for(let n=0;n<o;n++)for(let o=0;o<r;o++)i.setxy(n+e,o,t.getXY(n,o));return i}concatSouth(t){let[e,n,r]=[this.width,this.height,this.data];if(e!==t.width)throw Error(`concatSouth: widths not equal ${e}, ${t.width}`);let o=i.concatArrays(r,t.data);return new d(e,n+t.height,o)}transformCoords(t,e,n,r,o,i){let a=(t-n)*(this.width-1)/o,u=(r-e)*(this.height-1)/i;return[a,u]}coordSample(t,e,n,r,o,i,a = !0){let[u,s]=this.transformCoords(t,e,n,r,o,i);return this.sample(u,s,a)}neighborhood(t,e,n = []){n.length=0;let r=t===0||t===this.width-1||e===0||e===this.height-1;for(let o=-1;o<=1;o++){for(let a=-1;a<=1;a++){let u=t+a,s=e+o;r&&(u=i.clamp(u,0,this.width-1),s=i.clamp(s,0,this.height-1));n.push(this.data[this.toIndex(u,s)])}}return n}convolve(t,e = 1,n = !1){let[r,o,i,a]=n?[1,1,this.height-1,this.width-1]:[0,0,this.height,this.width],u=this.emptyDataSet(a,i),s=u.data,c=0;for(let n=o;n<i;n++){for(let o=r;o<a;o++){let r=this.neighborhood(o,n),i=0;for(let e=0;e<t.length;e++)i+=t[e]*r[e];s[c++]=i*e}}return u}dzdx(t = 2,e = .125){return this.convolve([-1,0,1,-t,0,t,-1,0,1],e)}dzdy(t = 2,e = .125){return this.convolve([1,t,1,0,0,0,-1,-t,-1],e)}laplace8(){return this.convolve([-1,-1,-1,-1,8,-1,-1,-1,-1])}laplace4(){return this.convolve([0,-1,0,-1,4,-1,0,-1,0])}blur(t = .0625){return this.convolve([1,2,1,2,4,2,1,2,1],t)}edge(){return this.convolve([1,1,1,1,-7,1,1,1,1])}slopeAndAspect(t = 1,e = !0,n = !0){let r=this.dzdx(),o=this.dzdy(),[a,u]=[[],[]],[s,c]=[r.height,r.width];for(let l=0;l<s;l++){for(let s=0;s<c;s++){let[c,f]=[r.getXY(s,l),o.getXY(s,l)];u.push(Math.atan(i.distance(c,f))/t);if(e)while(c===f)c+=i.randomNormal(0,1e-4),f+=i.randomNormal(0,1e-4);let d=c===f&&f===0?NaN:Math.atan2(-f,-c);n&&d<0&&(d+=2*Math.PI);a.push(d)}}u=new d(c,s,u);a=new d(c,s,a);return{slope:u,aspect:a,dzdx:r,dzdy:o}}toContext(t = !1,e = !1,n = 255){let[r,o,a]=[this.width,this.height,this.data],u;t?(u=e?i.normalize8(a):i.normalizeInt(a,0,Math.pow(2,24)-1)):(u=a.map(t=>Math.round(t)));let s=i.createCtx(r,o),c=s.getImageData(0,0,r,o),l=c.data;for(let t=0;t<u.length;t++){let[r,o]=[u[t],4*t];e?(l[o]=l[o+1]=l[o+2]=Math.floor(r),l[o+3]=n):(l[o]=r>>16&255,l[o+1]=r>>8&255,l[o+2]=r&255,l[o+3]=n)}s.putImageData(c,0,0);return s}toCanvas(t = !1,e = !1,n = 255){return this.toContext(e,t,n).canvas}toDataUrl(t = !1,e = !1,n = 255){return i.ctxToDataUrl(this.toContext(e,t,n))}max(){return this.data.reduce(function(t,e){return Math.max(t,e)})}min(){return this.data.reduce(function(t,e){return Math.min(t,e)})}equals(t){return this.width===t.width&&this.height===t.height&&i.arraysEqual(this.data,t.data)}}class h extends d{constructor(t,e = Array,n = {}){let r=t.split('\n'),o={};i.repeat(6,t=>{let e=r[t].split(/\s+/);o[e[0].toLowerCase()]=parseFloat(e[1])});let a=[];i.repeat(o.nrows,t=>{let e=r[6+t].trim().split(' ');for(let t of e)a.push(parseFloat(t))});super(o.ncols,o.nrows,i.convertArray(a,e));this.header=o;Object.assign(this,n)}}function p(t,e,n){return{width:t.width,height:t.height,data:g(t.data,e),dataType:t.dataType().name,meta:n}}function g(t,e){if(e){let e=i.arrayToBuffer(t);return i.bufferToBase64(e)}return JSON.stringify(i.convertArray(t,Array))}function m(t,e){let n=window[e];if(w(t)){let e=i.base64ToBuffer(t);return i.bufferToArray(e,n)}return i.convertArray(JSON.parse(t),n)}function w(t){return t[0]!=='['}let y={dataSetToJson(t,e = !0,n = {}){let r=p(t,e,n);return JSON.stringify(r)},jsonToDataSet(t){let e=JSON.parse(t),n=m(e.data,e.dataType);return new d(e.width,e.height,n)},toIndexedDB(t){return t}},x=new Uint8Array(4),C=new Uint32Array(x.buffer),b=new Int32Array(x.buffer),S={maxUint24:16777215,minUint24:0,maxInt24:8388607,minInt24:-8388608,checkInt24(t){if(t<this.minInt24||t>this.maxInt24)throw Error(`Int24: Range error ${t}`)},checkUint24(t){if(t<this.minUint24||t>this.maxUint24)throw Error(`Uint24: Range error ${t}`)},rgbToInt24(t,e,n){x[0]=t;x[1]=e;x[2]=n;x[3]=n>127?255:0;return b[0]},rgbToUint24(t,e,n){x[0]=t;x[1]=e;x[2]=n;x[3]=0;return C[0]},int24ToRGB(t){this.checkInt24(t);b[0]=t;return[x[0],x[1],x[2]]},uint24ToRGB(t){this.checkUint24(t);C[0]=t;return[x[0],x[1],x[2]]}},A={end0:0,end1:0,color:u.toColor('yellow'),width:1};class I{constructor(t){Object.assign(this,A)}init(t,e){this.end0=t;this.end1=e;t.links.push(this);e.links.push(this)}die(){this.agentSet.removeAgent(this);i.removeItem(this.end0.links,this);i.removeItem(this.end1.links,this)}bothEnds(){return[this.end0,this.end1]}length(){return this.end0.distance(this.end1)}otherEnd(t){return t===this.end0?this.end1:this.end0}}class P extends l{constructor(t,e,n,r = null){super(t,e,n,r)}create(t,e,n = t=>{}){Array.isArray(e)||(e=[e]);return e.map(e=>{let r=this.addAgent();r.init(t,e);n(r);return r})}}class E{static defaultOptions(t = 13,e = 16){return{patchSize:t,minX:-e,maxX:e,minY:-e,maxY:e}}constructor(t){Object.assign(this,E.defaultOptions());Object.assign(this,t);this.setWorld()}setWorld(){this.numX=this.maxX-this.minX+1;this.numY=this.maxY-this.minY+1;this.width=this.numX*this.patchSize;this.height=this.numY*this.patchSize;this.minXcor=this.minX-.5;this.maxXcor=this.maxX+.5;this.minYcor=this.minY-.5;this.maxYcor=this.maxY+.5}isOnWorld(t,e){return this.minXcor<=t&&t<=this.maxXcor&&this.minYcor<=e&&e<=this.maxYcor}}class R extends l{constructor(t,e,n,r = null){super(t,e,n,r);if(this.isBreedSet())return;this.populate();this.setPixels();this.labels=[]}populate(){i.repeat(this.world.numX*this.world.numY,t=>{this.addAgent()})}setPixels(){let{numX:t,numY:e}=this.world;this.pixels={ctx:i.createCtx(t,e)};this.setImageData()}setImageData(){let t=this.pixels;t.imageData=i.ctxImageData(t.ctx);t.data8=t.imageData.data;t.data=new Uint32Array(t.data8.buffer)}setLabel(t,e){e==null?delete this.labels[t.id]:(this.labels[t.id]=e)}getLabel(t){return this.labels[t.id]}neighborsOffsets(t,e){let{minX:n,maxX:r,minY:o,maxY:i,numX:a}=this.world;if(t===n){if(e===o)return[-a,-a+1,1];if(e===i)return[1,a+1,a];return[-a,-a+1,1,a+1,a]}if(t===r){if(e===o)return[-a-1,-a,-1];if(e===i)return[a,a-1,-1];return[-a-1,-a,a,a-1,-1]}if(e===o)return[-a-1,-a,-a+1,1,-1];if(e===i)return[1,a+1,a,a-1,-1];return[-a-1,-a,-a+1,1,a+1,a,a-1,-1]}neighbors4Offsets(t,e){let n=this.world.numX;return this.neighborsOffsets(t,e).filter(t=>Math.abs(t)===1||Math.abs(t)===n)}neighbors(t){let{id:e,x:n,y:r}=t,o=this.neighborsOffsets(n,r),i=new a(o.length);o.forEach((t,n)=>{i[n]=this[t+e]});return i}neighbors4(t){let{id:e,x:n,y:r}=t,o=this.neighbors4Offsets(n,r),i=new a(o.length);o.forEach((t,n)=>{i[n]=this[t+e]});return i}randomPt(){let{minX:t,maxX:e,minY:n,maxY:r}=this.world;return[i.randomInt2(t,e),i.randomInt2(n,r)]}randomPatch(){return this.oneOf()}installPixels(){let t=this.pixels;t.ctx.putImageData(t.imageData,0,0);return t}importColors(t){i.imagePromise(t).then(t=>this.installColors(t))}installColors(t){i.fillCtxWithImage(this.pixels.ctx,t);this.setImageData()}importDataSet(t,e,n = !1){this.isBreedSet()&&this.baseSet.importDataSet(t,e,n);let{numX:r,numY:o}=this.world,i=t.resample(r,o,n);this.ask(t=>{t[e]=i.data[t.id]})}exportDataSet(t,e = Array){let{numX:n,numY:r}=this.world,o=i.arrayProps(this,t);o=i.convertArray(o,e);return new d(n,r,o)}patchIndex(t,e){let{minX:n,maxY:r,numX:o}=this.world;return t-n+o*(r-e)}patch(t,e){if(!this.world.isOnWorld(t,e))return void 0;let n=t===this.world.maxXcor?this.world.maxX:Math.round(t),r=e===this.world.maxYcor?this.world.maxY:Math.round(e);return this.patchXY(n,r)}patchXY(t,e){return this[this.patchIndex(t,e)]}inRect(t,e,n = e,r = !0){if(t.rectCache){let o=t.rectCache[e*n+r?0:-1];if(o)return o}let o=new a,{minX:i,maxX:u,minY:s,maxY:c}=this.world;i=Math.max(i,t.x-e);u=Math.min(u,t.x+e);s=Math.max(s,t.y-n);c=Math.min(c,t.y+n);for(let e=s;e<=c;e++){for(let n=i;n<=u;n++){let i=this.patchXY(n,e);(t!==i||r)&&o.push(i)}}return o}cacheRect(t,e = t,n = !0){this.ask(r=>{r.rectCache||(r.rectCache=[]);let o=this.inRect(r,t,e,n);r.rectCache[o.length]=o})}inRadius(t,e,n = !0){let r=this.inRect(t,e,e,n);return r.inRadius(t,e,n)}inCone(t,e,n,r,o = !0){let i=this.inRect(t,e,e,o);return i.inCone(t,e,n,r,o)}patchAtAngleAndDistance(t,e,n){let{x:r,y:o}=t;r+=n*Math.cos(e);o+=n*Math.sin(e);return this.patch(r,o)}diffuse(t,e,n = null,r = 0,o = 1){this.diffuseN(8,t,e,n,r,o)}diffuse4(t,e,n = null,r = 0,o = 1){this.diffuseN(4,t,e,n,r,o)}diffuseN(t,e,n,r = null,o = 0,i = 1){if(this[0]._diffuseNext===void 0)for(let t=0;t<this.length;t++)this[t]._diffuseNext=0;for(let r=0;r<this.length;r++){let o=this[r],i=o[e]*n,a=i/t,u=t===8?o.neighbors:o.neighbors4,s=u.length;o._diffuseNext+=o[e]-i+(t-s)*a;for(let t=0;t<u.length;t++)u[t]._diffuseNext+=a}for(let t=0;t<this.length;t++){let n=this[t];n[e]=n._diffuseNext;n._diffuseNext=0;r&&n.setColor(r.scaleColor(n[e],o,i))}}}let v={turtles:null,labelOffset:[0,0],labelColor:u.newColor(0,0,0)};class T{constructor(t){Object.assign(this,v)}get x(){return this.id%this.world.numX+this.world.minX}get y(){return this.world.maxY-Math.floor(this.id/this.world.numX)}isOnEdge(){let{x:t,y:e,world:n}=this;return t===n.minX||t===n.maxX||e===n.minY||e===n.maxY}get neighbors(){let t=this.patches.neighbors(this);Object.defineProperty(this,'neighbors',{value:t,enumerable:!0});return t}get neighbors4(){let t=this.patches.neighbors4(this);Object.defineProperty(this,'neighbors4',{value:t,enumerable:!0});return t}setColor(t){this.patches.pixels.data[this.id]=u.toColor(t).getPixel()}getColor(t = null){let e=this.patches.pixels.data[this.id];if(t){t.pixel=e;return t}return u.toColor(e)}get color(){return this.getColor()}set color(t){this.setColor(t)}setLabel(t){this.patches.setLabel(this,t)}getLabel(){this.patches.getLabel(this)}get label(){return this.getLabel()}set label(t){return this.setColor(t)}turtlesHere(){this.turtles==null&&(this.patches.ask(t=>{t.turtles=[]}),this.model.turtles.ask(t=>{t.patch.turtles.push(t)}));return this.turtles}breedsHere(t){let e=this.turtlesHere();return e.filter(e=>e.agentSet===t)}distanceXY(t,e){return i.distance(this.x,this.y,t,e)}distance(t){return this.distanceXY(t.x,t.y)}towards(t){return this.towardsXY(t.x,t.y)}towardsXY(t,e){return i.radiansToward(this.x,this.y,t,e)}patchAt(t,e){return this.patches.patch(this.x+t,this.y+e)}patchAtAngleAndDistance(t,e){return this.patches.patchAtAngleAndDistance(this,t,e)}inRadius(t,e = !0){return this.patches.inRadius(this,t,e)}inCone(t,e,n,r = !0){return this.patches.inRadius(this,t,e,n,r)}sprout(t = 1,e = this.model.turtles,n = i.noop){e.create(t,t=>{t.setxy(this.x,this.y),n(t)})}}class O extends l{constructor(t,e,n,r = null){super(t,e,n,r)}create(t = 1,e = t=>{}){return i.repeat(t,(t,n)=>{let r=this.addAgent();r.theta=i.randomFloat(Math.PI*2);e(r);if(!r.sprite){let t=r.shape||'default';r.setSprite(t,this.randomColor())}n.push(r)})}randomPt(){let{minXcor:t,maxXcor:e,minYcor:n,maxYcor:r}=this.world;return[i.randomFloat2(t,e),i.randomFloat2(n,r)]}inPatches(t){let e=new a;for(let n of t)e.push(...n.turtlesHere());this.isBreedSet()&&(e=e.filter(t=>t.agentSet===this));return e}inPatchRect(t,e,n = e,r = !1){let o=this.model.patches.inRect(t.patch,e,n,!0),a=this.inPatches(o);r||i.removeItem(a,t);return a}inRadius(t,e,n = !1){let r=this.inPatchRect(t,e,e,!0);return r.inRadius(t,e,n)}inCone(t,e,n,r = !1){let o=this.inPatchRect(t,e,e,!0);return o.inCone(t,e,n,t.theta,r)}layoutCircle(t,e = [0,0],n = Math.PI/2,r = -1){let o=2*Math.PI/this.length,[i,a]=e;this.ask((e,u)=>{e.setxy(i,a),e.theta=n+r*o*u,e.forward(t)})}}let M={x:0,y:0,z:0,theta:0,size:1,atEdge:'clamp',sprite:null,color:null,shape:null};class D{constructor(t){Object.assign(this,M)}die(){this.agentSet.removeAgent(this);if(this.hasOwnProperty('links'))while(this.links.length>0)this.links[0].die();this.patch.turtles!=null&&i.removeItem(this.patch.turtles,this)}hatch(t = 1,e = this.agentSet,n = ()=>{}){return e.create(t,t=>{t.setxy(this.x,this.y);for(let n of e.ownVariables)t[n]==null&&(t[n]=this[n]);n(t)})}get links(){Object.defineProperty(this,'links',{value:[],enumerable:!0});return this.links}get patch(){return this.model.patches.patch(this.x,this.y)}get patches(){return this.model.patches}get heading(){return i.heading(this.theta)}set heading(t){this.theta=i.angle(t)}get direction(){return this.theta}set direction(t){this.theta=t}setSprite(t,e = this.color,n = 'black'){e=e||this.turtles.randomColor();if(t.sheet){this.sprite=t;return}let r=this.model.spriteSheet;this.sprite=r.newSprite(t,e,n)}setSize(t){this.size=t}setxy(t,e,n = null){let r=this.patch;n&&(this.z=n);this.world.isOnWorld(t,e)?(this.x=t,this.y=e):this.handleEdge(t,e);let o=this.patch;o.turtles!=null&&o!==r&&(i.removeItem(r.turtles,this),o.turtles.push(this))}handleEdge(t,e){if(i.isString(this.atEdge)){let{minXcor:n,maxXcor:r,minYcor:o,maxYcor:a}=this.world;if(this.atEdge==='wrap')this.x=i.wrap(t,n,r),this.y=i.wrap(e,o,a);else if(this.atEdge==='clamp'||this.atEdge==='bounce')this.x=i.clamp(t,n,r),this.y=i.clamp(e,o,a),this.atEdge==='bounce'&&(this.x===n||this.x===r?(this.theta=Math.PI-this.theta):(this.theta=-this.theta));else{throw Error(`turtle.handleEdge: bad atEdge: ${this.atEdge}`)}}else this.atEdge(this)}moveTo(t){this.setxy(t.x,t.y)}forward(t){this.setxy(this.x+t*Math.cos(this.theta),this.y+t*Math.sin(this.theta))}rotate(t){this.theta=i.mod(this.theta+t,Math.PI*2)}right(t){this.rotate(-t)}left(t){this.rotate(t)}face(t){this.theta=this.towards(t)}faceXY(t,e){this.theta=this.towardsXY(t,e)}patchAhead(t){return this.patchAtAngleAndDistance(this.theta,t)}canMove(t){return this.patchAhead(t)!=null}distanceXY(t,e){return i.distance(this.x,this.y,t,e)}distance(t){return i.distance(this.x,this.y,t.x,t.y)}towards(t){return this.towardsXY(t.x,t.y)}towardsXY(t,e){return i.radiansToward(this.x,this.y,t,e)}patchAt(t,e){return this.patches.patch(this.x+t,this.y+e)}patchAtAngleAndDistance(t,e){return this.patches.patchAtAngleAndDistance(this,t,e)}patchLeftAndAhead(t,e){return this.patchAtAngleAndDistance(t+this.theta,e)}patchRightAndAhead(t,e){return this.patchAtAngleAndDistance(t-this.theta,e)}inRadius(t,e = !1){return this.agentSet.inRadius(this,t,e)}inCone(t,e,n = !1){return this.agentSet.inCone(this,t,e,this.theta,n)}otherEnd(t){return t.end0===this?t.end1:t.end0}linkNeighbors(){return this.links.map(t=>this.otherEnd(t))}}class B{constructor(t = 64,e = 16,n = !0){Object.assign(this,{spriteSize:t,cols:e,usePowerOf2:n});this.rows=1;this.nextCol=0;this.nextRow=0;this.sprites={};this.paths=Object.assign({},k);n&&this.checkPowerOf2();this.ctx=i.createCtx(this.width,this.height);this.texture=null}get width(){return this.spriteSize*this.cols}get height(){return this.spriteSize*this.rows}get nextX(){return this.spriteSize*this.nextCol}get nextY(){return this.spriteSize*this.nextRow}get id(){return Object.keys(this.sprites).length}clear(){Object.assign(this.ctx.canvas,{width:this.width,height:this.spriteSize})}newSprite(t,e,n){e&&(e=u.toColor(e));n&&(n=u.toColor(n));let r=this.spriteName(t,e);if(this.sprites[r])return this.sprites[r];let o=i.isImageable(t)?this.addImage(t):this.addDrawing(t,e,n);e&&(o.color=e,o.shape=r.replace(/#.*/,''));this.sprites[r]=o;return o}installDrawing(t,e = t.name){this.paths[e]=t}spriteName(t,e){if(i.isImageable(t)){let e=t.src;e=e.replace(/^.*\//,'');e=e.replace(/\..*/,'.img');return e}let n=t.name||t;return`${n}${e.css}`}addImage(t){this.checkSheetSize();let[e,n,r]=[this.nextX,this.nextY,this.spriteSize];this.ctx.drawImage(t,e,n,r,r);let o=this.id,{nextRow: i,nextCol: a}=this,u={id:o,x:e,y:n,row:i,col:a,size:r,sheet:this};u.uvs=this.getUVs(u);this.incrementRowCol();this.texture&&(this.texture.needsUpdate=!0);return u}addDrawing(t,e,n,r = !0){let o=this.createFcnCanvas(t,e,n,r);return this.addImage(o)}checkSheetSize(){this.nextRow===this.rows&&(this.rows=this.usePowerOf2?this.rows*2:this.rows+1,i.resizeCtx(this.ctx,this.width,this.height),i.forEach(this.sprites,t=>{t.uvs=this.getUVs(t)}))}incrementRowCol(){this.nextCol+=1;if(this.nextCol<this.cols)return;this.nextCol=0;this.nextRow+=1}createFcnCanvas(t,e,n = 'black',r = !0){let o=i.createCtx(this.spriteSize,this.spriteSize);o.fillStyle=e.css||e;o.strokeStyle=n.css||n;r&&(o.scale(this.spriteSize/2,this.spriteSize/2),o.translate(1,1),o.beginPath());i.isString(t)?this.paths[t](o):t(o);r&&(o.closePath(),o.fill());let a=t.name||t;o.canvas.src=`${a}${e}`;return o.canvas}getUVs(t){let{row:e,col:n}=t,{rows:r,cols:o}=this,i=n/o,a=(r-(e+1))/r,u=(n+1)/o,s=(r-e)/r;return[i,a,u,a,u,s,i,s]}checkPowerOf2(){let{width:t,height:e}=this;if(!(i.isPowerOf2(t)&&i.isPowerOf2(e)))throw Error(`SpriteSheet non power of 2: ${t}x${e}`)}}let k={poly(t,e){e.forEach((e,n)=>{n===0?t.moveTo(e[0],e[1]):t.lineTo(e[0],e[1])})},default(t){this.dart(t)},arrow(t){this.poly(t,[[1,0],[0,1],[0,.4],[-1,.4],[-1,-.4],[0,-.4],[0,-1]])},bug(t){t.lineWidth=.1;this.poly(t,[[.8,.45],[.4,0],[.8,-.45]]);t.stroke();t.beginPath();t.arc(.24,0,.26,0,2*Math.PI);t.arc(-.1,0,.26,0,2*Math.PI);t.arc(-.54,0,.4,0,2*Math.PI)},circle(t){t.arc(0,0,1,0,2*Math.PI)},dart(t){this.poly(t,[[1,0],[-1,.8],[-.5,0],[-1,-.8]])},frame(t){let e=.4;t.fillRect(-1,-1,2,2);t.fill();t.clearRect(-1+e,-1+e,2-2*e,2-2*e)},frame2(t){let e=.4;t.fillRect(-1,-1,2,2);t.fill();t.fillStyle=t.strokeStyle;t.fillRect(-1+e,-1+e,2-2*e,2-2*e)},person(t){this.poly(t,[[.3,-.4],[.6,0],[.25,.2],[.25,-.1],[.2,.3],[.5,1],[.1,1],[0,.5],[-.1,1],[-.5,1],[-.2,.3],[-.25,-.1],[-.25,.2],[-.6,0],[-.3,-.4]]);t.closePath();t.arc(0,-.7,.3,0,2*Math.PI)},ring(t){let[e,n]=[1,.6];t.arc(0,0,e,0,2*Math.PI,!1);t.lineTo(n,0);t.arc(0,0,n,0,2*Math.PI,!0)},ring2(t){let[e,n]=[1,.6];t.arc(0,0,e,0,2*Math.PI);t.closePath();t.fill();t.beginPath();t.fillStyle=t.strokeStyle;t.arc(0,0,n,0,2*Math.PI)},square(t){t.fillRect(-1,-1,2,2)},triangle(t){this.poly(t,[[1,0],[-1,-.8],[-1,.8]])}};class U{constructor(t,e = this.constructor.options()){let{scene:n,model:r}=t;Object.assign(this,{scene:n,model:r,view:t,options:e});this.mesh=null}dispose(){if(!this.mesh)return;this.mesh.parent!==this.scene&&console.log('mesh parent not scene');this.mesh.parent.remove(this.mesh);this.mesh.geometry.dispose();this.mesh.material.dispose();this.mesh.material.map&&this.mesh.material.map.dispose()}init(){throw Error('init is abstract, must be overriden')}update(){throw Error('update is abstract, must be overriden')}createQuad(t,e = 0){let n=[-t,-t,e,t,-t,e,t,t,e,-t,t,e],r=[0,1,2,0,2,3];return{vertices:n,indices:r}}get spriteSheetTexture(){if(!this.model.spriteSheet.texture){let t=new e.CanvasTexture(this.model.spriteSheet.ctx.canvas);this.model.spriteSheet.texture=t}return this.model.spriteSheet.texture}}class L extends U{init(t){this.mesh&&this.dispose();let{textureOptions:n,z:r}=this.options;Object.assign(this,{canvas:t,z:r,textureOptions:n});let{width:o,height:i,numX:a,numY:u}=this.model.world,s=new e.CanvasTexture(t);for(let t in n)s[t]=e[n[t]];let c=new e.PlaneGeometry(o,i,a,u),l=new e.MeshBasicMaterial({map:s,shading:e.FlatShading,side:e.DoubleSide,transparent:!0});this.mesh=new e.Mesh(c,l);this.mesh.position.z=r;this.scene.add(this.mesh)}update(){this.mesh.material.map.needsUpdate=!0}}class z extends L{static options(){return{textureOptions:{minFilter:'NearestFilter',magFilter:'NearestFilter'},z:100}}init(t){super.init(t.pixels.ctx.canvas)}update(t){t.installPixels();super.update()}}class F extends U{static options(){return{z:2}}constructor(t,e){super(t,e);this.unitQuad=this.createQuad(.5,0)}init(){this.mesh&&this.dispose();let t=this.spriteSheetTexture,n=new Float32Array,r=new Float32Array,o=new Uint32Array,i=new e.BufferGeometry;i.addAttribute('position',new e.BufferAttribute(n,3));i.addAttribute('uv',new e.BufferAttribute(r,2));i.setIndex(new e.BufferAttribute(o,1));let a=new e.MeshBasicMaterial({map:t,alphaTest:.5,side:e.DoubleSide});this.mesh=new e.Mesh(i,a);this.mesh.position.z=this.options.z;this.scene.add(this.mesh)}update(t){let e=this.mesh,{vertices:n,indices:r}=this.unitQuad,o=this.model.world.patchSize,i=e.geometry.getAttribute('position'),a=e.geometry.getAttribute('uv'),u=e.geometry.getIndex(),s=new Float32Array(n.length*t.length),c=[],l=[];for(let e=0;e<t.length;e++){let i=t[e],a=i.size,u=i.theta,f=Math.cos(u),d=Math.sin(u),h=e*n.length;for(let t=0;t<n.length;t=t3){let e=n[t],r=n[t+1],u=i.x,c=i.y;s[t+h]=(a*(e*f-r*d)+u)*o;s[t+h+1]=(a*(e*d+r*f)+c)*o;s[t+h+2]=i.z*o}l.push(...r.map(t=>t+e*4));c.push(...i.sprite.uvs)}i.setArray(s);i.needsUpdate=!0;a.setArray(new Float32Array(c));a.needsUpdate=!0;u.setArray(new Uint32Array(l));u.needsUpdate=!0}}class X extends U{static options(){return{pointSize:1,color:null,z:2}}init(){this.mesh&&this.dispose();let{color:t,z:n}=this,r=this.options.pointSize*this.model.world.patchSize,o=new e.BufferGeometry;o.addAttribute('position',new e.BufferAttribute(new Float32Array,3));t==null&&o.addAttribute('color',new e.BufferAttribute(new Float32Array,3));let i=t?new e.PointsMaterial({size:r,color:new e.Color(t)}):new e.PointsMaterial({size:r,vertexColors:e.VertexColors});this.mesh=new e.Points(o,i);this.mesh.position.z=n;this.scene.add(this.mesh)}update(t){let e=this.mesh.geometry.getAttribute('position'),n=this.mesh.geometry.getAttribute('color'),r=[],o=n==null?null:[],i=this.model.world.patchSize,a=[1,0,0];for(let e=0;e<t.length;e++){let{x:n,y:u,z:s}=t[e];r.push(n*i,u*i,s*i);o!=null&&o.push(...a)}e.setArray(new Float32Array(r));e.needsUpdate=!0;o&&(n.setArray(new Float32Array(o)),n.needsUpdate=!0)}}class N extends U{static options(){return{z:1}}init(){this.mesh&&this.dispose();let t=new Float32Array(0),n=new Float32Array(0),r=new e.BufferGeometry;r.addAttribute('position',new e.BufferAttribute(t,3));r.addAttribute('color',new e.BufferAttribute(n,3));let o=new e.LineBasicMaterial({vertexColors:e.VertexColors});this.mesh=new e.LineSegments(r,o);this.mesh.position.z=this.options.z;this.scene.add(this.mesh)}update(t){let e=[],n=[];for(let r=0;r<t.length;r++){let{end0:o,end1:i,color:a}=t[r],{x: u,y: s,z: c}=o,{x: l,y: f,z: d}=i,h=this.model.world.patchSize;e.push(u*h,s*h,c*h,l*h,f*h,d*h);n.push(...a.webgl,...a.webgl)}let r=this.mesh.geometry.getAttribute('position'),o=this.mesh.geometry.getAttribute('color');r.setArray(new Float32Array(e));r.needsUpdate=!0;o.setArray(new Float32Array(n));o.needsUpdate=!0}}var _={BaseMesh:U,CanvasMesh:L,PatchesMesh:z,QuadSpritesMesh:F,PointsMesh:X,LinksMesh:N};window.Meshes=_;class Y{static defaultOptions(t = !0,e = !0){let n={Renderer:Y,orthoView:!1,clearColor:0,useAxes:t,useGrid:t,useControls:t,useStats:e,useGUI:e,meshes:{patches:{meshClass:'PatchesMesh',z:1},turtles:{meshClass:'QuadSpritesMesh',z:2},links:{meshClass:'LinksMesh',z:1.5}}};return n}static printMeshOptions(){let t={};for(let e in _){let n=_[e].options;n&&(t[e]={options:_[e].options()})}let e=JSON.stringify(t,null,'  ');console.log(e.replace(/ {2}"/g,'  ').replace(/": /g,': '))}constructor(t,e = {}){this.model=t;Object.assign(this,Y.defaultOptions);Object.assign(this,e);if(this.Renderer!==Y)throw Error('Three ctor: Renderer not Three',this.renderer);this.initThree();this.initThreeHelpers()}initThree(){let{clientWidth:t,clientHeight:n}=this.model.div,{orthoView:r,clearColor:o}=this,{width:i,height:a}=this.model.world,[u,s]=[i/2,a/2],c=new e.Scene,l=r?new e.OrthographicCamera(-u,u,s,-s,1,1e3):new e.PerspectiveCamera(45,t/n,1,1e4);r?l.position.set(0,0,100*i):l.position.set(i,-i,i);l.up.set(0,0,1);let f=new e.WebGLRenderer;f.setPixelRatio(window.devicePixelRatio);f.setSize(t,n);f.setClearColor(o);this.model.div.appendChild(f.domElement);window.addEventListener('resize',()=>{let{clientWidth:t,clientHeight:e}=this.model.div;l.aspect=t/e;l.updateProjectionMatrix();f.setSize(t,e)});Object.assign(this,{scene:c,camera:l,renderer:f})}initThreeHelpers(){let{scene:t,renderer:n,camera:i}=this,{useAxes:a,useGrid:u,useControls:s,useStats:c,useGUI:l}=this,{width:f}=this.model.world,d={};a&&(d.axes=new e.AxisHelper(1.5*f/2),t.add(d.axes));u&&(d.grid=new e.GridHelper(1.25*f,10),d.grid.rotation.x=e.Math.degToRad(90),t.add(d.grid));s&&(d.controls=new e.OrbitControls(i,n.domElement));c&&(d.stats=new r,document.body.appendChild(d.stats.dom));l&&(d.gui=new o.GUI);Object.assign(this,d)}}class G{static defaultWorld(t = 13,e = 16){return E.defaultOptions(t,e)}static defaultRenderer(){return Y.defaultOptions()}constructor(t = document.body,e = G.defaultWorld(),n = G.defaultRenderer()){this.div=i.isString(t)?document.getElementById(t):t;this.spriteSheet=new B;this.world=new E(e);this.view=new n.Renderer(this,n);this.meshes={};i.forEach(n.meshes,(t,e)=>{let n=_[t.meshClass].options();Object.assign(n,t);this.meshes[e]=new _[t.meshClass](this.view,n)});this.anim=new f(this);this.modelReady=!1;this.startup().then(()=>{this.reset(),this.modelReady=!0})}whenReady(t){i.waitOn(()=>this.modelReady,()=>t(this))}reset(t = !1){this.anim.reset();this.world.setWorld();this.refreshLinks=this.refreshTurtles=this.refreshPatches=!0;this.patches=new R(this,T,'patches');this.meshes.patches.init(this.patches);this.turtles=new O(this,D,'turtles');this.meshes.turtles.init(this.turtles);this.links=new P(this,I,'links');this.meshes.links.init(this.links);this.setup();t&&this.start()}async startup(){}setup(){}step(){}start(){i.waitOn(()=>this.modelReady,()=>{this.anim.start()});return this}stop(){this.anim.stop()}once(){this.stop();this.anim.once()}draw(t = this.anim.stopped||this.anim.draws===1){this.div&&((t||this.refreshPatches)&&(this.patches.length>0&&this.meshes.patches.update(this.patches)),(t||this.refreshTurtles)&&(this.turtles.length>0&&this.meshes.turtles.update(this.turtles)),(t||this.refreshLinks)&&(this.links.length>0&&this.meshes.links.update(this.links)),this.view.renderer.render(this.view.scene,this.view.camera));this.view.stats&&this.view.stats.update()}patchBreeds(t){for(let e of t.split(' '))this[e]=new R(this,T,e,this.patches)}turtleBreeds(t){for(let e of t.split(' '))this[e]=new O(this,D,e,this.turtles)}linkBreeds(t){for(let e of t.split(' '))this[e]=new P(this,I,e,this.links)}}class V extends d{constructor(t,e = Float32Array,n = {}){let r=i.imageToBytes(t),o=new e(r.buffer),a=4*o.length/r.length,u=a*t.width,s=t.height;super(u,s,o);Object.assign(this,n);this.src=t.src}}class W extends d{constructor(t,e = {}){super(t.width,t.height,new Float32Array(t.width*t.height));Object.assign(this,e);let n=i.createCtx(t.width,t.height);i.fillCtxWithImage(n,t);let r=i.ctxImageData(n),o=this.data;for(var a=0;a<o.length;a++){let t=r.data[4*a],e=r.data[4*a+1],n=r.data[4*a+2];o[a]=this.rgb2Number(t,e,n)}this.src=t.src;this.ctx=n}rgb2Number(t,e,n){var r=1;t>63&&(r=-1,t=0);var o=r*(t*256*256+e*256+n);o/=10;return o}}t.AgentSet=l;t.Animator=f;t.AscDataSet=h;t.Color=u;t.ColorMap=c;t.DataSet=d;t.DataSetIO=y;t.Int24=S;t.Link=I;t.Links=P;t.Model=G;t.Patch=T;t.Patches=R;t.RGBADataSet=V;t.RGBDataSet=W;t.SpriteSheet=B;t.Three=Y;t.ThreeMeshes=_;t.Turtle=D;t.Turtles=O;t.util=i}(this.AS=this.AS||{},THREE,null,Stats,dat)
