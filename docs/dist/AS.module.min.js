import THREE from '../dist/three.wrapper.js';import '../dist/OrbitControls.wrapper.js';import Stats from '../dist/stats.wrapper.js';import dat from '../dist/dat.gui.wrapper.js';let util={typeOf:a=>({}).toString.call(a).match(/\s(\w+)/)[1].toLowerCase(),isOneOf:(a,b)=>b.includes(util.typeOf(a)),isUintArray:a=>/^uint.*array$/.test(util.typeOf(a)),isIntArray:a=>/^int.*array$/.test(util.typeOf(a)),isFloatArray:a=>/^float.*array$/.test(util.typeOf(a)),isImage:a=>util.typeOf(a)==='image',isImageable:a=>util.isOneOf(a,['image','htmlimageelement','htmlcanvaselement']),isTypedArray:a=>util.typeOf(a.buffer)==='arraybuffer',isInteger:Number.isInteger||(a=>Math.floor(a)===a),isString:a=>typeof a==='string',isLittleEndian(){let a=new Uint32Array([16909060]);return(new Uint8ClampedArray(a.buffer))[0]===4},identity:a=>a,noop:()=>{},propFcn:a=>b=>b[a],convertArray(a,b){let c=a.constructor;if(c===b)return a;return b.from(a)},arrayToBuffer(a,b = Float64Array){a.constructor===Array&&(a=new b(a));return new Uint8Array(a.buffer)},bufferToArray(a,b,c = Float64Array){b===Array&&(b=c);return b===Array?Array.from(new c(a.buffer)):new b(a.buffer)},bufferToBase64(a){let b=Array.prototype.map.call(a,a=>String.fromCharCode(a)).join('');return btoa(b)},base64ToBuffer(a){let b=atob(a),c=new Uint8Array(b.length);Array.prototype.forEach.call(b,(a,b)=>{c[b]=a.charCodeAt(0)});return c},timeit(a,b = 1e5,c = 'test'){console.time(c);for(let c=0;c<b;c++)a(c);console.timeEnd(c)},pps(a,b = ''){b&&console.log(b);let c=1,d='';while(a){if(typeof a==='function')d=a.constructor.toString();else{let b=Object.keys(a);d=b.length>0?`[${b.join(', ')}]`:`[${a.constructor.name}]`}console.log(`[${c++}]: ${d}`);a=Object.getPrototypeOf(a)}},addToDom(a,b,c = document.body){b&&(b=document.createElement(b),a=b.textContent=a);c.appendChild(a)},arraysToString:a=>a.map(a=>`[${a}]`).join(','),fixedStrings(a,b = 4){a=this.convertArray(a,Array);return a.map(a=>a.toFixed(b))},toWindow(a){Object.assign(window,a);console.log('toWindow:',Object.keys(a).join(', '))},parseQueryString(){let a={},b=document.location.search.substring(1);b.split('&').forEach(b=>{let c=b.split('=');a[c[0]]=c.length===1?!0:c[1]});return a},setScript(a,b = {}){let c=document.createElement('script');c.src=a;Object.assign(c,b);document.querySelector('head').appendChild(c)},getEventXY(a,b){let c=a.getBoundingClientRect();return[b.clientX-c.left,b.clientY-c.top]},setTextParams(a,b,c = 'center',d = 'middle'){a.font=b;a.textAlign=c;a.textBaseline=d},randomInt:a=>Math.floor(Math.random()*a),randomInt2:(a,b)=>a+Math.floor(Math.random()*(b-a)),randomFloat:a=>Math.random()*a,randomFloat2:(a,b)=>a+Math.random()*(b-a),randomCentered:a=>util.randomFloat2(-a/2,a/2),randomNormal(a = 0,b = 1){let[c,d]=[1-Math.random(),Math.random()],e=Math.sqrt(-2*Math.log(c))*Math.cos(2*Math.PI*d);return e*b+a},isPowerOf2:a=>(a&a-1)===0,nextPowerOf2:a=>Math.pow(2,Math.ceil(Math.log2(a))),fixed(a,b = 4){let c=Math.pow(10,b);return Math.round(a*c)/c},mod:(a,b)=>(a%b+b)%b,wrap:(a,b,c)=>b+util.mod(a-b,c-b),clamp(a,b,c){if(a<b)return b;if(a>c)return c;return a},between:(a,b,c)=>b<=a&&a<=c,lerp:(a,b,c)=>a<=b?a+(b-a)*c:a-(a-b)*c,lerpScale:(a,b,c)=>(a-b)/(c-b),radians:a=>a*Math.PI/180,degrees:a=>a*180/Math.PI,heading(a){let b=this.degrees(a);return this.mod((90-b),360)},angle(a){let b=this.mod(360-a,360);return this.radians(b)},subtractRadians(a,b){let c=this.mod(a-b,2*Math.PI);c>Math.PI&&(c-=2*Math.PI);return c},subtractHeadings(a,b){let c=this.mod(a-b,360);c>180&&(c-=360);return c},radiansToward:(a,b,c,d)=>Math.atan2(d-b,c-a),headingToward(a,b,c,d){return this.heading(this.radiansToward(a,b,c,d))},distance:(a,b,c,d)=>Math.sqrt(util.sqDistance(a,b,c,d)),hypot:(a,b,c,d)=>Math.hypot(a-c,b-d),sqDistance:(a,b,c,d)=>(a-c)*(a-c)+(b-d)*(b-d),inCone(a,b,c,d,e,f,g){if(this.sqDistance(f,g,a,b)>c*c)return!1;let h=this.radiansToward(f,g,a,b);return d/2>=Math.abs(this.subtractRadians(e,h))},repeat(a,b,c = []){for(let d=0;d<a;d++)b(d,c);return c},step(a,b,c){for(let d=0;d<a;d+=b)c(d)},range(a){return this.repeat(a,(a,b)=>{b[a]=a})},keyForValue(a,b){for(let c in a)if(a[c]===b)return c;return null},forEach(a,b){if(a.slice)for(let c=0,d=a.length;c<d;c++)b(a[c],c,a);else Object.keys(a).forEach(c=>b(a[c],c,a));return a},copyArray(a){return a.slice(0)},concatArrays(a,b){let c=a.constructor;if(c===Array)return a.concat(this.convertArray(b,Array));let d=new c(a.length+b.length);d.set(a);d.set(b,a.length);return d},flatten(a){if(!Array.isArray(a[0]))return a;let b=[];a.forEach(a=>b.push(...a));return this.flatten(b)},arrayType(a){return a.constructor},fixedArray(a,b = 4){a=this.convertArray(a,Array);return a.map(a=>this.fixed(a,b))},clone(a){if(a.slice)return a.slice(0);let b={};Object.keys(a).forEach(c=>{b[c]=a[c]});return b},deepClone:a=>JSON.parse(JSON.stringify(a)),objectsEqual:(a,b)=>JSON.stringify(a)===JSON.stringify(b),objectToString(a){return JSON.stringify(a,null,'  ').replace(/ {2}"/g,'  ').replace(/": /g,': ')},randomArray(a,b = 0,c = 1,d = Array){let e=new d(a);for(let d=0;d<a;d++)e[d]=this.randomFloat2(b,c);return e},histogram(a,b = 1,c = Math.floor(this.arrayMin(a))){let d=[],[e,f]=[Number.MAX_VALUE,Number.MIN_VALUE],[g,h]=[Number.MAX_VALUE,Number.MIN_VALUE];for(let i of a){let a=Math.floor(i/b)-c;d[a]=d[a]===void 0?1:d[a]+1;e=Math.min(e,a);f=Math.max(f,a);g=Math.min(g,i);h=Math.max(h,i)}for(let a in d)d[a]===void 0&&(d[a]=0);let i=f-e+1;return{bins:i,minBin:e,maxBin:f,minVal:g,maxVal:h,hist:d}},arrayMax:a=>a.reduce((a,b)=>Math.max(a,b)),arrayMin:a=>a.reduce((a,b)=>Math.min(a,b)),arraySum:a=>a.reduce((a,b)=>a+b),arrayAvg:a=>util.arraySum(a)/a.length,oneOf:a=>a[util.randomInt(a.length)],otherOneOf(a,b){do{var c=this.oneOf(a)}while(b===c);return c},arrayProps:(a,b)=>a.map(a=>a[b]),oneKeyOf:a=>util.oneOf(Object.keys(a)),oneValOf:a=>a[util.oneKeyOf(a)],sortNums(a,b = !0){return a.sort((a,c)=>b?a-c:c-a)},sortObjs(a,b,c = !0){typeof b==='string'&&(b=this.propFcn(b));let d=(a,c)=>b(a)-b(c);return a.sort((a,b)=>c?d(a,b):-d(a,b))},shuffle(a){for(let b=a.length-1;b>0;b--){let c=Math.floor(Math.random()*(b+1)),d=a[b];a[b]=a[c];a[c]=d}return a},uniq(a,b = this.identity){this.isString(b)&&(b=this.propFcn(b));return a.filter((a,c,d)=>c===0||b(a)!==b(d[c-1]))},sortedIndex(a,b,c = this.identity){this.isString(c)&&(c=this.propFcn(c));let d=c(b),e=0,f=a.length;while(e<f){let b=e+f>>>1;c(a[b])<d?(e=b+1):(f=b)}return e},indexOf(a,b,c){if(!c)return a.indexOf(b);let d=this.sortedIndex(a,b,c);return a[d]===b?d:-1},contains(a,b,c){return this.indexOf(a,b,c)>=0},removeItem(a,b,c){let d=this.indexOf(a,b,c);d!==-1?a.splice(d,1):console.log(`util.removeItem: item ${b} not in array ${a}`)},insertItem(a,b,c){let d=this.sortedIndex(a,b,c);a[d]===b&&this.error('insertItem: item already in array');a.splice(d,0,b)},aPairwise:(a,b,c)=>a.map((a,d)=>c(a,b[d])),arraysAdd:(a,b)=>util.aPairwise(a,b,(a,b)=>a+b),arraysSub:(a,b)=>util.aPairwise(a,b,(a,b)=>a-b),arraysMul:(a,b)=>util.aPairwise(a,b,(a,b)=>a*b),arraysEqual:(a,b)=>util.arraysSub(a,b).every(a=>a===0),aRamp(a,b,c){c<=1&&this.error('aRamp: numItems must be > 1');let d=[];for(let e=0;e<c;e++)d.push(a+(b-a)*(e/(c-1)));return d},aIntRamp(a,b,c = Math.abs(b-a)+1){return this.aRamp(a,b,c).map(a=>Math.round(a))},normalize(a,b = 0,c = 1){let[d,e]=[this.arrayMin(a),this.arrayMax(a)],f=1/(e-d);return a.map(a=>this.lerp(b,c,f*(a-d)))},normalize8(a){return new Uint8ClampedArray(this.normalize(a,-.5,255.5))},normalizeInt(a,b,c){return this.normalize(a,b,c).map(a=>Math.round(a))},imagePromise(a){return new Promise((b,c)=>{let d=new Image;d.crossOrigin='Anonymous';d.onload=()=>b(d);d.onerror=()=>c(Error(`Could not load image ${a}`));d.src=a})},xhrPromise(a,b = 'text',c = 'GET'){return new Promise((d,e)=>{let f=new XMLHttpRequest;f.open(c,a);f.responseType=b;f.onload=()=>d(f.response);f.onerror=()=>e(Error(`Could not load ${a}: ${f.status}`));f.send()})},timeoutPromise(a = 1e3){return new Promise((b,c)=>{setTimeout(()=>b(),a)})},scriptPromise(a,b,c = ()=>window[b],d = {}){window[b]==null&&this.setScript(a,d);return this.waitPromise(()=>window[b]!=null,c)},waitPromise(a,b = this.noop,c = 10){return new Promise((d,e)=>{this.waitOn(a,()=>d(b()),c)})},waitOn(a,b,c = 10){a()?b():setTimeout(()=>{this.waitOn(a,b,c)},c)},runGenerator(a,b = a=>{}){a=this.typeOf(a)==='generator'?a:a();
    !function c(d){let e=a.next(d);e.done?b(e.value):(e.value.then?e.value.then(c):setTimeout(()=>c(e.value),0))}()},runGeneratorPromise(a){return new Promise((b,c)=>{this.runGenerator(a,b)})},runAsyncFcn(a,b){let c=a();this.typeOf(c)==='generator'?this.runGenerator(c,b):this.typeOf(c)==='promise'?c.then(b):b()},getCanvasByID:a=>document.getElementById(a),createCanvas(a,b){let c=document.createElement('canvas');Object.assign(c,{width:a,height:b});return c},createCtx(a,b,c = '2d',d = {}){let e=this.createCanvas(a,b);return this.getContext(e,c,d)},getContext(a,b = '2d',c = {}){typeof a==='string'&&(a=this.getCanvasByID(a));b[0]!=='2'&&(b='webgl');let d=a.getContext(b,c);d||this.error('getContext error');return d},cloneCtx(a){let b=this.createCtx(a.canvas.width,a.canvas.height);b.drawImage(a.canvas,0,0);return b},resizeCtx(a,b,c){let d=this.cloneCtx(a);a.canvas.width=b;a.canvas.height=c;a.drawImage(d.canvas,0,0)},ctxImageData(a){return a.getImageData(0,0,a.canvas.width,a.canvas.height)},fillCtxWithImage(a,b){this.setIdentity(a);a.drawImage(b,0,0,a.canvas.width,a.canvas.height);a.restore()},ctxToDataUrl:a=>a.canvas.toDataURL('image/png'),dataUrlToImage(a){let b=new Image;b.src=a;return b},dataUrlToCtx(a){let b=this.dataUrlToImage(a),c=this.createCtx(b.width,b.height);c.drawImage(b,0,0);return c},setCtxSmoothing(a,b){let c=['imageSmoothingEnabled','mozImageSmoothingEnabled','oImageSmoothingEnabled','webkitImageSmoothingEnabled','msImageSmoothingEnabled'];for(let d of c)if(a[d])return a[d]=b},setIdentity(a){a.save();a.setTransform(1,0,0,1,0,0)},setWorldTransform(a,b){a.canvas.width=b.width;a.canvas.height=b.height;a.save();a.scale(b.patchSize,-b.patchSize);a.translate(-b.minXcor,-b.maxYcor)},ctxDrawText(a,b,c,d,e){this.setIdentity(a);a.fillStyle=e;a.fillText(b,c,d);a.restore()},imageToCtx(a,b = 0,c = 0,d = a.width,e = a.height){(b+d>a.width||c+e>a.height)&&this.error('imageToCtx: parameters outside of image');let f=this.createCtx(d,e);f.drawImage(a,b,c,d,e,0,0,d,e);return f},imageToBytesCtx:null,imageToBytes(a,b = !1,c = 'RGBA'){this.imageToBytesCtx||(this.imageToBytesCtx=this.createCtx(0,0,'webgl',{premultipliedAlpha:!1}));let{width:d,height:e}=a,f=this.imageToBytesCtx;Object.assign(f.canvas,{width:d,height:e});let g=f[c],h=f.createTexture();f.bindTexture(f.TEXTURE_2D,h);b&&f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,!0);f.pixelStorei(f.UNPACK_COLORSPACE_CONVERSION_WEBGL,f.NONE);f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);f.texImage2D(f.TEXTURE_2D,0,g,g,f.UNSIGNED_BYTE,a);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.NEAREST);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST);let i=f.createFramebuffer();f.bindFramebuffer(f.FRAMEBUFFER,i);f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,h,0);let j=f.checkFramebufferStatus(f.FRAMEBUFFER);j!==f.FRAMEBUFFER_COMPLETE&&this.error(`imageToBytes: status not FRAMEBUFFER_COMPLETE: ${j}`);let k=c==='RGB'?3:4,l=new Uint8Array(k*d*e);f.readPixels(0,0,d,e,g,f.UNSIGNED_BYTE,l);f.bindFramebuffer(f.FRAMEBUFFER,null);return l}};class AgentArray extends Array{static fromArray(a){Object.setPrototypeOf(a,AgentArray.prototype);return a}toArray(){Object.setPrototypeOf(this,Array.prototype);return this}remove(a,b){util.removeItem(this,a,b);return this}insert(a,b){util.insertItem(this,a,b);return this}empty(){return this.length===0}any(){return this.length!==0}last(){return this[this.length-1]}all(a){return this.every(a)}props(a){return this.map(b=>b[a])}with(a){return this.filter(a)}ask(a){for(let b=0;b<this.length;b++)a(this[b],b);return this}count(a){return this.reduce((b,c)=>b+(a(c)?1:0),0)}clone(a = 0,b = this.length){return this.slice(a,b)}shuffle(){return util.shuffle(this)}sortBy(a,b = !0){util.sortObjs(this,a,b);return this}oneOf(){return util.oneOf(this)}otherOneOf(a){return util.otherOneOf(this,a)}minOrMaxOf(a,b){if(this.empty())throw Error('min/max OneOf: empty array');typeof b==='string'&&(b=util.propFcn(b));let c=null,d=a?1/0:-1/0;for(let e=0;e<this.length;e++){let f=this[e],g=b(f);(a&&g<d||!a&&g>d)&&([c,d]=[f,g])}return c}minOneOf(a){return this.minOrMaxOf(!0,a)}maxOneOf(a){return this.minOrMaxOf(!1,a)}nOf(a){if(a>this.length)throw Error('nOf: n larger than AgentArray');if(a===this.length)return this;let b=new AgentArray;while(b.length<a){let a=this.oneOf();(a in b)||b.push(a)}return b}minOrMaxNOf(a,b,c){if(b>this.length)throw Error('min/max nOf: n larger than AgentArray');let d=this.clone().sortBy(c);return a?d.clone(0,b):d.clone(d.length-b)}minNOf(a,b){return this.minOrMaxNOf(!0,a,b)}maxNOf(a,b){return this.minOrMaxNOf(!1,a,b)}inRect(a,b,c = b,d = !1){let e=new AgentArray,f=a.x-b,g=a.x+b,h=a.y-c,i=a.y+c;this.ask(b=>{f<=b.x&&b.x<=g&&h<=b.y&&b.y<=i&&((d||a!==b)&&e.push(b))});return e}inRadius(a,b,c = !1){let d=new AgentArray,e=b*b,f=util.sqDistance;this.ask(b=>{f(a.x,a.y,b.x,b.y)<=e&&((c||a!==b)&&d.push(b))});return d}inCone(a,b,c,d,e,f,g = !1){let h=new AgentArray;this.ask(e=>{util.inCone(e.x,e.y,b,c,d,a.x,a.y)&&((g||a!==e)&&h.push(e))});return h}}let Color={rgbaString(a,b,c,d = 255){d/=255;let e=d.toPrecision(4);return d===1?`rgb(${a},${b},${c})`:`rgba(${a},${b},${c},${e})`},hslString(a,b,c,d = 255){d/=255;let e=d.toPrecision(4);return d===1?`hsl(${a},${b}%,${c}%)`:`hsla(${a},${b}%,${c}%,${e})`},hexString(a,b,c,d = !0){if(d){let[d,e,f]=[a/17,b/17,c/17];if(util.isInteger(d)&&util.isInteger(e)&&util.isInteger(f))return this.hexShortString(d,e,f)}return`#${(16777216|(c|b<<8|a<<16)).toString(16).slice(-6)}`},hexShortString(a,b,c){if(a>15||b>15||c>15){throw Error(`hexShortString: one of ${[a,b,c]} > 15`)}return`#${a.toString(16)}${b.toString(16)}${c.toString(16)}`},triString(a,b,c,d = 255){return d===255?this.hexString(a,b,c,!0):this.rgbaString(a,b,c,d)},sharedCtx1x1:util.createCtx(1,1),stringToUint8s(a){this.sharedCtx1x1.clearRect(0,0,1,1);this.sharedCtx1x1.fillStyle=a;this.sharedCtx1x1.fillRect(0,0,1,1);return this.sharedCtx1x1.getImageData(0,0,1,1).data},newColor(a,b,c,d = 255){let e=new Uint8ClampedArray([a,b,c,d]);e.pixelArray=new Uint32Array(e.buffer);Object.setPrototypeOf(e,ColorProto);return e},isColor(a){return a.constructor===Uint8ClampedArray&&a.pixelArray},toColor(a){if(this.isColor(a))return a;let b=this.newColor(0,0,0,0);if(util.isInteger(a))b.setPixel(a);else if(typeof a==='string')b.setCss(a);else if(Array.isArray(a)||util.isUintArray(a))b.setColor(...a);else if(util.isFloatArray(a))b.setWebgl(a);else throw Error('toColor: invalid argument',a);return b},randomTypedColor(){let a=()=>util.randomInt(256);return this.newColor(a(),a(),a())},transparent:null},ColorProto={__proto__:Uint8ClampedArray.prototype,setColor(a,b,c,d = 255){this.checkColorChange();this[0]=a;this[1]=b;this[2]=c;this[3]=d},set rgb(a){this.setColor(...a)},get rgb(){return this},setPixel(a){this.checkColorChange();this.pixelArray[0]=a},getPixel(){return this.pixelArray[0]},get pixel(){return this.getPixel()},set pixel(a){this.setPixel(a)},setCss(a){return this.setColor(...Color.stringToUint8s(a))},getCss(){this.string==null&&(this.string=Color.triString(...this));return this.string},get css(){return this.getCss()},set css(a){this.setCss(a)},setWebgl(a){this.setColor(a[0]*255,a[1]*255,a[2]*255,a.length===4?a[3]*255:void 0)},getWebgl(){if(this.floatArray==null){let a=[this[0]/255,this[1]/255,this[2]/255];this[3]!==255&&a.push(this[3]/255);this.floatArray=new Float32Array(a)}return this.floatArray},get webgl(){return this.getWebgl()},set webgl(a){this.setWebgl(a)},checkColorChange(){this.string=null;this.floatArray=null},equals(a){return this.getPixel()===a.getPixel()},rgbDistance(a,b,c){let[d,e,f]=this,g=Math.round((d+a)/2),[h,i,j]=[d-a,e-b,f-c],[k,l,m]=[h*h,i*i,j*j],n=((512+g)*k>>8)+4*l+((767-g)*m>>8);return n}};Color.transparent=Color.newColor(0,0,0,0);let ColorMap={gradientImageData(a,b,c){b=b.map(a=>Array.isArray(a)?Color.rgbaString(...a):a);let d=util.createCtx(a,1);c||(c=util.aRamp(0,1,b.length));let e=d.createLinearGradient(0,0,a,0);util.repeat(b.length,a=>e.addColorStop(c[a],b[a]));d.fillStyle=e;d.fillRect(0,0,a,1);return util.ctxImageData(d).data},typedArraytoColors(a){let b=[];util.step(a.length,4,c=>b.push(Color.newColor(...a.subarray(c,c+4))));b.typedArray=a;return b},arraysToColors(a){let b=new Uint8ClampedArray(a.length*4);util.repeat(a.length,c=>{let d=a[c];d.length===3&&d.push(255);b.set(d,c*4)});return this.typedArraytoColors(b)},permuteArrays(a,b = a,c = a){let d=[];for(let e of c)for(let c of b)for(let b of a)d.push([b,c,e]);return d},permuteRGBColors(a,b = a,c = a){let d=a=>util.aIntRamp(0,255,a),e=[a,b,c].map(d);return this.permuteArrays(...e)},ColorMapProto:{__proto__:Array.prototype,createIndex(){this.index=[];util.repeat(this.length,a=>{let b=this[a].getPixel();this.index[b]=a;this.cssNames&&(this.index[this.cssNames[a]]=a)})},randomIndex(){return util.randomInt(this.length)},randomColor(){return this[this.randomIndex()]},indexOf(a){if(this.index)return this.index[a.getPixel()];for(let b=0;b<this.length;b++)if(a.equals(this[b]))return b;return void 0},scaleColor(a,b,c){a=util.clamp(a,b,c);let d=util.lerpScale(a,b,c),e=Math.round(util.lerp(0,this.length-1,d));return this[e]},webglArray(){return this.typedArray},toString(){return`${this.length} ${util.arraysToString(this)}`},rgbClosestIndex(a,b,c){let d=1/0,e=0;for(var f=0;f<this.length;f++){let g=this[f].rgbDistance(a,b,c);if(g<d){d=g;e=f;if(g===0)return e}}return e},rgbClosestColor(a,b,c){return this[this.rgbClosestIndex(a,b,c)]},cubeClosestIndex(a,b,c){let d=this.cube,e=d.map(a=>255/(a-1)),f=[a,b,c].map((a,b)=>Math.round(a/e[b])),[g,h,i]=f;return g+h*d[0]+i*d[0]*d[1]},cubeClosestColor(a,b,c){return this[this.cubeClosestIndex(a,b,c)]},closestIndex(a,b,c){return this.cube?this.cubeClosestIndex(a,b,c):this.rgbClosestIndex(a,b,c)},closestColor(a,b,c){return this[this.closestIndex(a,b,c)]}},basicColorMap(a){a=this.arraysToColors(a);Object.setPrototypeOf(a,this.ColorMapProto);return a},grayColorMap(a = 0,b = 255,c = b-a+1){let d=util.aIntRamp(a,b,c);return this.basicColorMap(d.map(a=>[a,a,a]))},rgbColorCube(a,b = a,c = a){let d=this.permuteRGBColors(a,b,c),e=this.basicColorMap(d);e.cube=[a,b,c];return e},rgbColorMap(a,b,c){let d=this.permuteArrays(a,b,c);return this.basicColorMap(d)},hslColorMap(a,b = [100],c = [50]){let d=this.permuteArrays(a,b,c),e=d.map(a=>Color.toColor(Color.hslString(...a)));return this.basicColorMap(e)},gradientColorMap(a,b,c){let d=this.gradientImageData(a,b,c),e=this.typedArraytoColors(d);Object.setPrototypeOf(e,this.ColorMapProto);return e},jetColors:[[0,0,127],[0,0,255],[0,127,255],[0,255,255],[127,255,127],[255,255,0],[255,127,0],[255,0,0],[127,0,0]],basicColorNames:'white silver gray black red maroon yellow orange olive lime green cyan teal blue navy magenta purple'.split(' '),cssColorMap(a,b = !1){let c=a.map(a=>Color.stringToUint8s(a)),d=this.basicColorMap(c);d.cssNames=a;b&&(a.forEach((a,b)=>{d[a]=d[b]}),d.cyan&&(d.aqua=d.cyan),d.magenta&&(d.fuchsia=d.magenta));return d},LazyMap(a,b){Object.defineProperty(this,a,{value:b,enumerable:!0});return b},get Gray(){return this.LazyMap('Gray',this.grayColorMap())},get LightGray(){return this.LazyMap('LightGray',this.grayColorMap(200))},get DarkGray(){return this.LazyMap('DarkGray',this.grayColorMap(0,100))},get Jet(){return this.LazyMap('Jet',this.gradientColorMap(256,this.jetColors))},get Rgb256(){return this.LazyMap('Rgb256',this.rgbColorCube(8,8,4))},get Rgb(){return this.LazyMap('Rgb',this.rgbColorCube(16))},get Basic16(){return this.LazyMap('Basic16',this.cssColorMap(this.basicColorNames,!0))}};class AgentSet extends AgentArray{static get[Symbol.species](){return AgentArray}constructor(a,b,c,d = null){a==null&&(a=0);typeof a==='number'?(console.log('AgentSet ctor called for AgentArray/Array.'),super(a)):(super(),d=d||this,Object.assign(this,{model:a,name:c,baseSet:d,world:a.world}),this.isBaseSet()?(this.breeds={},this.ID=0):(this.baseSet.breeds[c]=this),this.ownVariables=[],this.agentProto=new b(this),this.protoMixin())}protoMixin(){let a=this.agentProto;Object.assign(a,{agentSet:this,model:this.model,world:this.world});a[this.baseSet.name]=this.baseSet;let b=Object.getPrototypeOf(a);b.setBreed||(Object.assign(b,{setBreed(a){a.setBreed(this)},getBreed(){return this.agentSet},isBreed(a){return this.agentSet===a}}),Object.defineProperty(b,'breed',{get:function(){return this.agentSet}}))}isBreedSet(){return this.baseSet!==this}isBaseSet(){return this.baseSet===this}create(){console.log(`AgentSet: Abstract method called: ${this}`)}addAgent(a){a=a||Object.create(this.agentProto);this.isBreedSet()?this.baseSet.addAgent(a):(a.id=this.ID++);this.push(a);return a}clear(){while(this.any())this.last().die()}removeAgent(a){this.isBreedSet()&&this.baseSet.remove(a,'id');this.remove(a,'id');return this}randomColor(){return ColorMap.Basic16.randomColor()}setDefault(a,b){this.agentProto[a]=b}getDefault(a){return this.agentProto[a]}own(a){for(let b of a.split(' '))this.setDefault(b,null),this.ownVariables.push(b)}setBreed(a){if(a.agentSet===this)return;a.agentSet.isBreedSet()&&a.agentSet.remove(a,'id');this.isBreedSet()&&this.insert(a,'id');let b=a.agentSet.ownVariables;for(let c of b)this.ownVariables.includes(c)||delete a[c];for(let c of this.ownVariables)b.includes(c)||(a[c]=0);return Object.setPrototypeOf(a,this.agentProto)}}class Animator{constructor(a,b = 60,c = !1){Object.assign(this,{model:a,rate:b,multiStep:c});this.reset()}setRate(a,b = !1){Object.assign(this,{rate:a,multiStep:b});this.resetTimes()}start(){if(!this.stopped)return;this.resetTimes();this.stopped=!1;this.animate()}stop(){this.stopped=!0;this.animHandle&&cancelAnimationFrame(this.animHandle);this.timeoutHandle&&clearTimeout(this.timeoutHandle);this.animHandle=this.timeoutHandle=null}resetTimes(){this.startMS=this.now();this.startTick=this.ticks;this.startDraw=this.draws}reset(){this.stop();this.ticks=this.draws=0}step(){this.ticks++;this.model.step()}draw(){this.draws++;this.model.draw()}once(){this.step();this.draw()}now(){return performance.now()}ms(){return this.now()-this.startMS}ticksPerSec(){let a=this.ticks-this.startTick;return a===0?0:Math.round(a*1e3/this.ms())}drawsPerSec(){let a=this.draws-this.startDraw;return a===0?0:Math.round(a*1e3/this.ms())}toString(){return`ticks: ${this.ticks}, draws: ${this.draws}, rate: ${this.rate} tps/dps: ${this.ticksPerSec()}/${this.drawsPerSec()}`}animateSteps(){this.step();this.stopped||(this.timeoutHandle=setTimeout(()=>this.animateSteps(),10))}animateDraws(){this.drawsPerSec()<this.rate&&(this.multiStep||this.step(),this.draw());this.stopped||(this.animHandle=requestAnimationFrame(()=>this.animateDraws()))}animate(){this.multiStep&&this.animateSteps();this.animateDraws()}}class DataSet{static emptyDataSet(a,b,c){return new DataSet(a,b,new c(a*b))}constructor(a,b,c){if(c.length!==a*b)throw Error(`new DataSet length: ${c.length} !== ${a} * ${b}`);else Object.assign(this,{width:a,height:b,data:c})}setName(a){this.name=a;return this}getName(){return this.name?this.name:this.makeName()}makeName(){let{width:a,height:b}=this,c=util.arraySum(this.data).toFixed(2);return`${this.dataType().name}-${a}-${b}-${c}`}checkXY(a,b){if(!this.inBounds(a,b))throw Error(`DataSet.checkXY: x,y out of range: ${a}, ${b}`)}inBounds(a,b){return util.between(a,0,this.width-1)&&util.between(b,0,this.height-1)}dataType(){return this.data.constructor}type(){return this.constructor}toIndex(a,b){return a+b*this.width}toXY(a){return[a%this.width,Math.floor(a/this.width)]}getXY(a,b){return this.data[this.toIndex(a,b)]}setxy(a,b,c){this.data[this.toIndex(a,b)]=c}sample(a,b,c = !0){this.checkXY(a,b);return c?this.nearest(a,b):this.bilinear(a,b)}nearest(a,b){return this.getXY(Math.round(a),Math.round(b))}bilinear(a,b){let c=Math.floor(a),d=Math.floor(b),e=this.toIndex(c,d),f=this.width,g=a-c,h=b-d,i=1-g,j=1-h,k=this.data[e],l=this.data[e+1]||0,m=this.data[e+f]||0,n=this.data[e+1+f]||0;return k*i*j+l*g*j+m*i*h+n*g*h}copy(){return new DataSet(this.width,this.height,util.copyArray(this.data))}emptyDataSet(a,b,c = this.dataType()){return DataSet.emptyDataSet(a,b,c)}emptyArray(a){let b=this.type();return new b(a)}resample(a,b,c = !0,d = Array){if(a===this.width&&b===this.height)return this.copy();let e=DataSet.emptyDataSet(a,b,d),f=(this.width-1)/(a-1),g=(this.height-1)/(b-1);for(let d=0;d<b;d++)for(let b=0;b<a;b++)e.setxy(b,d,this.sample(b*f,d*g,c));return e}subset(a,b,c,d){if(a+c>this.width||b+d>this.height)throw Error('DataSet.subSet: params out of range');let e=this.emptyDataSet(c,d);for(let f=0;f<c;f++)for(let c=0;c<d;c++)e.setxy(f,c,this.getXY(f+a,c+b));return e}map(a){return new DataSet(this.width,this.height,this.data.map(a))}col(a){let[b,c,d]=[this.width,this.height,this.data];if(a>=b)throw Error(`col: x out of range width: ${b} x: ${a}`);let e=this.emptyArray(c);for(let f=0;f<c;f++)e[f]=d[a+f*b];return e}row(a){let[b,c]=[this.width,this.height];if(a>=c)throw Error(`row: y out of range height: ${c} x: ${a}`);return this.data.slice(a*b,(a+1)*b)}convertType(a){this.data=util.convertArray(this.data,a)}concatEast(a){let[b,c]=[this.width,this.height],[d,e]=[a.width,a.height];if(c!==e)throw Error(`concatEast: heights not equal ${c}, ${e}`);let f=this.emptyDataSet((b+d),c);for(let a=0;a<c;a++)for(let c=0;c<b;c++)f.setxy(a,c,this.getXY(a,c));for(let c=0;c<e;c++)for(let e=0;e<d;e++)f.setxy(c+b,e,a.getXY(c,e));return f}concatSouth(a){let[b,c,d]=[this.width,this.height,this.data];if(b!==a.width)throw Error(`concatSouth: widths not equal ${b}, ${a.width}`);let e=util.concatArrays(d,a.data);return new DataSet(b,c+a.height,e)}transformCoords(a,b,c,d,e,f){let g=(a-c)*(this.width-1)/e,h=(d-b)*(this.height-1)/f;return[g,h]}coordSample(a,b,c,d,e,f,g = !0){let[h,i]=this.transformCoords(a,b,c,d,e,f);return this.sample(h,i,g)}neighborhood(a,b,c = []){c.length=0;let d=a===0||a===this.width-1||b===0||b===this.height-1;for(let e=-1;e<=1;e++){for(let f=-1;f<=1;f++){let g=a+f,h=b+e;d&&(g=util.clamp(g,0,this.width-1),h=util.clamp(h,0,this.height-1));c.push(this.data[this.toIndex(g,h)])}}return c}convolve(a,b = 1,c = !1){let[d,e,f,g]=c?[1,1,this.height-1,this.width-1]:[0,0,this.height,this.width],h=this.emptyDataSet(g,f),i=h.data,j=0;for(let c=e;c<f;c++){for(let e=d;e<g;e++){let d=this.neighborhood(e,c),f=0;for(let b=0;b<a.length;b++)f+=a[b]*d[b];i[j++]=f*b}}return h}dzdx(a = 2,b = .125){return this.convolve([-1,0,1,-a,0,a,-1,0,1],b)}dzdy(a = 2,b = .125){return this.convolve([1,a,1,0,0,0,-1,-a,-1],b)}laplace8(){return this.convolve([-1,-1,-1,-1,8,-1,-1,-1,-1])}laplace4(){return this.convolve([0,-1,0,-1,4,-1,0,-1,0])}blur(a = .0625){return this.convolve([1,2,1,2,4,2,1,2,1],a)}edge(){return this.convolve([1,1,1,1,-7,1,1,1,1])}slopeAndAspect(a = 1,b = !0,c = !0){let d=this.dzdx(),e=this.dzdy(),[f,g]=[[],[]],[h,i]=[d.height,d.width];for(let j=0;j<h;j++){for(let h=0;h<i;h++){let[i,k]=[d.getXY(h,j),e.getXY(h,j)];g.push(Math.atan(util.distance(i,k))/a);if(b)while(i===k)i+=util.randomNormal(0,1e-4),k+=util.randomNormal(0,1e-4);let l=i===k&&k===0?NaN:Math.atan2(-k,-i);c&&l<0&&(l+=2*Math.PI);f.push(l)}}g=new DataSet(i,h,g);f=new DataSet(i,h,f);return{slope:g,aspect:f,dzdx:d,dzdy:e}}toContext(a = !1,b = !1,c = 255){let[d,e,f]=[this.width,this.height,this.data],g;a?(g=b?util.normalize8(f):util.normalizeInt(f,0,Math.pow(2,24)-1)):(g=f.map(a=>Math.round(a)));let h=util.createCtx(d,e),i=h.getImageData(0,0,d,e),j=i.data;for(let a=0;a<g.length;a++){let[d,e]=[g[a],4*a];b?(j[e]=j[e+1]=j[e+2]=Math.floor(d),j[e+3]=c):(j[e]=d>>16&255,j[e+1]=d>>8&255,j[e+2]=d&255,j[e+3]=c)}h.putImageData(i,0,0);return h}toCanvas(a = !1,b = !1,c = 255){return this.toContext(b,a,c).canvas}toDataUrl(a = !1,b = !1,c = 255){return util.ctxToDataUrl(this.toContext(b,a,c))}max(){return this.data.reduce(function(a,b){return Math.max(a,b)})}min(){return this.data.reduce(function(a,b){return Math.min(a,b)})}equals(a){return this.width===a.width&&this.height===a.height&&util.arraysEqual(this.data,a.data)}}class AscDataSet extends DataSet{constructor(a,b = Array,c = {}){let d=a.split('\n'),e={};util.repeat(6,a=>{let b=d[a].split(/\s+/);e[b[0].toLowerCase()]=parseFloat(b[1])});let f=[];util.repeat(e.nrows,a=>{let b=d[6+a].trim().split(' ');for(let a of b)f.push(parseFloat(a))});super(e.ncols,e.nrows,util.convertArray(f,b));this.header=e;Object.assign(this,c)}}function jsonObject(a,b,c){return{width:a.width,height:a.height,data:arrayToString(a.data,b),dataType:a.dataType().name,meta:c}}function arrayToString(a,b){if(b){let b=util.arrayToBuffer(a);return util.bufferToBase64(b)}return JSON.stringify(util.convertArray(a,Array))}function stringToArray(a,b){let c=window[b];if(isBase64(a)){let b=util.base64ToBuffer(a);return util.bufferToArray(b,c)}return util.convertArray(JSON.parse(a),c)}function isBase64(a){return a[0]!=='['}let DataSetIO={dataSetToJson(a,b = !0,c = {}){let d=jsonObject(a,b,c);return JSON.stringify(d)},jsonToDataSet(a){let b=JSON.parse(a),c=stringToArray(b.data,b.dataType);return new DataSet(b.width,b.height,c)},toIndexedDB(a){return a}},byteArray=new Uint8Array(4),uint24array=new Uint32Array(byteArray.buffer),int24array=new Int32Array(byteArray.buffer),Int24={maxUint24:16777215,minUint24:0,maxInt24:8388607,minInt24:-8388608,checkInt24(a){if(a<this.minInt24||a>this.maxInt24)throw Error(`Int24: Range error ${a}`)},checkUint24(a){if(a<this.minUint24||a>this.maxUint24)throw Error(`Uint24: Range error ${a}`)},rgbToInt24(a,b,c){byteArray[0]=a;byteArray[1]=b;byteArray[2]=c;byteArray[3]=c>127?255:0;return int24array[0]},rgbToUint24(a,b,c){byteArray[0]=a;byteArray[1]=b;byteArray[2]=c;byteArray[3]=0;return uint24array[0]},int24ToRGB(a){this.checkInt24(a);int24array[0]=a;return[byteArray[0],byteArray[1],byteArray[2]]},uint24ToRGB(a){this.checkUint24(a);uint24array[0]=a;return[byteArray[0],byteArray[1],byteArray[2]]}},linkVariables={end0:0,end1:0,color:Color.toColor('yellow'),width:1};class Link{constructor(a){Object.assign(this,linkVariables)}init(a,b){this.end0=a;this.end1=b;a.links.push(this);b.links.push(this)}die(){this.agentSet.removeAgent(this);util.removeItem(this.end0.links,this);util.removeItem(this.end1.links,this)}bothEnds(){return[this.end0,this.end1]}length(){return this.end0.distance(this.end1)}otherEnd(a){return a===this.end0?this.end1:this.end0}}class Links extends AgentSet{constructor(a,b,c,d = null){super(a,b,c,d)}create(a,b,c = a=>{}){Array.isArray(b)||(b=[b]);return b.map(b=>{let d=this.addAgent();d.init(a,b);c(d);return d})}}class Patches extends AgentSet{constructor(a,b,c,d = null){super(a,b,c,d);if(typeof a==='number'||this.isBreedSet())return;this.populate();this.setPixels();this.labels=[]}populate(){util.repeat(this.world.numX*this.world.numY,a=>{this.addAgent()})}setPixels(){let{numX:a,numY:b}=this.world;this.pixels={ctx:util.createCtx(a,b)};this.setImageData()}setImageData(){let a=this.pixels;a.imageData=util.ctxImageData(a.ctx);a.data8=a.imageData.data;a.data=new Uint32Array(a.data8.buffer)}setLabel(a,b){b==null?delete this.labels[a.id]:(this.labels[a.id]=b)}getLabel(a){return this.labels[a.id]}neighborsOffsets(a,b){let{minX:c,maxX:d,minY:e,maxY:f,numX:g}=this.world;if(a===c){if(b===e)return[-g,-g+1,1];if(b===f)return[1,g+1,g];return[-g,-g+1,1,g+1,g]}if(a===d){if(b===e)return[-g-1,-g,-1];if(b===f)return[g,g-1,-1];return[-g-1,-g,g,g-1,-1]}if(b===e)return[-g-1,-g,-g+1,1,-1];if(b===f)return[1,g+1,g,g-1,-1];return[-g-1,-g,-g+1,1,g+1,g,g-1,-1]}neighbors4Offsets(a,b){let c=this.world.numX;return this.neighborsOffsets(a,b).filter(a=>Math.abs(a)===1||Math.abs(a)===c)}neighbors(a){let{id:b,x:c,y:d}=a,e=this.neighborsOffsets(c,d),f=new AgentArray(e.length);e.forEach((a,c)=>{f[c]=this[a+b]});return f}neighbors4(a){let{id:b,x:c,y:d}=a,e=this.neighbors4Offsets(c,d),f=new AgentArray(e.length);e.forEach((a,c)=>{f[c]=this[a+b]});return f}randomPt(){let{minXcor:a,maxXcor:b,minYcor:c,maxYcor:d}=this.world;return[util.randomFloat2(a,b),util.randomFloat2(c,d)]}randomPatch(){return this.oneOf()}patchRect(a,b,c = b,d = !0){if(a.pRect&&a.pRect.length===b*c)return a.pRect;let e=new AgentArray,{minX:f,maxX:g,minY:h,maxY:i}=this.world;f=Math.max(f,a.x-b);g=Math.min(g,a.x+b);h=Math.max(h,a.y-c);i=Math.min(i,a.y+c);for(let b=h;b<=i;b++){for(let c=f;c<=g;c++){let f=this.patchXY(c,b);(a!==f||d)&&e.push(f)}}return e}installPixels(){let a=this.pixels;a.ctx.putImageData(a.imageData,0,0);return a}importColors(a){util.imagePromise(a).then(a=>this.installColors(a))}installColors(a){util.fillCtxWithImage(this.pixels.ctx,a);this.setImageData()}importDataSet(a,b,c = !1){this.isBreedSet()&&this.baseSet.importDataSet(a,b,c);let{numX:d,numY:e}=this.world,f=a.resample(d,e,c);this.ask(a=>{a[b]=f.data[a.id]})}exportDataSet(a,b = Array){let{numX:c,numY:d}=this.world,e=util.arrayProps(this,a);e=util.convertArray(e,b);return new DataSet(c,d,e)}patchXYToIndex(a,b){let{minX:c,maxY:d,numX:e}=this.world;return a-c+e*(d-b)}patchIndexToXY(a){let{minX:b,maxY:c,numX:d}=this.world;return[a%d+b,c-Math.floor(a/d)]}pixelXYToPatchXY(a,b){let{patchSize:c,minXcor:d,maxYcor:e}=this.world;return[d+a/c,e-b/c]}patchXYToPixelXY(a,b){let{patchSize:c,minXcor:d,maxYcor:e}=this.world;return[(a-d)*c,(e-b)*c]}patch(a,b){if(!this.world.isOnWorld(a,b))return void 0;let c=a===this.world.maxXcor?this.world.maxX:Math.round(a),d=b===this.world.maxYcor?this.world.maxY:Math.round(b);return this.patchXY(c,d)}patchXY(a,b){return this[this.patchXYToIndex(a,b)]}inRadius(a,b,c = !0){let d=b*b,e=new AgentArray,f=util.sqDistance,g=this.patchRect(a,b,b,c);for(let b=0;b<g.length;b++){let c=g[b];f(a.x,a.y,c.x,c.y)<=d&&e.push(c)}return e}inCone(a,b,c,d,e = !0){let f=this.patchRect(a,b,b,e),g=new AgentArray;for(let h=0;h<f.length;h++){let i=f[h],j=util.inCone(i.x,i.y,b,c,d,a.x,a.y);j&&(a!==i||e)&&g.push(i)}return g}patchAtAngleAndDistance(a,b,c){let{x:d,y:e}=a;d+=c*Math.cos(b);e+=c*Math.sin(b);return this.patch(d,e)}patchLeftAndAhead(a,b){return this.patchAtAngleAndDistance(a,b)}patchRightAndAhead(a,b){return this.patchAtAngleAndDistance(-a,b)}diffuse(a,b,c = null,d = 0,e = 1){this.diffuseN(8,a,b,c,d,e)}diffuse4(a,b,c = null,d = 0,e = 1){this.diffuseN(4,a,b,c,d,e)}diffuseN(a,b,c,d = null,e = 0,f = 1){if(this[0]._diffuseNext===void 0)for(let a=0;a<this.length;a++)this[a]._diffuseNext=0;for(let d=0;d<this.length;d++){let e=this[d],f=e[b]*c,g=f/a,h=a===8?e.neighbors:e.neighbors4,i=h.length;e._diffuseNext+=e[b]-f+(a-i)*g;for(let a=0;a<h.length;a++)h[a]._diffuseNext+=g}for(let a=0;a<this.length;a++){let c=this[a];c[b]=c._diffuseNext;c._diffuseNext=0;d&&c.setColor(d.scaleColor(c[b],e,f))}}}let patchVariables={turtles:null,labelOffset:[0,0],labelColor:Color.newColor(0,0,0)};class Patch{constructor(a){Object.assign(this,patchVariables)}get x(){return this.id%this.world.numX+this.world.minX}get y(){return this.world.maxY-Math.floor(this.id/this.world.numX)}isOnEdge(){let{x:a,y:b,world:c}=this;return a===c.minX||a===c.maxX||b===c.minY||b===c.maxY}get neighbors(){let a=this.patches.neighbors(this);Object.defineProperty(this,'neighbors',{value:a,enumerable:!0});return a}get neighbors4(){let a=this.patches.neighbors4(this);Object.defineProperty(this,'neighbors4',{value:a,enumerable:!0});return a}setColor(a){this.patches.pixels.data[this.id]=a.getPixel()}getColor(a = null){let b=this.patches.pixels.data[this.id];if(a){a.pixel=b;return a}return Color.toColor(b)}get color(){return this.getColor()}set color(a){return this.setColor(a)}setLabel(a){this.patches.setLabel(this,a)}getLabel(){this.patches.getLabel(this)}get label(){return this.getLabel()}set label(a){return this.setColor(a)}turtlesHere(){this.turtles==null&&(this.patches.ask(a=>{a.turtles=[]}),this.model.turtles.ask(a=>{a.patch.turtles.push(a)}));return this.turtles}breedsHere(a){let b=this.turtlesHere();return b.filter(b=>b.agentSet===a)}distanceXY(a,b){return util.distance(this.x,this.y,a,b)}distance(a){return this.distanceXY(a.x,a.y)}towards(a){return this.towardsXY(a.x,a.y)}towardsXY(a,b){return util.radiansToward(this.x,this.y,a,b)}patchAt(a,b){return this.patches.patch(this.x+a,this.y+b)}patchAtAngleAndDistance(a,b){return this.patches.patchAtAngleAndDistance(this,a,b)}inRadius(a,b = !0){return this.patches.inRadius(this,a,b)}inCone(a,b,c,d = !0){return this.patches.inRadius(this,a,b,c,d)}sprout(a = 1,b = this.model.turtles,c = util.noop){b.create(a,a=>{a.setxy(this.x,this.y),c(a)})}}class Turtles extends AgentSet{constructor(a,b,c,d = null){super(a,b,c,d)}create(a = 1,b = a=>{}){return util.repeat(a,(a,c)=>{let d=this.addAgent();d.theta=util.randomFloat(Math.PI*2);b(d);if(!d.sprite){let a=d.shape||'default';d.setSprite(a,this.randomColor())}c.push(d)})}inPatches(a){let b=new AgentArray;for(let c of a)b.push(...c.turtlesHere());this.isBreedSet()&&(b=b.filter(a=>a.agentSet===this));return b}inPatchRect(a,b,c = b,d = !1){let e=this.model.patches.patchRect(a.patch,b,c,!0),f=this.inPatches(e);d||util.removeItem(f,a);return f}inRadius(a,b,c = !1){let d=this.inPatchRect(a,b,b,!0);return d.inRadius(a,b,c)}inCone(a,b,c,d,e,f = !1){let g=this.inPatchRect(a,b,b,!0);return g.inCone(a,b,c,a.theta,d,e,f)}layoutCircle(a,b = [0,0],c = Math.PI/2,d = -1){let e=2*Math.PI/this.length,[f,g]=b;this.ask((b,h)=>{b.setxy(f,g),b.theta=c+d*e*h,b.forward(a)})}}let turtleVariables={x:0,y:0,z:0,theta:0,size:1,atEdge:'clamp',sprite:null,color:null,shape:null};class Turtle{constructor(a){Object.assign(this,turtleVariables)}die(){this.agentSet.removeAgent(this);if(this.hasOwnProperty('links'))while(this.links.length>0)this.links[0].die();this.patch.turtles!=null&&util.removeItem(this.patch.turtles,this)}hatch(a = 1,b = this.agentSet,c = ()=>{}){return b.create(a,a=>{a.setxy(this.x,this.y);for(let c of b.ownVariables)a[c]==null&&(a[c]=this[c]);c(a)})}get links(){Object.defineProperty(this,'links',{value:[],enumerable:!0});return this.links}get patch(){return this.model.patches.patch(this.x,this.y)}get patches(){return this.model.patches}get heading(){return util.heading(this.theta)}set heading(a){this.theta=util.angle(a)}get direction(){return this.theta}set direction(a){this.theta=a}setSprite(a,b = this.color,c = 'black'){b=b||this.turtles.randomColor();if(a.sheet){this.sprite=a;return}let d=this.model.spriteSheet;this.sprite=d.newSprite(a,b,c)}setSize(a){this.size=a}setxy(a,b,c = null){let d=this.patch;c&&(this.z=c);this.world.isOnWorld(a,b)?(this.x=a,this.y=b):this.handleEdge(a,b);let e=this.patch;e.turtles!=null&&e!==d&&(util.removeItem(d.turtles,this),e.turtles.push(this))}handleEdge(a,b){if(util.isString(this.atEdge)){let{minXcor:c,maxXcor:d,minYcor:e,maxYcor:f}=this.world;if(this.atEdge==='wrap')this.x=util.wrap(a,c,d),this.y=util.wrap(b,e,f);else if(this.atEdge==='clamp'||this.atEdge==='bounce')this.x=util.clamp(a,c,d),this.y=util.clamp(b,e,f),this.atEdge==='bounce'&&(this.x===c||this.x===d?(this.theta=Math.PI-this.theta):(this.theta=-this.theta));else{throw Error(`turtle.handleEdge: bad atEdge: ${this.atEdge}`)}}else this.atEdge(this)}moveTo(a){this.setxy(a.x,a.y)}forward(a){this.setxy(this.x+a*Math.cos(this.theta),this.y+a*Math.sin(this.theta))}rotate(a){this.theta=util.mod(this.theta+a,Math.PI*2)}right(a){this.rotate(-a)}left(a){this.rotate(a)}face(a){this.theta=this.towards(a)}faceXY(a,b){this.theta=this.towardsXY(a,b)}patchAhead(a){return this.patchAtAngleAndDistance(this.theta,a)}canMove(a){return this.patchAhead(a)!=null}distanceXY(a,b){return util.distance(this.x,this.y,a,b)}distance(a){return util.distance(this.x,this.y,a.x,a.y)}towards(a){return this.towardsXY(a.x,a.y)}towardsXY(a,b){return util.radiansToward(this.x,this.y,a,b)}patchAt(a,b){return this.patches.patch(this.x+a,this.y+b)}patchAtAngleAndDistance(a,b){return this.patches.patchAtAngleAndDistance(this,a,b)}patchLeftAndAhead(a,b){return this.patchAtAngleAndDistance(a+this.theta,b)}patchRightAndAhead(a,b){return this.patchAtAngleAndDistance(a-this.theta,b)}inRadius(a,b = !1){return this.agentSet.inRadius(this,a,b)}inCone(a,b = !1){return this.agentSet.inCone(this,a,b)}otherEnd(a){return a.end0===this?a.end1:a.end0}linkNeighbors(){return this.links.map(a=>this.otherEnd(a))}}class SpriteSheet{constructor(a = 64,b = 16,c = !0){Object.assign(this,{spriteSize:a,cols:b,usePowerOf2:c});this.rows=1;this.nextCol=0;this.nextRow=0;this.sprites={};this.paths=Object.assign({},paths);c&&this.checkPowerOf2();this.ctx=util.createCtx(this.width,this.height);this.texture=null}get width(){return this.spriteSize*this.cols}get height(){return this.spriteSize*this.rows}get nextX(){return this.spriteSize*this.nextCol}get nextY(){return this.spriteSize*this.nextRow}get id(){return Object.keys(this.sprites).length}clear(){Object.assign(this.ctx.canvas,{width:this.width,height:this.spriteSize})}newSprite(a,b,c){b&&(b=Color.toColor(b));c&&(c=Color.toColor(c));let d=this.spriteName(a,b);if(this.sprites[d])return this.sprites[d];let e=util.isImageable(a)?this.addImage(a):this.addDrawing(a,b,c);b&&(e.color=b,e.shape=d.replace(/#.*/,''));this.sprites[d]=e;return e}installDrawing(a,b = a.name){this.paths[b]=a}spriteName(a,b){if(util.isImageable(a)){let b=a.src;b=b.replace(/^.*\//,'');b=b.replace(/\..*/,'.img');return b}let c=a.name||a;return`${c}${b.css}`}addImage(a){this.checkSheetSize();let[b,c,d]=[this.nextX,this.nextY,this.spriteSize];this.ctx.drawImage(a,b,c,d,d);let e=this.id,{nextRow: f,nextCol: g}=this,h={id:e,x:b,y:c,row:f,col:g,size:d,sheet:this};h.uvs=this.getUVs(h);this.incrementRowCol();this.texture&&(this.texture.needsUpdate=!0);return h}addDrawing(a,b,c,d = !0){let e=this.createFcnCanvas(a,b,c,d);return this.addImage(e)}checkSheetSize(){this.nextRow===this.rows&&(this.rows=this.usePowerOf2?this.rows*2:this.rows+1,util.resizeCtx(this.ctx,this.width,this.height),util.forEach(this.sprites,a=>{a.uvs=this.getUVs(a)}))}incrementRowCol(){this.nextCol+=1;if(this.nextCol<this.cols)return;this.nextCol=0;this.nextRow+=1}createFcnCanvas(a,b,c = 'black',d = !0){let e=util.createCtx(this.spriteSize,this.spriteSize);e.fillStyle=b.css||b;e.strokeStyle=c.css||c;d&&(e.scale(this.spriteSize/2,this.spriteSize/2),e.translate(1,1),e.beginPath());util.isString(a)?this.paths[a](e):a(e);d&&(e.closePath(),e.fill());let f=a.name||a;e.canvas.src=`${f}${b}`;return e.canvas}getUVs(a){let{row:b,col:c}=a,{rows:d,cols:e}=this,f=c/e,g=(d-(b+1))/d,h=(c+1)/e,i=(d-b)/d;return[f,g,h,g,h,i,f,i]}checkPowerOf2(){let{width:a,height:b}=this;if(!(util.isPowerOf2(a)&&util.isPowerOf2(b)))throw Error(`SpriteSheet non power of 2: ${a}x${b}`)}}let paths={poly(a,b){b.forEach((b,c)=>{c===0?a.moveTo(b[0],b[1]):a.lineTo(b[0],b[1])})},default(a){this.dart(a)},arrow(a){this.poly(a,[[1,0],[0,1],[0,.4],[-1,.4],[-1,-.4],[0,-.4],[0,-1]])},bug(a){a.lineWidth=.1;this.poly(a,[[.8,.45],[.4,0],[.8,-.45]]);a.stroke();a.beginPath();a.arc(.24,0,.26,0,2*Math.PI);a.arc(-.1,0,.26,0,2*Math.PI);a.arc(-.54,0,.4,0,2*Math.PI)},circle(a){a.arc(0,0,1,0,2*Math.PI)},dart(a){this.poly(a,[[1,0],[-1,.8],[-.5,0],[-1,-.8]])},frame(a){let b=.4;a.fillRect(-1,-1,2,2);a.fill();a.clearRect(-1+b,-1+b,2-2*b,2-2*b)},frame2(a){let b=.4;a.fillRect(-1,-1,2,2);a.fill();a.fillStyle=a.strokeStyle;a.fillRect(-1+b,-1+b,2-2*b,2-2*b)},person(a){this.poly(a,[[.3,-.4],[.6,0],[.25,.2],[.25,-.1],[.2,.3],[.5,1],[.1,1],[0,.5],[-.1,1],[-.5,1],[-.2,.3],[-.25,-.1],[-.25,.2],[-.6,0],[-.3,-.4]]);a.closePath();a.arc(0,-.7,.3,0,2*Math.PI)},ring(a){let[b,c]=[1,.6];a.arc(0,0,b,0,2*Math.PI,!1);a.lineTo(c,0);a.arc(0,0,c,0,2*Math.PI,!0)},ring2(a){let[b,c]=[1,.6];a.arc(0,0,b,0,2*Math.PI);a.closePath();a.fill();a.beginPath();a.fillStyle=a.strokeStyle;a.arc(0,0,c,0,2*Math.PI)},square(a){a.fillRect(-1,-1,2,2)},triangle(a){this.poly(a,[[1,0],[-1,-.8],[-1,.8]])}};class BaseMesh{constructor(a,b = this.constructor.options()){let{scene:c,model:d}=a;Object.assign(this,{scene:c,model:d,view:a,options:b});this.mesh=null}dispose(){if(!this.mesh)return;this.mesh.parent!==this.scene&&console.log('mesh parent not scene');this.mesh.parent.remove(this.mesh);this.mesh.geometry.dispose();this.mesh.material.dispose();this.mesh.material.map&&this.mesh.material.map.dispose()}init(){throw Error('init is abstract, must be overriden')}update(){throw Error('update is abstract, must be overriden')}createQuad(a,b = 0){let c=[-a,-a,b,a,-a,b,a,a,b,-a,a,b],d=[0,1,2,0,2,3];return{vertices:c,indices:d}}get spriteSheetTexture(){if(!this.model.spriteSheet.texture){let a=new THREE.CanvasTexture(this.model.spriteSheet.ctx.canvas);this.model.spriteSheet.texture=a}return this.model.spriteSheet.texture}}class CanvasMesh extends BaseMesh{init(a){this.mesh&&this.dispose();let{textureOptions:b,z:c}=this.options;Object.assign(this,{canvas:a,z:c,textureOptions:b});let{width:d,height:e,numX:f,numY:g}=this.model.world,h=new THREE.CanvasTexture(a);for(let a in b)h[a]=THREE[b[a]];let i=new THREE.PlaneGeometry(d,e,f,g),j=new THREE.MeshBasicMaterial({map:h,shading:THREE.FlatShading,side:THREE.DoubleSide,transparent:!0});this.mesh=new THREE.Mesh(i,j);this.mesh.position.z=c;this.scene.add(this.mesh)}update(){this.mesh.material.map.needsUpdate=!0}}class PatchesMesh extends CanvasMesh{static options(){return{textureOptions:{minFilter:'NearestFilter',magFilter:'NearestFilter'},z:100}}init(a){super.init(a.pixels.ctx.canvas)}update(a){a.installPixels();super.update()}}class QuadSpritesMesh extends BaseMesh{static options(){return{z:2}}constructor(a,b){super(a,b);this.unitQuad=this.createQuad(.5,0)}init(){this.mesh&&this.dispose();let a=this.spriteSheetTexture,b=new Float32Array,c=new Float32Array,d=new Uint32Array,e=new THREE.BufferGeometry;e.addAttribute('position',new THREE.BufferAttribute(b,3));e.addAttribute('uv',new THREE.BufferAttribute(c,2));e.setIndex(new THREE.BufferAttribute(d,1));let f=new THREE.MeshBasicMaterial({map:a,alphaTest:.5,side:THREE.DoubleSide});this.mesh=new THREE.Mesh(e,f);this.mesh.position.z=this.options.z;this.scene.add(this.mesh)}update(a){let b=this.mesh,{vertices:c,indices:d}=this.unitQuad,e=this.model.world.patchSize,f=b.geometry.getAttribute('position'),g=b.geometry.getAttribute('uv'),h=b.geometry.getIndex(),i=new Float32Array(c.length*a.length),j=[],k=[];for(let b=0;b<a.length;b++){let f=a[b],g=f.size,h=f.theta,l=Math.cos(h),m=Math.sin(h),n=b*c.length;for(let a=0;a<c.length;a=a3){let b=c[a],d=c[a+1],h=f.x,j=f.y;i[a+n]=(g*(b*l-d*m)+h)*e;i[a+n+1]=(g*(b*m+d*l)+j)*e;i[a+n+2]=f.z*e}k.push(...d.map(a=>a+b*4));j.push(...f.sprite.uvs)}f.setArray(i);f.needsUpdate=!0;g.setArray(new Float32Array(j));g.needsUpdate=!0;h.setArray(new Uint32Array(k));h.needsUpdate=!0}}class PointsMesh extends BaseMesh{static options(){return{pointSize:1,color:null,z:2}}init(){this.mesh&&this.dispose();let{color:a,z:b}=this,c=this.options.pointSize*this.model.world.patchSize,d=new THREE.BufferGeometry;d.addAttribute('position',new THREE.BufferAttribute(new Float32Array,3));a==null&&d.addAttribute('color',new THREE.BufferAttribute(new Float32Array,3));let e=a?new THREE.PointsMaterial({size:c,color:new THREE.Color(a)}):new THREE.PointsMaterial({size:c,vertexColors:THREE.VertexColors});this.mesh=new THREE.Points(d,e);this.mesh.position.z=b;this.scene.add(this.mesh)}update(a){let b=this.mesh.geometry.getAttribute('position'),c=this.mesh.geometry.getAttribute('color'),d=[],e=c==null?null:[],f=this.model.world.patchSize,g=[1,0,0];for(let b=0;b<a.length;b++){let{x:c,y:h,z:i}=a[b];d.push(c*f,h*f,i*f);e!=null&&e.push(...g)}b.setArray(new Float32Array(d));b.needsUpdate=!0;e&&(c.setArray(new Float32Array(e)),c.needsUpdate=!0)}}class LinksMesh extends BaseMesh{static options(){return{z:1}}init(){this.mesh&&this.dispose();let a=new Float32Array(0),b=new Float32Array(0),c=new THREE.BufferGeometry;c.addAttribute('position',new THREE.BufferAttribute(a,3));c.addAttribute('color',new THREE.BufferAttribute(b,3));let d=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});this.mesh=new THREE.LineSegments(c,d);this.mesh.position.z=this.options.z;this.scene.add(this.mesh)}update(a){let b=[],c=[];for(let d=0;d<a.length;d++){let{end0:e,end1:f,color:g}=a[d],{x: h,y: i,z: j}=e,{x: k,y: l,z: m}=f,n=this.model.world.patchSize;b.push(h*n,i*n,j*n,k*n,l*n,m*n);c.push(...g.webgl,...g.webgl)}let d=this.mesh.geometry.getAttribute('position'),e=this.mesh.geometry.getAttribute('color');d.setArray(new Float32Array(b));d.needsUpdate=!0;e.setArray(new Float32Array(c));e.needsUpdate=!0}}var Meshes={BaseMesh,CanvasMesh,PatchesMesh,QuadSpritesMesh,PointsMesh,LinksMesh};window.Meshes=Meshes;class Three{static defaultOptions(a = !0,b = !0){let c={Renderer:Three,orthoView:!1,clearColor:0,useAxes:a,useGrid:a,useControls:a,useStats:b,useGUI:b,meshes:{patches:{meshClass:'PatchesMesh',z:1},turtles:{meshClass:'QuadSpritesMesh',z:2},links:{meshClass:'LinksMesh',z:1.5}}};return c}static printMeshOptions(){let a={};for(let b in Meshes){let c=Meshes[b].options;c&&(a[b]={options:Meshes[b].options()})}let b=JSON.stringify(a,null,'  ');console.log(b.replace(/ {2}"/g,'  ').replace(/": /g,': '))}constructor(a,b = {}){this.model=a;Object.assign(this,Three.defaultOptions);Object.assign(this,b);if(this.Renderer!==Three)throw Error('Three ctor: Renderer not Three',this.renderer);this.initThree();this.initThreeHelpers()}initThree(){let{clientWidth:a,clientHeight:b}=this.model.div,{orthoView:c,clearColor:d}=this,{width:e,height:f}=this.model.world,[g,h]=[e/2,f/2],i=new THREE.Scene,j=c?new THREE.OrthographicCamera(-g,g,h,-h,1,1e3):new THREE.PerspectiveCamera(45,a/b,1,1e4);c?j.position.set(0,0,100*e):j.position.set(e,-e,e);j.up.set(0,0,1);let k=new THREE.WebGLRenderer;k.setPixelRatio(window.devicePixelRatio);k.setSize(a,b);k.setClearColor(d);this.model.div.appendChild(k.domElement);window.addEventListener('resize',()=>{let{clientWidth:a,clientHeight:b}=this.model.div;j.aspect=a/b;j.updateProjectionMatrix();k.setSize(a,b)});Object.assign(this,{scene:i,camera:j,renderer:k})}initThreeHelpers(){let{scene:a,renderer:b,camera:c}=this,{useAxes:d,useGrid:e,useControls:f,useStats:g,useGUI:h}=this,{width:i}=this.model.world,j={};d&&(j.axes=new THREE.AxisHelper(1.5*i/2),a.add(j.axes));e&&(j.grid=new THREE.GridHelper(1.25*i,10),j.grid.rotation.x=THREE.Math.degToRad(90),a.add(j.grid));f&&(j.controls=new THREE.OrbitControls(c,b.domElement));g&&(j.stats=new Stats,document.body.appendChild(j.stats.dom));h&&(j.gui=new dat.GUI);Object.assign(this,j)}}class Model{static defaultOptions(a = 13,b = 16){return{patchSize:a,minX:-b,maxX:b,minY:-b,maxY:b}}constructor(a = document.body,b = {},c = Three.defaultOptions()){this.div=util.isString(a)?document.getElementById(a):a;this.spriteSheet=new SpriteSheet;this.world=Model.defaultOptions();Object.assign(this.world,b);this.setWorld();this.view=new c.Renderer(this,c);this.meshes={};util.forEach(c.meshes,(a,b)=>{let c=Meshes[a.meshClass].options();Object.assign(c,a);this.meshes[b]=new Meshes[a.meshClass](this.view,c)});this.anim=new Animator(this);this.modelReady=!1;this.startup().then(()=>{this.reset(),this.modelReady=!0})}whenReady(a){util.waitOn(()=>this.modelReady,()=>a(this))}setWorld(){let a=this.world;a.numX=a.maxX-a.minX+1;a.numY=a.maxY-a.minY+1;a.width=a.numX*a.patchSize;a.height=a.numY*a.patchSize;a.minXcor=a.minX-.5;a.maxXcor=a.maxX+.5;a.minYcor=a.minY-.5;a.maxYcor=a.maxY+.5;a.isOnWorld=(b,c)=>a.minXcor<=b&&b<=a.maxXcor&&a.minYcor<=c&&c<=a.maxYcor}reset(a = !1){this.anim.reset();this.setWorld();this.refreshLinks=this.refreshTurtles=this.refreshPatches=!0;this.patches=new Patches(this,Patch,'patches');this.meshes.patches.init(this.patches);this.turtles=new Turtles(this,Turtle,'turtles');this.meshes.turtles.init(this.turtles);this.links=new Links(this,Link,'links');this.meshes.links.init(this.links);this.setup();a&&this.start()}async startup(){}setup(){}step(){}start(){util.waitOn(()=>this.modelReady,()=>{this.anim.start()});return this}stop(){this.anim.stop()}once(){this.stop();this.anim.once()}draw(a = this.anim.stopped||this.anim.draws===1){this.div&&((a||this.refreshPatches)&&(this.patches.length>0&&this.meshes.patches.update(this.patches)),(a||this.refreshTurtles)&&(this.turtles.length>0&&this.meshes.turtles.update(this.turtles)),(a||this.refreshLinks)&&(this.links.length>0&&this.meshes.links.update(this.links)),this.view.renderer.render(this.view.scene,this.view.camera));this.view.stats&&this.view.stats.update()}patchBreeds(a){for(let b of a.split(' '))this[b]=new Patches(this,Patch,b,this.patches)}turtleBreeds(a){for(let b of a.split(' '))this[b]=new Turtles(this,Turtle,b,this.turtles)}linkBreeds(a){for(let b of a.split(' '))this[b]=new Links(this,Link,b,this.links)}}class RGBADataSet extends DataSet{constructor(a,b = Float32Array,c = {}){let d=util.imageToBytes(a),e=new b(d.buffer),f=4*e.length/d.length,g=f*a.width,h=a.height;super(g,h,e);Object.assign(this,c);this.src=a.src}}class RGBDataSet extends DataSet{constructor(a,b = {}){super(a.width,a.height,new Float32Array(a.width*a.height));Object.assign(this,b);let c=util.createCtx(a.width,a.height);util.fillCtxWithImage(c,a);let d=util.ctxImageData(c),e=this.data;for(var f=0;f<e.length;f++){let a=d.data[4*f],b=d.data[4*f+1],c=d.data[4*f+2];e[f]=this.rgb2Number(a,b,c)}this.src=a.src;this.ctx=c}rgb2Number(a,b,c){var d=1;a>63&&(d=-1,a=0);var e=d*(a*256*256+b*256+c);e/=10;return e}}export { AgentSet, Animator, AscDataSet, Color, ColorMap, DataSet, DataSetIO, Int24, Link, Links, Model, Patch, Patches, RGBADataSet, RGBDataSet, SpriteSheet, Three, Meshes as ThreeMeshes, Turtle, Turtles, util }
